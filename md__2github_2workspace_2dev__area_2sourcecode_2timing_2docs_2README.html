<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: timing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">timing</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md161"></a> </p>
<h1><a class="anchor" id="autotoc_md162"></a>
Overview</h1>
<p><code>timing</code> provides a low-level C++ interface to the <a href="https://gitlab.cern.ch/dune-daq/timing/timing-board-firmware"><code>HD</code> timing firmware</a>. The <code>HD</code> timing firmware is highly modular. Several "base" firmware blocks are re-used and combined in different patterns to obtain different functionality, e.g. <code>master</code> vs. <code>endpoint</code>. The same top level firmware design can also run on several different <code>IO</code>/<code>FPGA</code> board combinations. The C++ code structure is envisioned to loosely mirror the structure of the firmware. For each firmware block, there is usually a C++ class which provides the necessary interface to control and monitor the firmware block. Certain firmware blocks also contain data event buffers which can be read out via the corresponding C++ class.</p>
<p>In order to facilitate rapid code prototyping, and low level debugging of hardware, firmware, and software, <code>timing</code> provides a python interface to a large section of the C++ code. The python binding of C++ code is achieved using the header only library <code>pybind11</code>, see: <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/daq-cmake/#daq_add_python_bindings">daq_add_python_bindings</a>.</p>
<p>This package also provides the necessary schema and interface for the collection of operational monitoring information from the firmware and hardware supported by <code>timing</code>.</p>
<p>The different facets of the functionality provided <code>timing</code> are described in more detail in the following sections.</p>
<h1><a class="anchor" id="autotoc_md163"></a>
C++ firmware interface</h1>
<p>All the C++ firmware interface classes are compiled into a single "core" library, <code>libtiming.so</code>, which other libraries or plugins within the DUNE DAQ environment can link against. </p>
<h2><a class="anchor" id="autotoc_md164"></a>
IPBus</h2>
<p>Communication with firmware running on FPGA based hardware is achieved using <a href="https://ipbus.web.cern.ch/doc/user/html/index.html"><code>IPBus</code></a>, a packet-based control protocol for reading and modifying memory-mapped resources within FPGA-based hardware devices. The IPBus suite of software and firmware consists of the following components:</p>
<ul>
<li>firmware modules implementing the <code>IPbus</code> protocol within end-user firmware</li>
<li><code>uHAL</code>, providing an end-user C++/Python API for <code>IPbus</code> reads, writes and RMW (read-modify-write) transactions</li>
<li><code>ControlHub</code>, a software application that mediates simultaneous hardware access from multiple <code>uHAL</code> clients, and implements the <code>IPbus</code> reliability mechanism over UDP</li>
</ul>
<p>The <code>IPBus</code> protocol provides the low-level communication operations, e.g. reading and writing firmware registers. These low level operations can then be grouped together into higher level functions, e.g. board reset or clocking IC configuration. A set C++ classes implement these functions, whilst also retaining access to the lower level read and write operations.</p>
<p>The memory layout of the various firmware blocks which make up a firmware is captured using <a href="https://ipbus.web.cern.ch/doc/user/html/software/uhalQuickTutorial.html#creating-an-address-table"><code>IPBus</code> address maps</a>. These address maps allow the association of a particular firmware block with a particular C++ class. <code>timing</code> takes advantage of this feature to build its C++ firmware interface. The address maps of the various firmware designs supported by <code>timing</code> can be found in <code>config/etc/addrtab/</code>.</p>
<h2><a class="anchor" id="autotoc_md165"></a>
Class hierarchy</h2>
<p>The interface for reading and writing registers of hierarchal firmware blocks or <code>nodes</code> is provided by the <code>IPBus</code> class, <code>uhal::Node</code>. Most <code>timing</code> C++ classes inherit from <code>uhal::Node</code>, via the common base class <code>timing::TimingNode</code>. The class hierarchy of <code>timing</code> can be seen in the <code>UML</code> diagram below.</p>
<p><img src="./timing_class_diagram.png" alt="timing C++ classes" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md166"></a>
Python interface</h1>
<p>The C++ interface described above will be used by DUNE DAQ modules, written in C++, to control and monitor timing hardware. These DUNE DAQ modules can be found in the package, <a href="https://github.com/DUNE-DAQ/timinglibs/"><code>timinglibs</code></a>. The interface provided by <code>timing</code> can also be used in a debug and development contexts, where python bindings allow exactly the same C++ code to be used in production or debug environments. </p>
<h2><a class="anchor" id="autotoc_md167"></a>
Bindings</h2>
<p>The python binding is done using the library <code>pybind11</code>. The source files in the directory <code>pybindsrc</code>, expose the relevant C++ code via the sub-module <code>core</code>, which belongs to the package top level python module, <code>timing</code>. </p>
<h2><a class="anchor" id="autotoc_md168"></a>
CLI</h2>
<p>To enhance the usability of the python bound C++ code, a command line interface (<code>CLI</code>) has been built using the <code>click</code> python package. The <code>CLI</code> is centred around command groups, where each command group targets a particular set of firmware blocks or functionalities. These command groups are listed below.</p><ul>
<li><code>io</code> : commands for interacting with the firmware block responsible for controlling the <code>IO</code> board, e.g. <code>SFP</code>s, <code>CDR</code> and <code>PLL</code> <code>IC</code>s.</li>
<li><code>mst</code> : commands for manipulating the firmware blocks providing the <code>timing master</code> functionality</li>
<li><code>ept</code> : commands for manipulating the firmware blocks providing the <code>timing endpoint</code> functionality</li>
<li><code>hsi</code> : commands for manipulating the firmware blocks providing the <code>HSI</code> functionality</li>
<li><code>crt</code> : commands for manipulating the firmware blocks providing the <code>CRT endpoint</code> functionality</li>
<li><code>debug</code> : commands for various debug operations targeting hardware and firmware</li>
</ul>
<p>The <code>CLI</code> is invoked through the executable python script, <code>pdtbutler</code>, located in the <code>scripts</code> directory.</p>
<h1><a class="anchor" id="autotoc_md169"></a>
Operational monitoring</h1>
<p>A portion of the firmware interface classes implement a <code>get_info</code> method. The method takes as an arugment, a reference to a data structure, which it fills with its particular operational monitoring information. Several of these operational monitoring structures are combined together into one super-structure, which holds all the relevant information, e.g. hardware <em>and</em> firmware, about a particular timing device. The data structures are defined by schema, written in the language of <code>jsonnet</code>. These schema are turned into C++ <code>struct</code>s using the <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/daq-cmake/#daq_codegen"><code>daq_codegen</code> <code>cmake</code> function</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
