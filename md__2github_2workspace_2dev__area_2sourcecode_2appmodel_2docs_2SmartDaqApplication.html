<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: SmartDaqApplication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">SmartDaqApplication</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md511"></a> The SmartDaqApplication class allows for automatic creation of modules and connections for a known application. The general pattern is that a SDA ingests a set of module configuration objects and connection rules and uses them to create a well-defined application with modules, internal connections, and external connections.</p>
<h1><a class="anchor" id="autotoc_md512"></a>
Writing a new SmartDaqApplication</h1>
<p>SmartDaqApplications implement the <code>std::vector&lt;const confmodel::DaqModule*&gt; generate_modules(<a class="el" href="namespaceconffwk_1_1Configuration.html">conffwk::Configuration</a>*, const std::string&amp;, const comnfmodel::Session*)</code> method, which is responsible for generating a set of modules and connection objects. Each SmartDaqApplication has a UID from the configuration.</p>
<p>This section will use the "[DFOApplication](https://github.com/DUNE-DAQ/appmodel/blob/develop/src/DFOApplication.cpp)" SmartDaqApplication as an example.</p>
<h2><a class="anchor" id="autotoc_md513"></a>
Boilerplate</h2>
<p>The following code must be in your source file to allow the system to instantiate your SmartDaqApplication correctly. The first parameter should be changed to match your SmartDaqApplication class name. </p><div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">static</span> ModuleFactory::Registrator <a class="code hl_variable" href="sourcecode_2appmodel_2src_2DFApplication_8cpp.html#aa06f08f3da34b58e163bdcc65755d676">__reg__</a>(<span class="stringliteral">&quot;DFOApplication&quot;</span>,</div>
<div class="line">                                          [](<span class="keyword">const</span> SmartDaqApplication* smartApp,</div>
<div class="line">                                             <a class="code hl_namespace" href="namespaceconffwk_1_1Configuration.html">conffwk::Configuration</a>* confdb,</div>
<div class="line">                                             <span class="keyword">const</span> std::string&amp; dbfile,</div>
<div class="line">                                             <span class="keyword">const</span> confmodel::Session* <a class="code hl_namespace" href="namespacesession.html">session</a>) -&gt; ModuleFactory::ReturnType {</div>
<div class="line">                                            <span class="keyword">auto</span> app = smartApp-&gt;cast&lt;DFOApplication&gt;();</div>
<div class="line">                                            <span class="keywordflow">return</span> app-&gt;generate_modules(confdb, dbfile, <a class="code hl_namespace" href="namespacesession.html">session</a>);</div>
<div class="line">                                          });</div>
<div class="ttc" id="anamespaceconffwk_1_1Configuration_html"><div class="ttname"><a href="namespaceconffwk_1_1Configuration.html">conffwk.Configuration</a></div><div class="ttdef"><b>Definition</b> <a href="Configuration_8py_source.html#l00001">Configuration.py:1</a></div></div>
<div class="ttc" id="anamespacesession_html"><div class="ttname"><a href="namespacesession.html">session</a></div><div class="ttdef"><b>Definition</b> <a href="session_8py_source.html#l00001">session.py:1</a></div></div>
<div class="ttc" id="asourcecode_2appmodel_2src_2DFApplication_8cpp_html_aa06f08f3da34b58e163bdcc65755d676"><div class="ttname"><a href="sourcecode_2appmodel_2src_2DFApplication_8cpp.html#aa06f08f3da34b58e163bdcc65755d676">__reg__</a></div><div class="ttdeci">static ModuleFactory::Registrator __reg__(&quot;DFApplication&quot;, [](const SmartDaqApplication *smartApp, conffwk::Configuration *confdb, const std::string &amp;dbfile, const confmodel::Session *session) -&gt; ModuleFactory::ReturnType { auto app=smartApp-&gt;cast&lt; DFApplication &gt;();return app-&gt;generate_modules(confdb, dbfile, session);})</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md514"></a>
Creating a module</h2>
<div class="fragment"><div class="line">++</div>
<div class="line"> std::string dfoUid(<span class="stringliteral">&quot;DFO-&quot;</span> + UID());</div>
<div class="line"> <a class="code hl_namespace" href="namespaceconffwk_1_1ConfigObject.html">conffwk::ConfigObject</a> dfoObj;</div>
<div class="line"> <a class="code hl_define" href="logging_2include_2logging_2Logging_8hpp.html#a8c6732348bcdf3758aac3d18eb3995b9">TLOG_DEBUG</a>(7) &lt;&lt; <span class="stringliteral">&quot;creating OKS configuration object for DFOModule class &quot;</span>;</div>
<div class="line"> confdb-&gt;create(dbfile, <span class="stringliteral">&quot;DFOModule&quot;</span>, dfoUid, dfoObj);</div>
<div class="line"> </div>
<div class="line"> <span class="keyword">auto</span> dfoConf = get_dfo();</div>
<div class="line"> dfoObj.<a class="code hl_function" href="classconffwk_1_1ConfigObject_1_1ConfigObject.html#a04a9b8cd6030214f5e847f310efc977f">set_obj</a>(<span class="stringliteral">&quot;configuration&quot;</span>, &amp;dfoConf-&gt;config_object());</div>
<div class="ttc" id="aclassconffwk_1_1ConfigObject_1_1ConfigObject_html_a04a9b8cd6030214f5e847f310efc977f"><div class="ttname"><a href="classconffwk_1_1ConfigObject_1_1ConfigObject.html#a04a9b8cd6030214f5e847f310efc977f">conffwk.ConfigObject.ConfigObject.set_obj</a></div><div class="ttdeci">set_obj(self, name, value)</div><div class="ttdef"><b>Definition</b> <a href="ConfigObject_8py_source.html#l00274">ConfigObject.py:274</a></div></div>
<div class="ttc" id="alogging_2include_2logging_2Logging_8hpp_html_a8c6732348bcdf3758aac3d18eb3995b9"><div class="ttname"><a href="logging_2include_2logging_2Logging_8hpp.html#a8c6732348bcdf3758aac3d18eb3995b9">TLOG_DEBUG</a></div><div class="ttdeci">#define TLOG_DEBUG(lvl,...)</div><div class="ttdef"><b>Definition</b> <a href="logging_2include_2logging_2Logging_8hpp_source.html#l00112">Logging.hpp:112</a></div></div>
<div class="ttc" id="anamespaceconffwk_1_1ConfigObject_html"><div class="ttname"><a href="namespaceconffwk_1_1ConfigObject.html">conffwk.ConfigObject</a></div><div class="ttdef"><b>Definition</b> <a href="ConfigObject_8py_source.html#l00001">ConfigObject.py:1</a></div></div>
</div><!-- fragment --><p>Here, it is important to understand the DFOApplication schema definition: </p><div class="fragment"><div class="line">&lt;<span class="keywordtype">class</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;DFOApplication&quot;</span>&gt;</div>
<div class="line"> &lt;<span class="keywordtype">superclass</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;SmartDaqApplication&quot;</span>/&gt;</div>
<div class="line"> &lt;<span class="keywordtype">relationship</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;dfo&quot;</span> <span class="keyword">class-type</span>=<span class="stringliteral">&quot;DFOConf&quot;</span> <span class="keyword">low-cc</span>=<span class="stringliteral">&quot;one&quot;</span> <span class="keyword">high-cc</span>=<span class="stringliteral">&quot;one&quot;</span> <span class="keyword">is-composite</span>=<span class="stringliteral">&quot;no&quot;</span> <span class="keyword">is-exclusive</span>=<span class="stringliteral">&quot;no&quot;</span> <span class="keyword">is-dependent</span>=<span class="stringliteral">&quot;no&quot;</span>/&gt;</div>
<div class="line"> &lt;<span class="keywordtype">method</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;generate_modules&quot;</span> <span class="keyword">description</span>=<span class="stringliteral">&quot;Generate DaqModule dal objects for streams of the application on the fly&quot;</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">method-implementation</span> <span class="keyword">language</span>=<span class="stringliteral">&quot;c++&quot;</span> <span class="keyword">prototype</span>=&quot;<span class="keyword">std::vector</span>&amp;<span class="keyword">lt</span>;<span class="keyword">const</span> <span class="keyword">dunedaq::confmodel::DaqModule</span>*&amp;<span class="keyword">gt</span>; <span class="keyword">generate_modules</span>(<span class="keyword">conffwk::Configuration</span>*, <span class="keyword">const</span> <span class="keyword">std::string</span>&amp;<span class="keyword">amp</span>;, <span class="keyword">const</span> <span class="keyword">confmodel::Session</span>*) <span class="keyword">const</span> <span class="keyword">override</span><span class="stringliteral">&quot; body=&quot;</span>&quot;/&gt;</div>
<div class="line"> &lt;/<span class="keywordtype">method</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">class</span>&gt;</div>
</div><!-- fragment --><p> In addition to the fields from SmartDaqApplication, the DFOApplication class has a relationship named "dfo" to a <code>DFOConf</code> object. As an OKS object, it also has a "UID"" field. The code uses this UID (accessed via the `UID()` method) to create the UID for a `DFOModule` object. The object is created in the in-memory database, and its configuration assigned using the "dfo" relationship from the DFOApplication schema.

@subsection autotoc_md515 Reading connection rules and creating connections

@icode{C} ++

  for (auto rule : get_network_rules()) {
    auto endpoint_class = rule-&gt;get_endpoint_class();
    auto descriptor = rule-&gt;get_descriptor();

    conffwk::ConfigObject connObj;
    auto serviceObj = descriptor-&gt;get_associated_service()-&gt;config_object();
    std::string connUid(descriptor-&gt;get_uid_base());
    confdb-&gt;create(dbfile, "NetworkConnection", connUid, connObj);
    connObj.set_by_val&lt;std::string&gt;("data_type", descriptor-&gt;get_data_type());
    connObj.set_by_val&lt;std::string&gt;("connection_type", descriptor-&gt;get_connection_type());
    connObj.set_obj("associated_service", &amp;serviceObj);

    //if (endpoint_class == "DFOModule") {
    if (descriptor-&gt;get_data_type() == "TriggerDecision") {
        tdInObj = connObj;
        input_conns.push_back(&amp;tdInObj);
      } 
    else if (descriptor-&gt;get_data_type() == "TriggerDecisionToken") {
        tokenInObj = connObj;
        input_conns.push_back(&amp;tokenInObj);
      }
    
    else if (descriptor-&gt;get_data_type() == "TriggerInhibit") {
    busyOutObj = connObj;
        output_conns.push_back(&amp;busyOutObj);
    }
  }

@endicode 

The next stage of DFOApplication is to retrieve the network connection rules to assign the inputs and outputs of the &lt;tt&gt;DFOModule&lt;/tt&gt; instance. A DFO has two fixed inputs (decisions and tokens), and one fixed output (inhibits). Decisions sent to TRB instances are dynamically instantiated at run-time using information in the token messages.

@subsection autotoc_md516 Setting Module Connection relationships

@icode{C} ++
  dfoObj.set_objs("inputs", input_conns);
  dfoObj.set_objs("outputs", output_conns);</p>
<p>// Add to our list of modules to return modules.push_back(confdb-&gt;get&lt;DFOModule&gt;(dfoUid));</p>
<p>return modules; </p>
<p>Once the fixed connections are retrieved using the network rules, the module's input and output relations are set, and the module is added to the output vector, which is returned.</p>
<h2><a class="anchor" id="autotoc_md517"></a>
Summary</h2>
<p>These basic steps are repeated in all SmartDaqApplication instances, with differences depending on the specific applciation being implemented. The DFOApplication is one of the simplest applications in the system, but it demonstrates the basic logic followed by all SmartDaqApplications. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
