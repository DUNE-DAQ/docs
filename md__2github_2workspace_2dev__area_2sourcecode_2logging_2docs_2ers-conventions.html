<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: Conventions for ERS issues</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Conventions for ERS issues</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md229"></a> This document describes conventions and best practices for using ERS issues in the DUNE DAQ software. You can find more information about how ERS works in the <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/ers/">ERS documentation</a>.</p>
<h1><a class="anchor" id="autotoc_md230"></a>
Issue naming</h1>
<p>Each ERS issue is an instance of a class, with different information carried by different classes. The classname should not be vague, but specific and meaningful. An example of a too-vague issue name is <code>ConfigurationError</code>. A more useful name might be <code>CannotOpenFile</code>, especially if the attributes give more details.</p>
<p>The issue name should indicate the action that caused the issue, eg <code>CannotAllocateBuffer</code>, <code>CannotOpenFile</code>, <code>CannotOpenSocket</code>, <code>StartOfRun</code>, <code>EndOfRun</code>, <code>TimestampMismatch</code>, <code>CorruptFragment</code>. Avoid putting "error" or "warning" in the issue name; the severity of the issue depends on the context, and this is indicated by the stream it is reported on.</p>
<p>In some cases you may want to have a higher level issue for grouping a set of failure causes. To do this, chain the underlying reason into the issue. For example, <code>CannotCompleteCommand</code> was caused by <code>CannotOpenFile</code> was caused by <code>FileDoesNotExist</code>.</p>
<p>Issue chaining with a throw:</p>
<div class="fragment"><div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">     open(“pippo.txt”);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code hl_class" href="classers_1_1Issue.html">ers::Issue</a> &amp; open_issue) { </div>
<div class="line">     <span class="keywordflow">throw</span> CannotCompleteCommand(<a class="code hl_define" href="LocalContext_8hpp.html#adea523c3dfceb9683f7acb5e719283ee">ERS_HERE</a>,“conf”, open_issue);</div>
<div class="line">     <span class="comment">//                                           ^^^^^^^^^^</span></div>
<div class="line">     <span class="comment">//        This argument causes the issues to be chained</span></div>
<div class="line">     <span class="comment">//        &quot;CannotCompleteCommand was caused by [description of open_issue]&quot;</span></div>
<div class="line">}</div>
<div class="ttc" id="aLocalContext_8hpp_html_adea523c3dfceb9683f7acb5e719283ee"><div class="ttname"><a href="LocalContext_8hpp.html#adea523c3dfceb9683f7acb5e719283ee">ERS_HERE</a></div><div class="ttdeci">#define ERS_HERE</div><div class="ttdef"><b>Definition</b> <a href="LocalContext_8hpp_source.html#l00130">LocalContext.hpp:130</a></div></div>
<div class="ttc" id="aclassers_1_1Issue_html"><div class="ttname"><a href="classers_1_1Issue.html">ers::Issue</a></div><div class="ttdoc">Base class for any user define issue.</div><div class="ttdef"><b>Definition</b> <a href="Issue_8hpp_source.html#l00068">Issue.hpp:69</a></div></div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">    frag-&gt;decode();</div>
<div class="line">    do_something(frag);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code hl_class" href="classers_1_1Issue.html">ers::Issue</a> &amp;decode_issue) {</div>
<div class="line">    <a class="code hl_function" href="namespaceers.html#a1f13d0d03ff2e1c3f3b2a9c388a20648">ers::warning</a>(CorruptFragment(<a class="code hl_define" href="LocalContext_8hpp.html#adea523c3dfceb9683f7acb5e719283ee">ERS_HERE</a>, decode_issue));</div>
<div class="line">    <span class="comment">//                                     ^^^^^^^^^^^^</span></div>
<div class="line">    <span class="comment">// &quot;CorruptFragment was caused by [description of decode_issue]&quot;</span></div>
<div class="line">}</div>
<div class="ttc" id="anamespaceers_html_a1f13d0d03ff2e1c3f3b2a9c388a20648"><div class="ttname"><a href="namespaceers.html#a1f13d0d03ff2e1c3f3b2a9c388a20648">ers::warning</a></div><div class="ttdeci">void warning(const Issue &amp;issue)</div><div class="ttdef"><b>Definition</b> <a href="ers_8hpp_source.html#l00115">ers.hpp:115</a></div></div>
</div><!-- fragment --><p>Chaining issues is a powerful mechanism to enrich the information for whatever or whoever will need to handle it. Each software layer can add information to provide additional context to the problem.</p>
<h1><a class="anchor" id="autotoc_md231"></a>
Throwing vs reporting</h1>
<p>ERS Issues can be thrown with the regular C++ <code>throw</code> statement, or reported using ERS-specific mechanisms.</p>
<p>When to throw: in library code, throw when the requested action cannot be completed. It's then the caller's responsibility to deal with the exception. It's also OK to throw in command-handling methods of <code>DAQModule</code> (eg, in <code>do_configure</code> if configuration is impossible).</p>
<p>When to report: Don't throw if the issue cannot be caught: e.g. if you spawn a thread and throw in its run loop, your process will crash making any type of reaction (as well as diagnosing) impossible. Don't assume that your thread has the "right" to destroy the whole application. In this case report the issue using <code><a class="el" href="namespaceers.html#a1f13d0d03ff2e1c3f3b2a9c388a20648">ers::warning</a></code>, <code><a class="el" href="namespaceers.html#aff4eee77205a91301c3c942ae1de25c6">ers::error</a></code>, or <code><a class="el" href="namespaceers.html#ae546de6c000e3e8eecda0c9fa9d78857">ers::fatal</a></code> depending on the severity of the problem.</p>
<h1><a class="anchor" id="autotoc_md232"></a>
Issue inheritance</h1>
<p>It is possible to define a base class for a set of issues (all issues derive from <code><a class="el" href="classers_1_1Issue.html" title="Base class for any user define issue.">ers::Issue</a></code>). Inheritance is particularly relevant for the catching/handling part. For example, we can have a general <code>CorruptFragment</code> issue with a more specialized <code>WrongTimestamp</code> derived issue:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="logging_2include_2logging_2internal_2macro_8hpp.html#a1430d021d3f90d61dab3ca0b75d4df25">ERS_DECLARE_ISSUE</a>(</div>
<div class="line">  <a class="code hl_namespace" href="namespacedunedaq.html">dunedaq</a>,                                                       <span class="comment">// namespace</span></div>
<div class="line">  CorruptFragment,                                               <span class="comment">// issue name</span></div>
<div class="line">  <span class="stringliteral">&quot;Received corrupt fragment for trigger request ID &lt;&lt; trig_num, // message</span></div>
<div class="line"><span class="stringliteral">  ((const uint64_t trig_num))                                    // attribute</span></div>
<div class="line"><span class="stringliteral">)</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">// Derived issue</span></div>
<div class="line"><span class="stringliteral">ERS_DECLARE_ISSUE_BASE(</span></div>
<div class="line"><span class="stringliteral">  dunedaq,                                               // namespace</span></div>
<div class="line"><span class="stringliteral">  WrongTimestamp,                                        // issue name</span></div>
<div class="line"><span class="stringliteral">  dunedaq::CorruptFragment,                              // base issue name</span></div>
<div class="line"><span class="stringliteral">  &quot;</span>Timestamp of fragment <span class="keywordflow">for</span> trigger request ID <span class="stringliteral">&quot;        // message</span></div>
<div class="line"><span class="stringliteral">  &lt;&lt; trig_num &lt;&lt; &quot;</span> is <span class="stringliteral">&quot; &lt;&lt; wrong_ts &lt;&lt; &quot;</span> instead of <span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">  &lt;&lt; right_ts,</span></div>
<div class="line"><span class="stringliteral">  ((const uint64_t trig_num)),                           // base class attributes</span></div>
<div class="line"><span class="stringliteral">  ((const uint64_t wrong_ts) (const uint64_t right_ts)), // derived class attributes</span></div>
<div class="line"><span class="stringliteral">)</span></div>
<div class="ttc" id="alogging_2include_2logging_2internal_2macro_8hpp_html_a1430d021d3f90d61dab3ca0b75d4df25"><div class="ttname"><a href="logging_2include_2logging_2internal_2macro_8hpp.html#a1430d021d3f90d61dab3ca0b75d4df25">ERS_DECLARE_ISSUE</a></div><div class="ttdeci">#define ERS_DECLARE_ISSUE( namespace_name, class_name, message_, attributes)</div><div class="ttdef"><b>Definition</b> <a href="logging_2include_2logging_2internal_2macro_8hpp_source.html#l00065">macro.hpp:65</a></div></div>
<div class="ttc" id="anamespacedunedaq_html"><div class="ttname"><a href="namespacedunedaq.html">dunedaq</a></div><div class="ttdoc">Including Qt Headers.</div><div class="ttdef"><b>Definition</b> <a href="DataStore_8hpp_source.html#l00057">DataStore.hpp:57</a></div></div>
</div><!-- fragment --><p>These could be used in a <code>try..catch</code> block like so:</p>
<div class="fragment"><div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">  frag-&gt;decode();</div>
<div class="line">  do_something(frag);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (WrongTimestamp &amp;ex) {</div>
<div class="line">  do_something_special();</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (CorruptFragment &amp;ex) {</div>
<div class="line">  <span class="comment">// This block catches CorruptFragment and any derived issues apart from WrongTimestamp</span></div>
<div class="line">  do_something_else();</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code hl_class" href="classers_1_1Issue.html">ers::Issue</a> &amp;ex) {</div>
<div class="line">  <span class="comment">// This block catches any ERS issues that don&#39;t derive from CorruptFragment</span></div>
<div class="line">  <a class="code hl_function" href="namespaceers.html#a1f13d0d03ff2e1c3f3b2a9c388a20648">ers::warning</a>(FragmentDropped(<a class="code hl_define" href="LocalContext_8hpp.html#adea523c3dfceb9683f7acb5e719283ee">ERS_HERE</a>, ex));</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md233"></a>
Severities</h1>
<p>Severities are chosen based on the impact to the application:</p>
<h2><a class="anchor" id="autotoc_md234"></a>
Information</h2>
<p>Report something that needs to be known but is not indicative of any problem (e.g. <code>ChangedTriggerPrescales</code>).</p>
<h2><a class="anchor" id="autotoc_md235"></a>
Warning</h2>
<p>Report a specific anomaly that is not affecting the functioning of the application, but needs attention (e.g. <code>EmptyFragmentReceived</code>, <code>DuplicateFragmentReceived</code>)</p>
<h2><a class="anchor" id="autotoc_md236"></a>
Error</h2>
<p>Report an anomaly that is persistent and will likely not be solved without external intervention (e.g. <code>NoDataFromLink</code>, <code>DiskAlmostFull</code>)</p>
<h2><a class="anchor" id="autotoc_md237"></a>
Fatal</h2>
<p>Report a major problem that does not allow the application to continue working (e.g. <code>DiskFull</code>, <code>NoMemoryLeft</code>). Note that issuing an <code><a class="el" href="namespaceers.html#ae546de6c000e3e8eecda0c9fa9d78857">ers::fatal</a></code> does not necessarily terminate the application. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
