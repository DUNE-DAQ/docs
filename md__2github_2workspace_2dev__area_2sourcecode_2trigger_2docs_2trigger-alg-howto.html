<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: How to write a trigger algorithm</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">How to write a trigger algorithm</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md312"></a> The DUNE DAQ data selection software separates physics algorithms (which make trigger activity and trigger candidate objects) from concerns about how the data objects are packaged and transported through the data selection system.</p>
<p>Physics algorithms are implemented in the <a href="https://github.com/DUNE-DAQ/triggeralgs"><code>triggeralgs</code></a> package. To create a new physics algorithm, create a class that derives from <a href="https://github.com/DUNE-DAQ/triggeralgs/blob/develop/include/triggeralgs/TriggerActivityMaker.hpp"><code>triggeralgs::TriggerActivityMaker</code></a> or <a href="https://github.com/DUNE-DAQ/triggeralgs/blob/develop/include/triggeralgs/TriggerCandidateMaker.hpp"><code>triggeralgs::TriggerCandidateMaker</code></a> as appropriate. I'll use <code>TriggerActivityMaker</code> for definiteness from here on: if you're writing a <code>TriggerCandidateMaker</code>, make the appropriate substitutions.</p>
<p>In your derived class, you must implement one pure virtual function, namely:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> operator()(<span class="keyword">const</span> TriggerPrimitive&amp; input_tp, std::vector&lt;TriggerActivity&gt;&amp; output_ta);</div>
</div><!-- fragment --><p>This function will be called by the data selection framework once for each input <code>TriggerPrimitive</code>. Your implementation should do whatever processing it wants, and if the addition of the latest <code>TriggerPrimitive</code> causes a new output <code>TriggerActivity</code> to be complete, add the <code>TriggerActivity</code> to the output vector <code>output_ta</code>.</p>
<p>The data selection framework will make calls to <code>operator()</code> with the <code>TriggerPrimitive</code>s strictly ordered by start time. That is, once <code>operator()</code> has been called with a <code>TriggerPrimitive</code> whose start time is <code>T</code>, it will not later be called with a <code>TriggerPrimitive</code> whose start time is less than <code>T</code>. (If two <code>TriggerPrimitives</code> have exactly the same time, the relative order of the calls to <code>operator()</code> is unspecified.)</p>
<p>You will of course need to store the state of your algorithm between calls to <code>operator()</code>: use member variables in your class for this.</p>
<p>It's recommended (but not strictly required) to also implement the <code>flush()</code> function from <code>TriggerActivityMaker</code>, whose signature is:</p>
<div class="fragment"><div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> flush(timestamp_t until, std::vector&lt;TriggerActivity&gt;&amp; output_ta)</div>
</div><!-- fragment --><p>The reason this function exists is to handle the case where there is a large gap between trigger primitives (or, more likely, between trigger activities). During this gap, <code>operator()</code> is not called, and so your algorithm cannot send its output, even if such a long time has passed that you know that any trigger activities currently in progress can be completed and sent out. In this case, the data selection framework calls your implementation of <code>flush(until, output_ta)</code> to inform you that no more trigger primitives have occurred between the last one for which <code>operator()</code> was called and timestamp <code>until</code>. If this causes your algorithm to complete any trigger activities, you can add them to the <code>output_ta</code> vector.</p>
<p>Finally, you must register the <code>TriggerActivityMaker</code> in the Trigger Activity Factory. This allows it to be accessed in this repository and used when running on <code>nanorc</code>. In the case of <code>TAMakerPrescaleAlgorithm</code>, the macro call is:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="TriggerActivityFactory_8hpp.html#a267b011d1987b877ac9dbb098e68b669">REGISTER_TRIGGER_ACTIVITY_MAKER</a>(<a class="code hl_define" href="TriggerInhibitAgent_8cpp.html#a659a9043ed41d29a2c657447cc584330">TRACE_NAME</a>, TAMakerPrescaleAlgorithm)</div>
<div class="ttc" id="aTriggerActivityFactory_8hpp_html_a267b011d1987b877ac9dbb098e68b669"><div class="ttname"><a href="TriggerActivityFactory_8hpp.html#a267b011d1987b877ac9dbb098e68b669">REGISTER_TRIGGER_ACTIVITY_MAKER</a></div><div class="ttdeci">#define REGISTER_TRIGGER_ACTIVITY_MAKER(tam_name, tam_class)</div><div class="ttdef"><b>Definition</b> <a href="TriggerActivityFactory_8hpp_source.html#l00014">TriggerActivityFactory.hpp:14</a></div></div>
<div class="ttc" id="aTriggerInhibitAgent_8cpp_html_a659a9043ed41d29a2c657447cc584330"><div class="ttname"><a href="TriggerInhibitAgent_8cpp.html#a659a9043ed41d29a2c657447cc584330">TRACE_NAME</a></div><div class="ttdeci">#define TRACE_NAME</div><div class="ttdoc">Name used by TRACE TLOG calls from this source file.</div><div class="ttdef"><b>Definition</b> <a href="TriggerInhibitAgent_8cpp_source.html#l00021">TriggerInhibitAgent.cpp:21</a></div></div>
</div><!-- fragment --><p>where <code>TRACE_NAME</code> is the string <code>"TAMakerPrescaleAlgorithm"</code>.</p>
<h1><a class="anchor" id="autotoc_md313"></a>
Configuration</h1>
<p>Your algorithm may take configuration parameters at run time (eg, a minimum number of hits or ADC to form a trigger activity, or a verbosity level). Your algorithm receives these configuration parameters via the <code>configure()</code> function, whose signature is:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> configure(<span class="keyword">const</span> nlohmann::json &amp;config);</div>
</div><!-- fragment --><p>The <code>config</code> argument is in <code>nlohmann::json</code> format, documentation for which can be found at <a href="https://json.nlohmann.me/">https://json.nlohmann.me/</a> . Here is a simple example implementation, from the <code>TAMakerPrescaleAlgorithm</code> algorithm:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span></div>
<div class="line">TAMakerPrescaleAlgorithm::configure(<span class="keyword">const</span> nlohmann::json &amp;config)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (config.is_object() &amp;&amp; config.contains(<span class="stringliteral">&quot;prescale&quot;</span>))</div>
<div class="line">  {</div>
<div class="line">    m_prescale = config[<span class="stringliteral">&quot;prescale&quot;</span>]; </div>
<div class="line">  }</div>
<div class="line">  <a class="code hl_define" href="logging_2include_2logging_2Logging_8hpp.html#a8c6732348bcdf3758aac3d18eb3995b9">TLOG_DEBUG</a>(<a class="code hl_define" href="TriggerInhibitAgent_8cpp.html#a659a9043ed41d29a2c657447cc584330">TRACE_NAME</a>) &lt;&lt; <span class="stringliteral">&quot;Using activity prescale &quot;</span> &lt;&lt; m_prescale;</div>
<div class="line">}</div>
<div class="ttc" id="alogging_2include_2logging_2Logging_8hpp_html_a8c6732348bcdf3758aac3d18eb3995b9"><div class="ttname"><a href="logging_2include_2logging_2Logging_8hpp.html#a8c6732348bcdf3758aac3d18eb3995b9">TLOG_DEBUG</a></div><div class="ttdeci">#define TLOG_DEBUG(lvl,...)</div><div class="ttdef"><b>Definition</b> <a href="logging_2include_2logging_2Logging_8hpp_source.html#l00112">Logging.hpp:112</a></div></div>
</div><!-- fragment --><p>For instructions about actually constructing a configuration to pass to your algorithm, see the "Using your algorithm in the dunedaq framework" section below.</p>
<h1><a class="anchor" id="autotoc_md314"></a>
Aggregation</h1>
<p>Inputs from a number of sources may be aggregated to send to a physics algorithm. The standard aggregation is that a <code>TriggerActivityMaker</code> receives trigger primitives aggregated over one APA, including both collection and induction channels, and a <code>TriggerCandidateMaker</code> receives trigger activities aggregated over the whole detector. We can consider alterations and additions to this scheme in future.</p>
<h1><a class="anchor" id="autotoc_md315"></a>
Using your algorithm in the dunedaq framework</h1>
<p>Once your code is registered to the appropriate factory (TA/TC), you can run a DAQ job that reads data from a file and passes it to your algorithm. Instructions on how to do that (including choosing configuration parameters for your algorithm) can be found here:</p>
<p><a href="https://github.com/DUNE-DAQ/trigger/blob/develop/python/trigger/faketp_chain/README.md">https://github.com/DUNE-DAQ/trigger/blob/develop/python/trigger/faketp_chain/README.md</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
