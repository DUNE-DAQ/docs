<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: wibmod</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">wibmod</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md341"></a> <a class="el" href="classWIB.html">WIB</a> configuration and monitoring interface for DUNE's appfwk.</p>
<h1><a class="anchor" id="autotoc_md342"></a>
Testing</h1>
<p>A python utility is included to generate metadata to test control of multiple WIBs with <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/nanorc">nanorc</a>. This metadata is a set of JSON files that describe the DAQ applications (consisting of interconnected <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/appfwk">appfwk</a> modules) and commands these applications (modules) can receive.</p>
<h2><a class="anchor" id="autotoc_md343"></a>
Generate a WIB application</h2>
<p>To build metadata for a single <a class="el" href="classWIB.html">WIB(3)</a> named <code>BLAND</code> with IP <code>192.168.1.4</code>: </p><div class="fragment"><div class="line">wibconf_gen -w wib001 tcp://192.168.1.4:1234 wibapp</div>
</div><!-- fragment --><p> This will store the metadata in the folder <code>wibapp</code>. To include more WIBs, include additional <code>-w [NAME] [ENDPOINT]</code> arguments. Where the <code>[NAME]</code> should uniquely identify a <a class="el" href="classWIB.html">WIB</a> and the <code>[ENDPOINT]</code> is the ZMQ socket the <a class="el" href="classWIB.html">WIB</a>'s <a href="https://github.com/DUNE-DAQ/dune-wib-firmware/tree/master/sw"><code>wib_server</code></a> is listening on.</p>
<p>WIB1 are also supported with the <code>-p [NAME] [IP]</code> argument. For all options: </p><div class="fragment"><div class="line">wibconf_gen -h</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md344"></a>
Running with nanorc</h2>
<p>The <code>wibapp</code> metadata can be launched using nanorc: </p><div class="fragment"><div class="line">nanorc wibapp wibapp</div>
</div><!-- fragment --><p> The interactive run control can be used to send the <code>boot</code> command, to launch the <a class="el" href="classWIB.html">WIB</a> application and initialize the <a class="el" href="classWIB.html">WIB</a> modules.</p>
<p>Assuming the <a class="el" href="classWIB.html">WIB(s)</a> are powered and ready to receive configurations, send <code>conf</code> to connect to the WIBs and load the initial settings. Sending additional settings to the WIBs requires sending a <code>settings</code> command, which <code>nanorc</code> does not currently support. A real <a class="el" href="classWIB.html">WIB</a> will now be streaming data out over its fibers from all FEMBs.</p>
<p>To change settings sent to the WIBs, one can edit <code>wibapp/data/wib001_conf.json</code> by hand. In the future, some run control database will presumably build this configuration information based on the desired detector state.</p>
<h1><a class="anchor" id="autotoc_md345"></a>
TODOs</h1>
<p>The <code>WIBModule</code> module includes all the functionality of the <code>WIB2Reader</code> developed for <code>artDAQ</code> except the ability to perform data readout using the <a class="el" href="classWIB.html">WIB</a> spy buffer. This functionality is a simplest-working-solution to <a class="el" href="classWIB.html">WIB</a> control. <code>ProtoWIBConfigurator</code> is an similarly an exact duplicate of the artDAQ functionality, and the <code><a class="el" href="classWIB.html">WIB</a></code> library developed by BU is included in this repo.</p>
<p>What follows is an (incomplete) list of potential improvements for a more complete DAQ system.</p>
<h2><a class="anchor" id="autotoc_md346"></a>
Power control</h2>
<p>Slow controls will control FEMB power via an <a href="https://documentation.unified-automation.com/uasdkcpp/1.7.4/html/index.html">OPC UA</a> server that has yet to be implemented.</p>
<p>For ICEBERG and artDAQ, power control was a set of <a href="https://github.com/DUNE-DAQ/dune-wib-firmware/tree/master/sw">external utilities</a> which communicate directly with the <code>wib_server</code>. It is probably best to use these utilities for now, and for debugging.</p>
<h2><a class="anchor" id="autotoc_md347"></a>
Run configuration</h2>
<p>Presumably the DAQ will want to change WIB/FEMB settings. <code>WIBModule</code> implements the <code>settings</code> command, which exposes <a href="schema/wibmod/wibconfigurator.jsonnet">all settings</a>. Something in the DAQ needs to invoke this command with the desired arguments when <a class="el" href="classWIB.html">WIB</a> settings need to be programmed.</p>
<h2><a class="anchor" id="autotoc_md348"></a>
Calibration</h2>
<p><code>WIBModule</code> may need a <code>calibrate</code> command to meet the calibration needs of the DAQ, whatever they end up being. In principle, DAQ can already turn the pulser on and off by sending <code>settings</code> commands with appropriate settings.</p>
<h2><a class="anchor" id="autotoc_md349"></a>
Monitoring</h2>
<p><code>WIBModule</code> should perhaps implement a <code>get_info</code> method to provide status updates, if this is the route slow controls ends up going.</p>
<h3><a class="anchor" id="autotoc_md350"></a>
Sanity checking</h3>
<p><code>wib_server</code> has several version check commands (hardware and software) as well as timing endpoint lock status, etc., which could be checked by <code>WIBModule</code> but is currently ignored. <code>ProtoWIBConfigurator</code> includes <a class="el" href="classWIB.html">WIB</a> and FEMB firmware checks.</p>
<h2><a class="anchor" id="autotoc_md351"></a>
Integration into larger DAQ system</h2>
<p>The stand-alone <a class="el" href="classWIB.html">WIB</a> app is a good starting place and testing. The run control can integratoe the <a class="el" href="classWIB.html">WIB</a> configuration and the overall DAQ configuration by starting nanorc with a specific top-configuration file. Example: </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;apparatus_id&quot;:&quot;np04_coldbox&quot;,</div>
<div class="line">    &quot;np04_coldbox_wibs&quot;:&quot;/nfs/sw/dunedaq/dunedaq-v3.1.0/configurations/np04_coldbox_wibs_2us&quot;,</div>
<div class="line">    &quot;np04_coldbox_felix_ctrl&quot;:&quot;/nfs/sw/dunedaq/dunedaq-v3.1.0/configurations/np04_coldbox_flx_ctrl&quot;,</div>
<div class="line">    &quot;np04_coldbox_daq&quot;:&quot;/nfs/sw/dunedaq/dunedaq-v3.1.0/configurations/np04_coldbox_daq_4ms&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md352"></a>
Stateful vs stateless</h1>
<p>Currently, <code>WIBModule</code> and <code>wib_server</code> are nominally stateless, meaning they will attempt to program the settings they are passed and report success or failure. (One exception to this is power state, which is tracked by <code>wib_server</code>.)</p>
<p>This has two important consequences:</p><ul>
<li>There is very little logic or parameter sanity checking, making the interface and control code that much simpler.</li>
<li>Whoever wants to configure the <a class="el" href="classWIB.html">WIB</a> (DUNE DAQ/SC/CCM) has to keep track of the intended state. Since these entities <em>should be</em> tracking the detector state anyway, this seems fine.</li>
</ul>
<p>In the DAQ framework it is possible to register commands with the states in which they can be successfully executed. The DAQ application framework keeps track to the DAQ state (which is not the detector state!) and makes sanity checks at this level. This is an extension to the wibmod code that may be considered.</p>
<p>That said, an argument could be made that <code>WIBModule</code> should perhaps track the last-programmed state and allow changes to this state, rather than requiring the entire <a class="el" href="classWIB.html">WIB</a> state be fully specified for each configuration. Such arguments should be regarded with great caution, because <code>WIBModule</code> is the wrong place to track detector state, and will not preserve it across control software restarts. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
