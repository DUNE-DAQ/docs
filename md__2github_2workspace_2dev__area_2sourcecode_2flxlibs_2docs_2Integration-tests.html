<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: Felix Firmware Integration Testing status</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Felix Firmware Integration Testing status</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md72"></a> <a href="https://docs.google.com/spreadsheets/d/1wXz7qx9HzWGdVpDBZSh985ecvFOZMB51oAWpZzaUU-k/edit#gid=1776651850">flx712-2.1.0 Testing status</a></p>
<h1><a class="anchor" id="autotoc_md73"></a>
## Initial setup</h1>
<h2><a class="anchor" id="autotoc_md74"></a>
Firmware:</h2>
<p>Download a copy of the FELIX firmware <a href="https://dune-fw.web.cern.ch/dune-fw/?dir=felix-pie/tags/v2.0.0/latest">here</a>.</p>
<p><em>Note, to get the 10 link build with the TPG firmware download the file starting with <code>flx712-dune-ipbus-pod-10hf</code></em></p>
<p>To program the FELIX card, you can use Vivado if you have not setup a dunedaq envirnomnent (see below), otherwise, you can use the low level tool <code>fflashprog</code> to flash the correct partition on the card. Each method uses a different file type, both of which are provided in the download.</p>
<h3><a class="anchor" id="autotoc_md75"></a>
Vivado:</h3>
<p>To program with Vivado, you need to ensure you have X-11 forwarding or a VNC if you are connecting to the machine remotely, a copy of the .bit file of the firmware and can run as <code>sudo</code> or <code>root</code> on the machine you are working on. Run vivado: </p><div class="fragment"><div class="line">vivado</div>
</div><!-- fragment --><p>and a GUI should appear, under Tasks select the option "Open Hardware Manager", then "tools" -&gt; "open new target". This will open a window where you can connect to hardware locally or via a remote server. Assuming this is the machine with the FELIX card installed connect to local server and in the next window look for a hardware device (bottom table) with the device name including <code>xkcu115</code>. Click next then finish. You should see the device appear on the hardware tab on the left. Now click "tools" -&gt; "program device" -&gt; "xkcu115" and then specify the bitstream (.bit) file and click program. I the programming worked then you should see no errors in the tcl console (some warnings may appear but can be ingored), and now you can close vivado and reboot the machine with the FELIX card:</p>
<div class="fragment"><div class="line">sudo reboot</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md76"></a>
&lt;tt&gt;fflashprog&lt;/tt&gt;:</h3>
<p>To program with <code>fflashprog</code> ensure you have a copy of the .mcs file of the firmware, already have a working dunedaq environment or a copy of the low level tools and can run as <code>sudo</code> or <code>root</code> on the machine you are working on. Then run the commands:</p>
<div class="fragment"><div class="line">fflashprog -c 0 -f 3 &lt;.mcs file to program&gt; prog</div>
</div><!-- fragment --><p> to program the FELIX card (card number denoted by <code>-c</code>). Then to check if the firmware is programmed with the correct firmware: </p><div class="fragment"><div class="line">fflashprog -c 0 -f 3 &lt;.mcs file to program&gt;</div>
</div><!-- fragment --><p> Finally, the machine needs to be fully power cycled for the firmware image to corectly load.</p>
<p><em>Note, the -f command indicates which partition to program, if programming on partition 3 doesn't work, run <code>flx-info</code> to get the correct partition number or program the card using vivado.</em></p>
<h2><a class="anchor" id="autotoc_md77"></a>
Drivers:</h2>
<p>To install drivers for the FELIX card follow the instructions to setup local drivers:</p>
<p><a href="https://github.com/DUNE-DAQ/flxlibs/wiki/Local-driver">https://github.com/DUNE-DAQ/flxlibs/wiki/Local-driver</a></p>
<p>Ensure the FELIX is programmed, the first check is to enable and get the status of the drivers:</p>
<div class="fragment"><div class="line">sudo &lt;location of local drivers&gt;/drivers_flx_local start</div>
<div class="line">sudo &lt;location of local drivers&gt;/drivers_flx_local status</div>
</div><!-- fragment --><p>if you see the following output after starting the drivers:</p>
<div class="fragment"><div class="line">Starting cmem driver </div>
<div class="line">major number for cmem_rcc is 238</div>
<div class="line"> </div>
<div class="line">Starting io_rcc driver </div>
<div class="line">major number for io_rcc is 237</div>
<div class="line"> </div>
<div class="line">2 flx PCIe endpoints found</div>
<div class="line">Starting flx driver </div>
<div class="line">major number for flx is 236</div>
<div class="line">creating node /dev/flx0</div>
<div class="line">creating node /dev/flx1</div>
</div><!-- fragment --><p>then it has successfully worked, if you see errors, then reboot the machine and try again.</p>
<p><em>Note you can ignore error messeges about regmap verision mismatches</em></p>
<h2><a class="anchor" id="autotoc_md78"></a>
DUNEDAQ software:</h2>
<p>First ensure you have setup a dunedaq enivronmet, following these instructions: <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/daq-buildtools/#running-a-release-from-cvmfs">https://dune-daq-sw.readthedocs.io/en/latest/packages/daq-buildtools/#running-a-release-from-cvmfs</a></p>
<p>Now to get access to the integration test scripts and create test configurations, clone the flxlibs repository: </p><div class="fragment"><div class="line">cd sourcecode</div>
<div class="line">git clone https://github.com/DUNE-DAQ/flxlibs.git</div>
<div class="line">dbt-workarea-env</div>
<div class="line">dbt-build.py</div>
<div class="line">cd ..</div>
</div><!-- fragment --><p>Clone dtp-pattens in your working directory, a repository containing fake data patterns to test with the FELIX: </p><div class="fragment"><div class="line">git clone ssh://git@gitlab.cern.ch:7999/dune-daq/readout/dtp-patterns.git</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md79"></a>
Running tests</h1>
<h2><a class="anchor" id="autotoc_md80"></a>
test dataflow with low level tools:</h2>
<p>Integration test scripts are located in <code>flxlibs/scripts/integration-tests</code> </p>
<h3><a class="anchor" id="autotoc_md81"></a>
basic card communication</h3>
<p>run the bash script: </p><div class="fragment"><div class="line">./test-communication.sh</div>
</div><!-- fragment --><p> which will test the capability to reset the state of the FELIX, monitor optical links and configuring the card e.g. enabling elinks.</p>
<h3><a class="anchor" id="autotoc_md82"></a>
test dataflow of ADC links using the internal emulator</h3>
<p>run the bash script: </p><div class="fragment"><div class="line">./test-adc-dataflow-emu.sh</div>
</div><!-- fragment --><p> which will configure the card to play data from the internal emulator on the ADC links. this will run the fdaq command for each SLR. If the test is successful you should see a non-zero data rate received by the FELIX.</p>
<h3><a class="anchor" id="autotoc_md83"></a>
test dataflow of ADC links with optical links</h3>
<p>to test receiving data over optical links you need to first run the following command: </p><div class="fragment"><div class="line">./test-adc-dataflow-fe.sh</div>
</div><!-- fragment --><p> then in a second terminal you must enable the front end device to play data (include zcu102 instructions here?). If the test is successful you should see a non-zero data rate once the front end device is configured.</p>
<h3><a class="anchor" id="autotoc_md84"></a>
test dataflow of TP links with the wibulator</h3>
<p>First run on a SLR 0 and 1 separately: </p><div class="fragment"><div class="line">./test-tpg-dataflow-wib-slr0.sh</div>
<div class="line">./test-tpg-dataflow-wib-slr1.sh</div>
</div><!-- fragment --><p> This will run <code>fdaq</code>, then configure the firmware TPG with <code>hfButler.py</code> and then spy on the link processors. if successful you should see the link processor state change over time for ~60s. After 60s the page will stop updating and you can safely kill the process (ctrl-C). Note you will also get an output file which logs the output of <code>fdaq</code>, as well as a binary file with the dumped TP's processed by the card.</p>
<p>Now run with both SLR's simultaneously: </p><div class="fragment"><div class="line">./test-tpg-dataflow-wib.sh</div>
</div><!-- fragment --><p> This will run <code>fdaq</code> for each SLR for 60s and as before a log file plus binary file of dumped tp's are produced.</p>
<h3><a class="anchor" id="autotoc_md85"></a>
test dataflow of TP links with the internal FELIX emulator</h3>
<p>Run the bash script </p><div class="fragment"><div class="line">./test-tpg-dataflow-emu.sh</div>
</div><!-- fragment --><p> this will configure the card to play data from the internal emulator, run <code>fdaq</code> then configure the hitfinding tpg in gbt mode i.e. process data from elinks. The outputs of fdaq are stored in log files. if successful you should see the data rate increase twice, once when the adc data is received and then again when the tpg is configured.</p>
<h3><a class="anchor" id="autotoc_md86"></a>
test dataflow of TP links with optical links</h3>
<p>First run the bash script </p><div class="fragment"><div class="line">./test-tpg-dataflow-fe.sh</div>
</div><!-- fragment --><p> then configure the front end to produce data. now in another terminal run the bash script: </p><div class="fragment"><div class="line">./set_gbt.sh</div>
</div><!-- fragment --><p> which will configure the hitfinding tpg to process data from the elinks. this will produce an output file for each <code>fdaq</code> run and if you want to monitor the link processors of the tpg then run <code>set_gbt.sh</code> with these arguements instead: </p><div class="fragment"><div class="line">./set_gbt.sh watch-0 # watch processor on SLR 0</div>
</div><!-- fragment --> <div class="fragment"><div class="line">./set_gbt.sh watch-1 # watch processor on SLR 1</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md87"></a>
test readout with DUNE-DAQ</h2>
<p><em><b>First ensure you are able to ssh into the machine you are working in, as nanorc will run the various DAQ modules as localhosts.</b></em></p>
<p>A custom command to raw record data is provided: <code>flxlibs/scripts/integration-tests/record-cmd.json</code>, which should be copied in the work area.</p>
<h3><a class="anchor" id="autotoc_md88"></a>
Test ADC recording with the internal FELIX emulator</h3>
<p>to generate a 10 ADC link configuration run the following command: </p><div class="fragment"><div class="line">python -m flxlibs.app_confgen -n 10 -t 0 -m &quot;0-4:0-4&quot; -e -E app_flx_10</div>
</div><!-- fragment --><p> where <code>-e</code> enables generation of fake timestamps when using fake data patterns and <code>-E</code> enables the internal emulator. Then run the following: </p><div class="fragment"><div class="line">./test-communication.sh</div>
<div class="line">nanorc app_flx_10 test-emu</div>
</div><!-- fragment --><p> once in the daq_application run the commands: </p><div class="fragment"><div class="line">boot conf start &lt;run number&gt;</div>
</div><!-- fragment --><p> and you should see dataflow on the datalinkhandlers. the key is to look for non-zero values in the following flags in the output file <code>info_333.json</code>: </p><div class="fragment"><div class="line">num_blocks_processed</div>
<div class="line">num_chunks_processed</div>
<div class="line">num_subchunks_processed</div>
<div class="line">rate_blocks_processed</div>
<div class="line">rate_chunks_processed</div>
</div><!-- fragment --><p> and the following should be zero if there is no errors </p><div class="fragment"><div class="line">num_blocks_processed_with_error</div>
<div class="line">num_chunks_processed_with_error</div>
<div class="line">num_short_chunks_processed_with_error</div>
<div class="line">num_subchunk_crc_errors</div>
<div class="line">num_subchunk_errors</div>
<div class="line">num_subchunk_trunc_errors</div>
<div class="line">num_subchunks_processed_with_error</div>
</div><!-- fragment --><p> Note that during the start of dataflow some errors can occur, but this is due to data being readout between the start and end of a chunk.</p>
<p>To record the raw ADC to file you need to run the expert command which runs the json file <code>record-cmd.json</code>.</p>
<div class="fragment"><div class="line">expert_command app_flx_10/app_flx_10/readout_app record-cmd.json</div>
</div><!-- fragment --><p>To stop the test run the following: </p><div class="fragment"><div class="line">stop_run</div>
<div class="line">scrap</div>
<div class="line">quit</div>
</div><!-- fragment --><p>if the application terminates correctly nanorc will print an exit code 255.</p>
<h3><a class="anchor" id="autotoc_md89"></a>
Test ADC recording with the optical links</h3>
<p>run the following command: </p><div class="fragment"><div class="line">python -m flxlibs.app_confgen -n 10 -t 0 -m &quot;0-4:0-4&quot; -e app_flx_10</div>
</div><!-- fragment --><p> which prevents the internal emulator from running. Then run the following: </p><div class="fragment"><div class="line">./test-communication.sh</div>
<div class="line">femu -d 0 -n</div>
<div class="line">femu -d 1 -n</div>
<div class="line">nanorc app_flx_10 test-fe</div>
</div><!-- fragment --><p> once in the daq_application run the commands: </p><div class="fragment"><div class="line">boot conf start &lt;run number&gt;</div>
</div><!-- fragment --><p> and here you should see no dataflow on any link handlers. Now configure the front end device to send data along the optical fibers and you should see the link handler information update similar to the previous test.</p>
<p>To record the raw ADC to file: </p><div class="fragment"><div class="line">expert_command app_flx_10/app_flx_10/readout_app record-cmd.json</div>
</div><!-- fragment --><p>To stop the test run the following: </p><div class="fragment"><div class="line">stop_run</div>
<div class="line">scrap</div>
<div class="line">quit</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md90"></a>
Test TP dataflow with the wibulator</h3>
<p>run the following command: </p><div class="fragment"><div class="line">python -m flxlibs.app_confgen -n 0 -t 2 -m &quot;5:5&quot; -e app_flx_2</div>
</div><!-- fragment --><p> run the daq_app as before: </p><div class="fragment"><div class="line">./test-communication.sh</div>
<div class="line">femu -d 0 -n</div>
<div class="line">femu -d 1 -n</div>
<div class="line">nanorc app_flx_2 test-wib</div>
<div class="line">boot conf start &lt;run number&gt;</div>
</div><!-- fragment --><p> and then enable the wibulator in another terminal: </p><div class="fragment"><div class="line">./set_wibulator.sh</div>
</div><!-- fragment --><p> and you can spy on the link processors by adding either <code>watch-0</code> or <code>watch-1</code> as an argument. If successful you should see dataflow on the two link handlers.</p>
<p>To record the raw ADC to file: </p><div class="fragment"><div class="line">expert_command app_flx_2/app_flx_2/readout_app record-cmd.json</div>
</div><!-- fragment --><p>To stop the test run the following: </p><div class="fragment"><div class="line">stop_run</div>
<div class="line">scrap</div>
<div class="line">quit</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md91"></a>
Test TP dataflow with the internal emulator</h3>
<p>run the following command: </p><div class="fragment"><div class="line">python -m flxlibs.app_confgen -n 10 -t 2 -m &quot;0-5:0-5&quot; -e -E app_flx_12</div>
</div><!-- fragment --><p> run the daq_app as before: </p><div class="fragment"><div class="line">./test-communication.sh</div>
<div class="line">nanorc app_flx_12 test-emu</div>
<div class="line">boot conf start &lt;run number&gt;</div>
</div><!-- fragment --><p> now enable the hitfinding TPG in GBT mode: </p><div class="fragment"><div class="line">./set_gbt.sh</div>
</div><!-- fragment --><p> and you should see dataflow on link handlers 5 and 11. <em><b>Note the TP links which have a smaller data rate than the adc links.</b></em></p>
<p>To record the raw ADC to file: </p><div class="fragment"><div class="line">expert_command app_flx_12/app_flx_12/readout_app record-cmd.json</div>
</div><!-- fragment --><p>To stop the test run the following: </p><div class="fragment"><div class="line">stop_run</div>
<div class="line">scrap</div>
<div class="line">quit</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md92"></a>
Test TP dataflow with the optical links</h3>
<p>run the following command: </p><div class="fragment"><div class="line">python -m flxlibs.app_confgen -n 10 -t 2 -m &quot;0-5:0-5&quot; -e app_flx_12</div>
</div><!-- fragment --><p> run the daq_app as before: </p><div class="fragment"><div class="line">./test-communication.sh</div>
<div class="line">femu -d 0 -n</div>
<div class="line">femu -d 1 -n</div>
<div class="line">nanorc app_flx_12 test-fe</div>
<div class="line">boot conf start &lt;run number&gt;</div>
</div><!-- fragment --><p> Next configure the front end to send data. Once done the adc links should have non zero data rates.</p>
<p>Now enable the hitfinding TPG in GBT mode: </p><div class="fragment"><div class="line">./set_gbt.sh</div>
</div><!-- fragment --><p> and you should see dataflow on link handlers 5 and 11.</p>
<p>To record the raw ADC to file: </p><div class="fragment"><div class="line">expert_command app_flx_12/app_flx_12/readout_app record-cmd.json</div>
</div><!-- fragment --><p>To stop the test run the following: </p><div class="fragment"><div class="line">stop_run</div>
<div class="line">scrap</div>
<div class="line">quit</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md93"></a>
Test TP dataflow with &lt;tt&gt;nanorc&lt;/tt&gt;</h2>
<p>Create the following nanorc configuration: </p><div class="fragment"><div class="line">fddaqconf_gen -f -e --host-ru localhost --region-id 0 --host-df localhost -o . -s 1 --number-of-data-producers 10 --enable-firmware-tpg --enable-raw-recording --enable-tpset-writing --trigger-activity-config &#39;dict(prescale=500)&#39; --trigger-candidate-config &#39;dict(prescale=20)&#39; --tpg-channel-map ProtoDUNESP1ChannelMap flx-fw-json</div>
</div><!-- fragment --><p> to raw record data in nanorc you must create a file <code>record-cmd.json</code> with the following contents: </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;data&quot;: {</div>
<div class="line">        &quot;modules&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;data&quot;: {</div>
<div class="line">                    &quot;duration&quot;: 1</div>
<div class="line">                },</div>
<div class="line">                &quot;match&quot;: &quot;&quot;</div>
<div class="line">            }</div>
<div class="line">        ]</div>
<div class="line">    },</div>
<div class="line">    &quot;id&quot;: &quot;record&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p> Now, depending on the tpye of data to readout you can follow the above steps to configure the FELIX a certain way. Here we will show how to readout data from the internal emulator.</p>
<p>In a new terminal (with the dunedaq environment setup), configure the card: </p><div class="fragment"><div class="line">./test-communication.sh</div>
</div><!-- fragment --><p>In another terminal run nanorc: </p><div class="fragment"><div class="line">nanorc flx-fw-json/ boot test init conf start resume wait 60 stop scrap terminate</div>
</div><!-- fragment --><p>Which will boot the localhosts, initilise and configure the card, start dataflow, wait 60s stop and terminate the program. During the wait period (a small loading bar will appear), configure the firmware tpg to process data from the elinks: </p><div class="fragment"><div class="line">./set_gbt.sh</div>
</div><!-- fragment --><p> and once this is done you can record data for 1s using this command: </p><div class="fragment"><div class="line">curl -d &quot;@record.json&quot; -H &quot;Content-Type: application/json&quot; -H &quot;X-Answer-Port: 9876&quot; -X POST &lt;localhost-url&gt;:3336/command</div>
</div><!-- fragment --><p> note if you are unsure of your local host url it will appear during the boot process of nanorc e.g. <a href="http://np04-srv-30:3336/">http://np04-srv-30:3336/</a></p>
<p>if you are unable to run the above commands in time then extend the wait period, and if you want to record for more than 1s you can modify record-cmd.json <b>but be warned, the data rate is very high</b>. if successful, you will see output files for each link with a rather with file sizes of ~1GB. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
