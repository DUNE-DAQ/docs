<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: timinglibs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">timinglibs</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md396"></a></p>
<h1><a class="anchor" id="autotoc_md397"></a>
Overview</h1>
<h2><a class="anchor" id="autotoc_md398"></a>
In a single sentence</h2>
<p><code>timinglibs</code> is a repository containing a collection of DUNE DAQ modules, which together form the timing control and monitoring DAQ application.</p>
<h2><a class="anchor" id="autotoc_md399"></a>
In a bit more detail:</h2>
<p>The DUNE DAQ modules in <code>timnglibs</code> can be split in two groups:</p>
<ul>
<li>DAQ mdoules which provide the control, configuration, and monitoring interface to the <code>HD</code> timing system</li>
<li>DAQ modules which provide <code>HSI</code> functionality, i.e. emulation and readout</li>
</ul>
<p><code>timinglibs</code> also provides a set of python scripts to generate the necessary <code>json</code> configuration files to run the aforementioned DUNE DAQ modules.</p>
<p>Each of the different aspects of <code>timinglibs</code> are described in more detail in the following sections.</p>
<h1><a class="anchor" id="autotoc_md400"></a>
DUNE DAQ Modules</h1>
<h2><a class="anchor" id="autotoc_md401"></a>
Control, configuration, and monitoring</h2>
<p>The general principle of the modules providing the timing <code>CCM</code> interface is that there is one hardware interface module which handles all interactions between <code>CCM</code> and the timing hardware. This hardware interface module receives its low level commands from <code>controller</code> modules, which receive higher level commands from <code>CCM</code>, and translate them into the low level instructions consumed by the hardware interface. Each <code>controller</code> module is responsible for indepdently managing a particular logical entity within the timng system, e.g. <code>timing master</code>, <code>timing partition</code>, or <code>timing endpoint</code>. An illustration of the envisioned timing software stack can be found below.</p>
<p><img src="./timing_software_diagram.png" alt="timing software" class="inline"/></p>
<p>A diagram of the connections between <code>timinglibs</code> DUNE DAQ modules inside of an example timing control application is shown below.</p>
<p><img src="./example_timing_app_modules.png" alt="example timing app modules" class="inline"/></p>
<p>A list of the currently implemented control mdoules, along with their function, can be found below.</p>
<h3><a class="anchor" id="autotoc_md402"></a>
TimingHardwareManagerPDI</h3>
<p>It receives hardware commands from timing <code>controller</code> modules, and makes the appropriate calls to <code>PD-I</code> timing hardware over <code>IPBus</code>. The interface to the timing hardware is provided by the <a href="https://github.com/DUNE-DAQ/timing"><code>timing</code> package</a>. It is also responsible for extracting operational monitoring information from timing devices, e.g. <code>timing master</code>, <code>timing HSI</code>, <code>timing endpoint</code>.</p>
<p>The module currently supports the following timing firmware and hardware combinations.</p>
<ul>
<li>Master designs<ul>
<li><code>Boreas</code> on <code>TLU</code></li>
<li><code>Boreas</code> on <code>FMC</code></li>
<li><code>Overlord</code> on <code>TLU</code></li>
<li><code>Overlord</code> on <code>FMC</code></li>
</ul>
</li>
<li>Endpoint designs<ul>
<li><code>Endpoint</code> on <code>FMC</code></li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md403"></a>
TimingMasterController</h3>
<p><code>controller</code> module providing an interface to <code>timing master</code> devices. It receives commands from an external source, e.g. a timing system operator or <code>CCM</code>, and translates those commands to timing hardware commands which are then sent to the hardware interface module. Each instance of this module is responsible for managing one particular physical <code>timing master</code>. The commands currently supported by the module are:</p>
<ul>
<li>master_io_reset</li>
<li>master_set_timestamp</li>
<li>master_print_status</li>
</ul>
<h3><a class="anchor" id="autotoc_md404"></a>
TimingPartitionController</h3>
<p>It receives <code>timing partition</code> commands from an external source, e.g. a timing system operator or <code>CCM</code>, and translates those commands to timing hardware commands which are then sent to the hardware interface module. Each instance of this module is responsible for managing one particular logical <code>timing partition</code>. The commands currently supported by the module are:</p>
<ul>
<li>partition_configure</li>
<li>partition_enable</li>
<li>partition_disable</li>
<li>partition_start</li>
<li>partition_stop</li>
<li>partition_enable_triggers</li>
<li>partition_disable_triggers</li>
<li>partition_print_status</li>
</ul>
<h3><a class="anchor" id="autotoc_md405"></a>
TimingEndpointController</h3>
<p>It receives <code>timing endpoint</code> commands from an external source, e.g. a timing system operator or <code>CCM</code>, and translates those commands to timing hardware commands which are then sent to the hardware interface module. The endpoint hardware commands issued by this module are addressed endpoint <code>0</code> on the <code>timing endpint</code> device. The commands currently supported by the module are:</p>
<ul>
<li>endpoint_io_reset</li>
<li>endpoint_enable</li>
<li>endpoint_disable</li>
<li>endpoint_reset</li>
<li>endpoint_print_status</li>
</ul>
<h3><a class="anchor" id="autotoc_md406"></a>
HSIController</h3>
<p>A module for controlling the <code>HD timing</code> implementation of an HSI. The HSI may or may not be in the same physical device as the <code>timing master</code>. The controller current accepts the following timing commands:</p>
<ul>
<li>hsi_io_reset</li>
<li>hsi_endpoint_enable</li>
<li>hsi_endpoint_disable</li>
<li>hsi_endpoint_reset</li>
<li>hsi_reset</li>
<li>hsi_configure</li>
<li>hsi_start</li>
<li>hsi_stop</li>
<li>hsi_print_status</li>
</ul>
<h2><a class="anchor" id="autotoc_md407"></a>
HSI readout and emulation</h2>
<h3><a class="anchor" id="autotoc_md408"></a>
HSIReadout</h3>
<p>A DUNE DAQ module for reading <code>HSIEvent</code> from <code>HSI</code> hardware. The module periodically polls the <code>HSI</code> firmware, and checks if there are complete events in the buffer. If there is at least one such event, the event is read out, a <code>dfmessages::HSIEvent</code> is constructed and sent out on the <code>HSIEvent</code> output queue. The interval between polls is configurable via the parameter <code>readout_period</code>.</p>
<h3><a class="anchor" id="autotoc_md409"></a>
FakeHSIEventGeneratorModule</h3>
<p>In the absence of real <code>HSI</code> hardware, this module can be used to emululate an <code>HSI</code>, and act as a source of <code>HSIEvent</code>s. The timestamp of the emulated <code>HSIEvent</code>s is obtained from timestamp estimates provided by <code>TimestampEstimator</code>. The distribution of signals in the <code>HSIEvent</code> bitmap along with their rate are configurable via the following parameters.</p>
<ul>
<li><code>clock_frequency</code>: Assumed clock frequency in Hz (for current-timestamp estimation); default: <code>62500000</code></li>
<li><code>timestamp_offset</code>: Offset for HSIEvent timestamps in units of clock ticks. Positive offset increases timestamp estimate; default: <code>0</code></li>
<li><code>event_period</code>: Period between HSIEvent generation [ns]; default: <code>1e9</code></li>
<li><code>hsi_device_id</code>: HSI device ID for emulated HSIEvent messages; default: <code>1</code></li>
<li><code>mean_signal_multiplicity</code>: Mean number of edges expected per signal. Used when signal emulation mode is 1; default: <code>1</code></li>
<li><code>enabled_signals</code>: Which signals or bit of the 32 bit signal bit map are enabled, i.e. could produce an emulated signal; default: <code>0</code></li>
<li><code>signal_emulation_mode</code>: Signal bit map emulation mode; default: <code>0</code><ul>
<li><code>0</code>: enabled signals always on</li>
<li><code>1</code>: enabled signals are emulated (independently) according to a Poisson with mean mean_signal_multiplicity; signal map generated with uniform distr. enabled signals only <br  />
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md410"></a>
Python configuration generation</h1>
<p>The <code><a class="el" href="timing__app__confgen_8py.html">timinglibs/python/timinglibs/timing_app_confgen.py</a></code> script generates a <code>json</code> configuration file for instantiation of timing control and monitoring application. The script takes in one argument which is the name of the produced <code>json</code> file. The default file name is <code>timing_app.json</code>. The script is also able to accept the following command line options:</p>
<ul>
<li><p class="startli"><code>-r</code> or <code>--run-number</code></p>
<p class="startli">Run number parameter for the <code>start</code> <code>rc</code> command. Not used in any particular way by the current "timing" modules. Default: <code>333</code>.</p>
</li>
<li><p class="startli"><code>-g</code> or <code>--gather-interval</code></p>
<p class="startli">Period (in us) between queries to timing firmware+hardware for "essential" (i.e. level 1) operational monitoring information. Default: <code>1e6</code> (us).</p>
</li>
<li><p class="startli"><code>-d</code> or <code>--gather-interval-debug</code></p>
<p class="startli">Period (in us) between queries to timing firmware+hardware for "debug" (i.e. level &gt; 1) operational monitoring information. Default: <code>10e6</code> (us).</p>
<p class="startli">N.B. This querying involves I2C transactions, setting too short a period may lead to software instability.</p>
</li>
<li><p class="startli"><code>-m</code> or <code>--master-device-name</code></p>
<p class="startli">Device name of the <code>timing master</code> to be monitored and controlled by the timing application. If the string supplied here is non-empty, a <code>TimingMasterController</code> named <code>tmc0</code>, and a <code>TimingPartitionController</code> named <code>tpc0</code> will be instantiated. <code>tpc0</code> manages <code>timing partition</code> <code>0</code> on the <code>timing master</code> device specified by <code>-m</code>. Default: <code>PROD_MASTER</code>.</p>
</li>
<li><p class="startli"><code>--master-clock-file</code></p>
<p class="startli">Clock configuration file to be used with <code>master_io_reset</code> commands issued by <code>tmc0</code>. Default: <code>""</code> (empty)</p>
</li>
<li><p class="startli"><code>--part-trig-mask</code>,</p>
<p class="startli">Partition trigger mask which is used by the <code>partition_configure</code> commands issued by <code>tpc0</code>. Default: <code>0xff</code></p>
</li>
<li><p class="startli">&lsquo;--part-spill-gate&rsquo;,`</p>
<p class="startli">Partition spill gate enabled flag which is used by the <code>partition_configure</code> commands issued by <code>tpc0</code>. Default: <code>True</code></p>
</li>
<li><p class="startli"><code>--part-rate-control</code></p>
<p class="startli">Partition rate control enabled flag which is used by the <code>partition_configure</code> commands issued by <code>tpc0</code>. Default: <code>True</code></p>
</li>
<li><p class="startli"><code>-e</code> or <code>--endpoint-device-name</code></p>
<p class="startli">Device name of an FMC based <code>timing endpoint</code> to be monitored and controlled by the timing application. If the string supplied here is non-empty, a <code>TimingEndpointController</code> named <code>tec0</code> will be instantiated. Default: <code>""</code></p>
</li>
<li><p class="startli"><code>--endpoint-clock-file</code></p>
<p class="startli">Clock configuration file to be used with <code>endpoint_io_reset</code> commands issued by <code>tec0</code>. Default: <code>""</code> (empty)</p>
</li>
<li><p class="startli"><code>--endpoint-address</code></p>
<p class="startli">Endpoint address to be used by <code>endpoint_enable</code> an <code>endpoint_reset</code> commands issued by <code>tec0</code>. Default: <code>0</code></p>
</li>
<li><p class="startli"><code>-h</code> or <code>--hsi-device-name</code>, default="")</p>
<p class="startli">Device name of the <code>HSI</code> to be monitored and controlled by the timing application. If the string supplied here is non-empty, a <code>HSIController</code> named <code>hsi0</code> will be instantiated. Default: <code>""</code> (empty).</p>
</li>
<li><p class="startli"><code>--hsi-clock-file</code></p>
<p class="startli">Clock configuration file to be used with <code>hsi_io_reset</code> commands issued by <code>hsi0</code>. Default: <code>""</code> (empty)</p>
</li>
<li><p class="startli"><code>--hsi-endpoint-address</code></p>
<p class="startli">Endpoint address to be used with <code>hsi_endpoint_enable</code> and <code>hsi_endpoint_reset</code> commands to <code>hsi0</code>. Default: <code>0</code></p>
</li>
<li><p class="startli"><code>--hsi-endpoint-partition</code></p>
<p class="startli">Endpoint partition to be used with <code>hsi_endpoint_enable</code> and <code>hsi_endpoint_reset</code> commands to <code>hsi0</code>. Default: <code>0</code></p>
</li>
<li><p class="startli"><code>--hsi-re-mask</code></p>
<p class="startli">Bit mask controlling whether the HSI triggers on the rising edges of the different incoming signals. Used with <code>hsi_configure</code> commands sent by <code>hsi0</code>. Default: <code>0</code></p>
</li>
<li><p class="startli"><code>--hsi-fe-mask</code></p>
<p class="startli">Bit mask controlling whether the HSI triggers on the failling edges of the different incoming signals. Used with <code>hsi_configure</code> commands sent by <code>hsi0</code>. Default: <code>0</code></p>
</li>
<li><p class="startli"><code>--hsi-inv-mask</code></p>
<p class="startli">Bit mask controlling whether the HSI inverts the edges of the different incoming signals. Used with <code>hsi_configure</code> commands sent by <code>hsi0</code>. Default: <code>0</code></p>
</li>
<li><p class="startli"><code>--hsi-source</code></p>
<p class="startli">Interger controlling the source of signals coming into the <code>HSI</code>. Used with <code>hsi_configure</code> commands sent by <code>hsi0</code>. Default: <code>0</code></p><ul>
<li><code>0</code>: signals are taken from the physical interface of the <code>HSI</code> device</li>
<li><code>1</code>: signals are taken to be bits <code>39-8</code> of the <code>HSI</code> endpoint timestamp. This is <code>emulation mode</code>, a constant rate of <code>HSI</code> triggers are generated according to the configured <code>re</code>, <code>fe</code>, and <code>inv</code> masks.</li>
</ul>
</li>
<li><p class="startli"><code>-u</code> or <code>--uhal-log-level</code></p>
<p class="startli">String to control the uhal logging level. Possible values are: <code>fatal, error, warning, notice, info, debug</code>. Default: <code>notice</code>.</p>
</li>
<li><p class="startli"><code>-o</code> or <code>--output-path</code></p>
<p class="startli">Path of the output <code>json</code> file. Default: <code>.</code> (current directory). </p>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
