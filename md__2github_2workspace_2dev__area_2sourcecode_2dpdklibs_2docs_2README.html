<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: dpdklibs - DPDK UIO software and utilities</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">dpdklibs - DPDK UIO software and utilities</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md102"></a>Appfwk DAQModules, utilities, and scripts for I/O cards over DPDK.</p>
<h1><a class="anchor" id="autotoc_md103"></a>
Setting up DPDK on NP04</h1>
<p>Ensure that the NIC is configured for DPDK based applications: <a href="https://github.com/DUNE-DAQ/dpdklibs/wiki/DPDK-based-NIC-configuration-on-servers">https://github.com/DUNE-DAQ/dpdklibs/wiki/DPDK-based-NIC-configuration-on-servers</a></p>
<h2><a class="anchor" id="autotoc_md104"></a>
How to run a system with a transmitter and/or a receiver:</h2>
<p>Generate the config with </p><div class="fragment"><div class="line">python sourcecode/dpdklibs/scripts/dpdklibs_gen.py -c conf.json dpdk_app</div>
</div><!-- fragment --><p>where <code>conf.json</code> has the parameters that we want to use (see <code>schema/dpdklibs/confgen.jsonnet</code> for a complete list of all the parameters) and then run it (as root)</p>
<div class="fragment"><div class="line">nanorc dpdk_app partition_name</div>
</div><!-- fragment --><p>Only the sender and only the receiver can be started with the parameters <code>only_sender</code> and <code>only_receiver</code> respectively. This is an example for the <code>conf.json</code> that enables only the sender:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;dpdklibs&quot;: {</div>
<div class="line">        &quot;only_sender&quot;: true</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md105"></a>
Setting up dpdk</h1>
<p>For convenience, there is a set of scripts in this repo to set up dpdk, assuming it has been installed and it works. These scripts have to be run as root. To begin setting up dpdk, run</p>
<div class="fragment"><div class="line">cd scripts</div>
<div class="line">./kernel.sh</div>
<div class="line">./hugepages.sh</div>
</div><!-- fragment --><p>The first script loads a new module to the kernel that will be used later to bind the NICs. The second script sets up <a href="https://wiki.debian.org/Hugepages">hugepages</a></p>
<p>Now we have to identify the available NICs, to do that run <code>dpdk-devbind.py -s</code></p>
<p>The output will look like </p><div class="fragment"><div class="line">Network devices using kernel driver</div>
<div class="line">============================================</div>
<div class="line">0000:41:00.0 &#39;Ethernet Connection X722 for 10GbE SFP+ 37d3&#39; unused=i40e,uio_pci_generic</div>
<div class="line">0000:41:00.1 &#39;Ethernet Connection X722 for 10GbE SFP+ 37d3&#39; unused=i40e,uio_pci_generic</div>
<div class="line">0000:dc:00.0 &#39;Ethernet Controller 10G X550T 1563&#39; if=enp220s0f0 drv=ixgbe unused=uio_pci_generic </div>
<div class="line">0000:dc:00.1 &#39;Ethernet Controller 10G X550T 1563&#39; if=enp220s0f1 drv=ixgbe unused=uio_pci_generic *Active*</div>
</div><!-- fragment --><p> in this case the ones that we want to use for dpdk are the first two so we have to bind them. Modify <code>bind.sh</code> to match the two addresses that we just found (in this case 0000:41:00.0 and 0000:41:00.1) and run </p><div class="fragment"><div class="line">./bind.sh</div>
</div><!-- fragment --><p>Now if we run <code>dpdk-devbind.py -s</code> the output should look like this: </p><div class="fragment"><div class="line">Network devices using DPDK-compatible driver</div>
<div class="line">============================================</div>
<div class="line">0000:41:00.0 &#39;Ethernet Connection X722 for 10GbE SFP+ 37d3&#39; drv=uio_pci_generic unused=i40e</div>
<div class="line">0000:41:00.1 &#39;Ethernet Connection X722 for 10GbE SFP+ 37d3&#39; drv=uio_pci_generic unused=i40e</div>
<div class="line"> </div>
<div class="line">Network devices using kernel driver</div>
<div class="line">===================================</div>
<div class="line">0000:dc:00.0 &#39;Ethernet Controller 10G X550T 1563&#39; if=enp220s0f0 drv=ixgbe unused=uio_pci_generic </div>
<div class="line">0000:dc:00.1 &#39;Ethernet Controller 10G X550T 1563&#39; if=enp220s0f1 drv=ixgbe unused=uio_pci_generic *Active*</div>
</div><!-- fragment --><p> where the NICs that we wanted appear under <code>Network devices using DPDK-compatible driver</code></p>
<h1><a class="anchor" id="autotoc_md106"></a>
Troubleshooting</h1>
<ul>
<li>EAL complains about <code>No available 1048576 kB hugepages reported</code></li>
<li><code>ERROR: number of ports has to be even</code> This happens when the interfaces are not bound. See instructions above on binding the interfaces, modify <code>scripts/bind.sh</code> and run it</li>
</ul>
<h1><a class="anchor" id="autotoc_md107"></a>
Tests and examples</h1>
<p>There are a set of tests or example applications</p>
<h2><a class="anchor" id="autotoc_md108"></a>
&lt;tt&gt;dpdklibs_test_transmit_and_receive&lt;/tt&gt;</h2>
<p>If you're on a host which contains two dpdk-enabled interfaces, you can run <code>dpdklibs_test_transmit_and_receive</code>. This app will send packets out of one interface on the host and receive them on the other. It will also keep track of the # of packets sent and received per second, the total # of bytes sent and received per second, and the number of packets which are received as corrupted per second (hopefully zero). Each packet is literally an ethernet header + an IPv4 header + a UDP header + a <code>detdataformats::DAQEthHeader</code> + a payload of zeros. The default length of the payload is 9000 bytes, but you can adjust this via the <code>--payload</code> argument; e.g. <code>dpdklibs_test_transmit_and_receive --payload 0</code> would send packets with no payload.</p>
<h2><a class="anchor" id="autotoc_md109"></a>
&lt;tt&gt;dpdklibs_test_frame_transmitter&lt;/tt&gt; / &lt;tt&gt;dpdklibs_test_frame_receiver&lt;/tt&gt;</h2>
<p><code>dpdklibs_test_frame_transmitter</code> and <code>dpdklibs_test_frame_receiver</code> only individually require a host with a single dpdk-enabled interface. A very common idiom is to run <code>dpdklibs_test_frame_receiver</code> receiving packets on the interface of one host and to run <code>dpdklibs_test_frame_transmitter</code> sending packets on the interface of another host.</p>
<p>For <code>dpdklibs_test_frame_transmitter</code>, you'll generally want to supply it with the MAC address of the interface which you want to have receive the packets it transmits. Also, while it sends packets with payloads just like <code>dpdklibs_test_transmit_and_receive</code>, it defaults them to 0. So, e.g., to send packets with 9KB of payload to an interface with a MAC address of <code>6c:fe:54:47:98:20</code> (available on <code>np02-srv-002</code> as of May-7-2023) you could run the following: <code>dpdklibs_test_frame_transmitter --dst-mac 6c:fe:54:47:98:20 --payload 9000</code></p>
<p>To receive the packets sent by <code>dpdklibs_test_frame_transmitter</code>, you can run <code>dpdklibs_test_frame_receiver</code>. You can also use it to receive packets from actual WIBs. If you're receiving packets from <code>dpdklibs_test_frame_transmitter</code>, you should see lines like the following: </p><div class="fragment"><div class="line">Stream (1, 2, 3, 4)   : n.pkts 0 (tot. 23786829)</div>
</div><!-- fragment --><p> ...since <code>dpdklibs_test_frame_transmitter</code> intentionally constructs the <code>detdataformats::DAQEthHeader</code> in its packets to have a <code>det_id</code> of 1, a <code>crate_id</code> of 2, a <code>slot_id</code> of 3, and a <code>stream_id</code> of 4. <br  />
</p>
<h2><a class="anchor" id="autotoc_md110"></a>
Configuring stats reporting from the &lt;tt&gt;DPDKReaderModule&lt;/tt&gt;</h2>
<p>The way packet statistics are reported from the <code>DPDKReaderModule</code> is on a per-interface basis. An example JSON snippet which can control this reporting is as follows: </p><div class="fragment"><div class="line">&quot;ifaces&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;stats_reporting_cfg&quot;: {</div>
<div class="line">            &quot;expected_packet_size&quot;: 7243,</div>
<div class="line">            &quot;expected_timestamp_step&quot;: -1,</div>
<div class="line">            &quot;expected_seq_id_step&quot;: 1,                          </div>
<div class="line">            &quot;analyze_nth_packet&quot;: 2                        </div>
<div class="line">        },</div>
<div class="line">        ...</div>
</div><!-- fragment --><p> This tells the interface to check that the packet size is 7243 bytes, to ignore the timestamp (any negative value for a variable beginning with <code>expected_</code> means "ignore"), and to check the sequence ID step is 1. It also tells it to only do this for every other packet, as a way of saving computation time. Note that all these variables have defaults and thus <code>"stats_reporting_cfg"</code> doesn't need to be defined if the defaults are satisfactory; these defaults are: expect a sequence ID step of 1 for each new packet in a stream, a packet size of 7243 bytes, ignore the timestamp, and analyze all packets. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
