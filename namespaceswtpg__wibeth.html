<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: swtpg_wibeth Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">swtpg_wibeth Namespace Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structswtpg__wibeth_1_1ChanState.html">ChanState</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classswtpg__wibeth_1_1RegisterArray.html">RegisterArray</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structswtpg__wibeth_1_1RegisterChannelMap.html">RegisterChannelMap</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="typedef-members" name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a5212114e9c86f1f2044f865ad632bb05" id="r_a5212114e9c86f1f2044f865ad632bb05"><td class="memItemLeft" align="right" valign="top">typedef <a class="el" href="classswtpg__wibeth_1_1RegisterArray.html">RegisterArray</a>&lt; <a class="el" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">swtpg_wibeth::NUM_REGISTERS_PER_FRAME</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a5212114e9c86f1f2044f865ad632bb05">FrameRegisters</a></td></tr>
<tr class="separator:a5212114e9c86f1f2044f865ad632bb05"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c505dbafbef97828b340152ec4d1009" id="r_a3c505dbafbef97828b340152ec4d1009"><td class="memItemLeft" align="right" valign="top">typedef <a class="el" href="classswtpg__wibeth_1_1RegisterArray.html">RegisterArray</a>&lt; <a class="el" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">swtpg_wibeth::NUM_REGISTERS_PER_FRAME</a> *<a class="el" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a3c505dbafbef97828b340152ec4d1009">MessageRegisters</a></td></tr>
<tr class="separator:a3c505dbafbef97828b340152ec4d1009"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a847682637d862f1382e530153f94a5c0" id="r_a847682637d862f1382e530153f94a5c0"><td class="memItemLeft" align="right" valign="top">constexpr double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a847682637d862f1382e530153f94a5c0">pi</a> ()</td></tr>
<tr class="separator:a847682637d862f1382e530153f94a5c0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa93821b1fdeb769b062c8ee015125891" id="r_aa93821b1fdeb769b062c8ee015125891"><td class="memItemLeft" align="right" valign="top">std::vector&lt; double &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#aa93821b1fdeb769b062c8ee015125891">hamming</a> (int M)</td></tr>
<tr class="separator:aa93821b1fdeb769b062c8ee015125891"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a60047280d41446f026abb36e0519a52d" id="r_a60047280d41446f026abb36e0519a52d"><td class="memItemLeft" align="right" valign="top">double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a60047280d41446f026abb36e0519a52d">sinc</a> (double x)</td></tr>
<tr class="separator:a60047280d41446f026abb36e0519a52d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae3cc08574de09a5a630a5ee2d8c282b8" id="r_ae3cc08574de09a5a630a5ee2d8c282b8"><td class="memItemLeft" align="right" valign="top">std::vector&lt; double &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#ae3cc08574de09a5a630a5ee2d8c282b8">firwin</a> (int N, double cutoff)</td></tr>
<tr class="separator:ae3cc08574de09a5a630a5ee2d8c282b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7c9e193a2f70bfdbe9381096a762948e" id="r_a7c9e193a2f70bfdbe9381096a762948e"><td class="memItemLeft" align="right" valign="top">std::vector&lt; int16_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a7c9e193a2f70bfdbe9381096a762948e">firwin_int</a> (int N, double cutoff, const int multiplier)</td></tr>
<tr class="separator:a7c9e193a2f70bfdbe9381096a762948e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a030e7d1bf33810eef23881b0d7dc90b1" id="r_a030e7d1bf33810eef23881b0d7dc90b1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a030e7d1bf33810eef23881b0d7dc90b1">print256</a> (__m256i var)</td></tr>
<tr class="separator:a030e7d1bf33810eef23881b0d7dc90b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acf24c544eafe9ef300b2e084639bf323" id="r_acf24c544eafe9ef300b2e084639bf323"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#acf24c544eafe9ef300b2e084639bf323">print256_as16</a> (__m256i var)</td></tr>
<tr class="separator:acf24c544eafe9ef300b2e084639bf323"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adfeea1783a8a114dc678104a15f7974c" id="r_adfeea1783a8a114dc678104a15f7974c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#adfeea1783a8a114dc678104a15f7974c">print256_as16_dec</a> (__m256i var)</td></tr>
<tr class="separator:adfeea1783a8a114dc678104a15f7974c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62216747dda630d556f9650402937dfc" id="r_a62216747dda630d556f9650402937dfc"><td class="memItemLeft" align="right" valign="top">__m256i&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a62216747dda630d556f9650402937dfc">unpack_one_register</a> (const <a class="el" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#aa8ee70c3aa9e15d5fe3e1601c002be65">dunedaq::fddetdataformats::WIBEthFrame::word_t</a> *first_word)</td></tr>
<tr class="separator:a62216747dda630d556f9650402937dfc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7ace901dccac1cb0bcb0826b2c948ddd" id="r_a7ace901dccac1cb0bcb0826b2c948ddd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a7ace901dccac1cb0bcb0826b2c948ddd">expand_wibeth_adcs</a> (const <a class="el" href="structdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter.html">dunedaq::fdreadoutlibs::types::DUNEWIBEthTypeAdapter</a> *__restrict__ ucs, <a class="el" href="namespaceswtpg__wibeth.html#a3c505dbafbef97828b340152ec4d1009">swtpg_wibeth::MessageRegisters</a> *__restrict__ register_array)</td></tr>
<tr class="separator:a7ace901dccac1cb0bcb0826b2c948ddd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7c441e5c1080316199d1d9e19847b389" id="r_a7c441e5c1080316199d1d9e19847b389"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a7c441e5c1080316199d1d9e19847b389">parse_wibeth_adcs</a> (<a class="el" href="namespaceswtpg__wibeth.html#a3c505dbafbef97828b340152ec4d1009">swtpg_wibeth::MessageRegisters</a> *__restrict__ register_array)</td></tr>
<tr class="separator:a7c441e5c1080316199d1d9e19847b389"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae3e721a661c262e8c8f39957add0f5bb" id="r_ae3e721a661c262e8c8f39957add0f5bb"><td class="memTemplParams" colspan="2">template&lt;size_t NREGISTERS&gt; </td></tr>
<tr class="memitem:ae3e721a661c262e8c8f39957add0f5bb"><td class="memTemplItemLeft" align="right" valign="top">void&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#ae3e721a661c262e8c8f39957add0f5bb">process_window_rs_avx2</a> (<a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;info)</td></tr>
<tr class="separator:ae3e721a661c262e8c8f39957add0f5bb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac7d721395ca97161451f878e2cf23630" id="r_ac7d721395ca97161451f878e2cf23630"><td class="memTemplParams" colspan="2">template&lt;size_t NREGISTERS&gt; </td></tr>
<tr class="memitem:ac7d721395ca97161451f878e2cf23630"><td class="memTemplItemLeft" align="right" valign="top">void&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#ac7d721395ca97161451f878e2cf23630">process_window_avx2</a> (<a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;info)</td></tr>
<tr class="separator:ac7d721395ca97161451f878e2cf23630"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa8731711fae0e3e45367533babfb537b" id="r_aa8731711fae0e3e45367533babfb537b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#aa8731711fae0e3e45367533babfb537b">frugal_accum_update</a> (int16_t &amp;m, const int16_t s, int16_t &amp;acc, const int16_t acclimit)</td></tr>
<tr class="separator:aa8731711fae0e3e45367533babfb537b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a13939e481227cf7cf43c0ac78c4c7fd4" id="r_a13939e481227cf7cf43c0ac78c4c7fd4"><td class="memTemplParams" colspan="2">template&lt;size_t NREGISTERS&gt; </td></tr>
<tr class="memitem:a13939e481227cf7cf43c0ac78c4c7fd4"><td class="memTemplItemLeft" align="right" valign="top">void&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a13939e481227cf7cf43c0ac78c4c7fd4">process_window_naive</a> (<a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;info)</td></tr>
<tr class="separator:a13939e481227cf7cf43c0ac78c4c7fd4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af4d03648c65e1b9e26960130d6ffe706" id="r_af4d03648c65e1b9e26960130d6ffe706"><td class="memTemplParams" colspan="2">template&lt;size_t NREGISTERS&gt; </td></tr>
<tr class="memitem:af4d03648c65e1b9e26960130d6ffe706"><td class="memTemplItemLeft" align="right" valign="top">void&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#af4d03648c65e1b9e26960130d6ffe706">process_window_naive_RS</a> (<a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;info)</td></tr>
<tr class="separator:af4d03648c65e1b9e26960130d6ffe706"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a53054061d015653bc31f57921c938094" id="r_a53054061d015653bc31f57921c938094"><td class="memTemplParams" colspan="2">template&lt;size_t NREGISTERS&gt; </td></tr>
<tr class="memitem:a53054061d015653bc31f57921c938094"><td class="memTemplItemLeft" align="right" valign="top">void&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a53054061d015653bc31f57921c938094">process_window_standard_rs_avx2</a> (<a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;info)</td></tr>
<tr class="separator:a53054061d015653bc31f57921c938094"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3cbf620849b300901d9348523eca2c23" id="r_a3cbf620849b300901d9348523eca2c23"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structswtpg__wibeth_1_1RegisterChannelMap.html">RegisterChannelMap</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a3cbf620849b300901d9348523eca2c23">get_register_to_offline_channel_map_wibeth</a> (const <a class="el" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a> *frame, std::shared_ptr&lt; dunedaq::detchannelmaps::TPCChannelMap &gt; &amp;ch_map)</td></tr>
<tr class="separator:a3cbf620849b300901d9348523eca2c23"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed08777792686dd83a98894bf8518ced" id="r_aed08777792686dd83a98894bf8518ced"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structswtpg__wibeth_1_1RegisterChannelMap.html">RegisterChannelMap</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#aed08777792686dd83a98894bf8518ced">get_register_to_offline_channel_map_wibeth</a> (const <a class="el" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a> *frame, std::string channel_map_name)</td></tr>
<tr class="separator:aed08777792686dd83a98894bf8518ced"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a735ab62c0ab75097f18a50bd37089c21" id="r_a735ab62c0ab75097f18a50bd37089c21"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a735ab62c0ab75097f18a50bd37089c21">frugal_accum_update_avx2</a> (__m256i &amp;__restrict__ median, const __m256i s, __m256i &amp;__restrict__ accum, const int16_t acclimit, const __m256i mask) __attribute__((always_inline))</td></tr>
<tr class="separator:a735ab62c0ab75097f18a50bd37089c21"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a01f29e52679785e2fc8a805a8a18c517" id="r_a01f29e52679785e2fc8a805a8a18c517"><td class="memItemLeft" align="right" valign="top">__m256i&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a01f29e52679785e2fc8a805a8a18c517">_mm256_div_epi16</a> (const __m256i va, const int b)</td></tr>
<tr class="separator:a01f29e52679785e2fc8a805a8a18c517"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7f2ba1d5fc86a0db73bd77e077ec6997" id="r_a7f2ba1d5fc86a0db73bd77e077ec6997"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a7f2ba1d5fc86a0db73bd77e077ec6997">printr256</a> (__m256i var)</td></tr>
<tr class="separator:a7f2ba1d5fc86a0db73bd77e077ec6997"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:afe2e22f04ea0340dd844dc6b56b5b617" id="r_afe2e22f04ea0340dd844dc6b56b5b617"><td class="memItemLeft" align="right" valign="top">const constexpr std::uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#afe2e22f04ea0340dd844dc6b56b5b617">MAGIC</a> = std::numeric_limits&lt;std::uint16_t&gt;::max()</td></tr>
<tr class="separator:afe2e22f04ea0340dd844dc6b56b5b617"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab5fe2d67a9fc85ab560254eb6e6748ef" id="r_ab5fe2d67a9fc85ab560254eb6e6748ef"><td class="memItemLeft" align="right" valign="top">const constexpr std::int16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#ab5fe2d67a9fc85ab560254eb6e6748ef">THRESHOLD</a> = 2000</td></tr>
<tr class="separator:ab5fe2d67a9fc85ab560254eb6e6748ef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adf6e94bcecc2386891f69bacfcf7ed3a" id="r_adf6e94bcecc2386891f69bacfcf7ed3a"><td class="memItemLeft" align="right" valign="top">const constexpr std::size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a> = 64</td></tr>
<tr class="separator:adf6e94bcecc2386891f69bacfcf7ed3a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a35bc84983ac065eb2d0981e169ea3f61" id="r_a35bc84983ac065eb2d0981e169ea3f61"><td class="memItemLeft" align="right" valign="top">const constexpr std::size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">NUM_REGISTERS_PER_FRAME</a> = 4</td></tr>
<tr class="separator:a35bc84983ac065eb2d0981e169ea3f61"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6c9009fe10d668dcbf330263cffae42a" id="r_a6c9009fe10d668dcbf330263cffae42a"><td class="memItemLeft" align="right" valign="top">const constexpr std::size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a6c9009fe10d668dcbf330263cffae42a">BYTES_PER_REGISTER</a> = 32</td></tr>
<tr class="separator:a6c9009fe10d668dcbf330263cffae42a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65e5e08d51fb120e9f5566ed5d578df6" id="r_a65e5e08d51fb120e9f5566ed5d578df6"><td class="memItemLeft" align="right" valign="top">const constexpr std::size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> = 16</td></tr>
<tr class="separator:a65e5e08d51fb120e9f5566ed5d578df6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a61ae264aec55185352ee186b065b92a1" id="r_a61ae264aec55185352ee186b065b92a1"><td class="memItemLeft" align="right" valign="top">const constexpr std::size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceswtpg__wibeth.html#a61ae264aec55185352ee186b065b92a1">ADCS_SIZE</a> = <a class="el" href="namespaceswtpg__wibeth.html#a6c9009fe10d668dcbf330263cffae42a">BYTES_PER_REGISTER</a> * <a class="el" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">NUM_REGISTERS_PER_FRAME</a> * <a class="el" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a></td></tr>
<tr class="separator:a61ae264aec55185352ee186b065b92a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="a5212114e9c86f1f2044f865ad632bb05" name="a5212114e9c86f1f2044f865ad632bb05"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5212114e9c86f1f2044f865ad632bb05">&#9670;&#160;</a></span>FrameRegisters</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef <a class="el" href="classswtpg__wibeth_1_1RegisterArray.html">RegisterArray</a>&lt;<a class="el" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">swtpg_wibeth::NUM_REGISTERS_PER_FRAME</a>&gt; <a class="el" href="namespaceswtpg__wibeth.html#a5212114e9c86f1f2044f865ad632bb05">swtpg_wibeth::FrameRegisters</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8hpp_source.html#l00062">62</a> of file <a class="el" href="FrameExpand_8hpp_source.html">FrameExpand.hpp</a>.</p>

</div>
</div>
<a id="a3c505dbafbef97828b340152ec4d1009" name="a3c505dbafbef97828b340152ec4d1009"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3c505dbafbef97828b340152ec4d1009">&#9670;&#160;</a></span>MessageRegisters</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef <a class="el" href="classswtpg__wibeth_1_1RegisterArray.html">RegisterArray</a>&lt;<a class="el" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">swtpg_wibeth::NUM_REGISTERS_PER_FRAME</a> * <a class="el" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a>&gt; <a class="el" href="namespaceswtpg__wibeth.html#a3c505dbafbef97828b340152ec4d1009">swtpg_wibeth::MessageRegisters</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8hpp_source.html#l00064">64</a> of file <a class="el" href="FrameExpand_8hpp_source.html">FrameExpand.hpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a01f29e52679785e2fc8a805a8a18c517" name="a01f29e52679785e2fc8a805a8a18c517"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a01f29e52679785e2fc8a805a8a18c517">&#9670;&#160;</a></span>_mm256_div_epi16()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">__m256i swtpg_wibeth::_mm256_div_epi16 </td>
          <td>(</td>
          <td class="paramtype">const __m256i&#160;</td>
          <td class="paramname"><em>va</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&#160;</td>
          <td class="paramname"><em>b</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="UtilsAVX2_8hpp_source.html#l00077">77</a> of file <a class="el" href="UtilsAVX2_8hpp_source.html">UtilsAVX2.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   78</span>{</div>
<div class="line"><span class="lineno">   79</span>    __m256i vb = _mm256_set1_epi16(32768 / b);</div>
<div class="line"><span class="lineno">   80</span>    <span class="keywordflow">return</span> _mm256_mulhrs_epi16(va, vb);</div>
<div class="line"><span class="lineno">   81</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a7ace901dccac1cb0bcb0826b2c948ddd" name="a7ace901dccac1cb0bcb0826b2c948ddd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7ace901dccac1cb0bcb0826b2c948ddd">&#9670;&#160;</a></span>expand_wibeth_adcs()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::expand_wibeth_adcs </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter.html">dunedaq::fdreadoutlibs::types::DUNEWIBEthTypeAdapter</a> *__restrict__&#160;</td>
          <td class="paramname"><em>ucs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="namespaceswtpg__wibeth.html#a3c505dbafbef97828b340152ec4d1009">swtpg_wibeth::MessageRegisters</a> *__restrict__&#160;</td>
          <td class="paramname"><em>register_array</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8hpp_source.html#l00193">193</a> of file <a class="el" href="FrameExpand_8hpp_source.html">FrameExpand.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  196</span>{</div>
<div class="line"><span class="lineno">  197</span> </div>
<div class="line"><span class="lineno">  198</span>  <span class="comment">// Number of ADC words per TS</span></div>
<div class="line"><span class="lineno">  199</span>  <span class="keywordtype">int</span> num_adc_words_per_ts = <a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#ac6b432e2195bb615ab222b2499149055">dunedaq::fddetdataformats::WIBEthFrame::s_num_adc_words_per_ts</a>;</div>
<div class="line"><span class="lineno">  200</span> </div>
<div class="line"><span class="lineno">  201</span>  <span class="keyword">const</span> <a class="code hl_class" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a>* frame_ptr =</div>
<div class="line"><span class="lineno">  202</span>      <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><a class="code hl_class" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a>*<span class="keyword">&gt;</span>(ucs);</div>
<div class="line"><span class="lineno">  203</span> </div>
<div class="line"><span class="lineno">  204</span>  <span class="comment">// Define a pointer to walk the rows of the WIBEth frame which is 2D array</span></div>
<div class="line"><span class="lineno">  205</span>  <span class="keyword">const</span> <a class="code hl_typedef" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#aa8ee70c3aa9e15d5fe3e1601c002be65">dunedaq::fddetdataformats::WIBEthFrame::word_t</a> (*frame_words_ptr)[14] = frame_ptr-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a40a9dbcec5f97cc57bb53c99260d003d">adc_words</a>;</div>
<div class="line"><span class="lineno">  206</span>  <span class="comment">//auto frame_words_ptr = frame_ptr-&gt;adc_words;  </span></div>
<div class="line"><span class="lineno">  207</span> </div>
<div class="line"><span class="lineno">  208</span>  <span class="keywordtype">int</span> reg_index = 0;</div>
<div class="line"><span class="lineno">  209</span>  <span class="comment">// Loop over time frames</span></div>
<div class="line"><span class="lineno">  210</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a>; ++i) {</div>
<div class="line"><span class="lineno">  211</span> </div>
<div class="line"><span class="lineno">  212</span>    <span class="comment">// The register index is used to decide on which of the </span></div>
<div class="line"><span class="lineno">  213</span>    <span class="comment">// registers we want to unpack the ADC messages</span></div>
<div class="line"><span class="lineno">  214</span>    <span class="comment">//int reg_index = 0;</span></div>
<div class="line"><span class="lineno">  215</span>    reg_index = 0;</div>
<div class="line"><span class="lineno">  216</span> </div>
<div class="line"><span class="lineno">  217</span>    <span class="comment">// Loop over ADC values (channels) in a given time sample</span></div>
<div class="line"><span class="lineno">  218</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; num_adc_words_per_ts; j++) {</div>
<div class="line"><span class="lineno">  219</span> </div>
<div class="line"><span class="lineno">  220</span>      <span class="comment">// The words repeat every 7 iterations. </span></div>
<div class="line"><span class="lineno">  221</span>      <span class="comment">// In this way we can use the DUNEWIB unpacking </span></div>
<div class="line"><span class="lineno">  222</span>      <span class="comment">// function (unpack_one_register) </span></div>
<div class="line"><span class="lineno">  223</span>      <span class="keywordflow">if</span> (j%7 == 0 ) {</div>
<div class="line"><span class="lineno">  224</span>        <span class="keyword">const</span> <a class="code hl_typedef" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#aa8ee70c3aa9e15d5fe3e1601c002be65">dunedaq::fddetdataformats::WIBEthFrame::word_t</a> * first_half = (*(frame_words_ptr + i) + j);</div>
<div class="line"><span class="lineno">  225</span> </div>
<div class="line"><span class="lineno">  226</span>        <span class="comment">// Unpack one register and add it to the register array</span></div>
<div class="line"><span class="lineno">  227</span>        register_array-&gt;<a class="code hl_function" href="classswtpg__wibeth_1_1RegisterArray.html#a1b7ea1aabd9d501e13cc913b3f7c704b">set_ymm</a>(i+reg_index*<a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a>, <a class="code hl_function" href="namespaceswtpg__wibeth.html#a62216747dda630d556f9650402937dfc">unpack_one_register</a>(first_half));</div>
<div class="line"><span class="lineno">  228</span>        reg_index += 1;</div>
<div class="line"><span class="lineno">  229</span> </div>
<div class="line"><span class="lineno">  230</span>        <span class="comment">// Increment the cursor by 224 bits to get the second part of the first time sample</span></div>
<div class="line"><span class="lineno">  231</span>        <span class="comment">// 224 corresponds to 16 (U blocks or ADCs) times 14 which are the bits per ADC. </span></div>
<div class="line"><span class="lineno">  232</span>        <span class="comment">// Check the spreadsheet for further details</span></div>
<div class="line"><span class="lineno">  233</span>        <span class="keywordtype">char</span>* cursor = (<span class="keywordtype">char</span>*) first_half;</div>
<div class="line"><span class="lineno">  234</span>        cursor += 224 / 8; <span class="comment">// divide by 8 to get the results in bytes</span></div>
<div class="line"><span class="lineno">  235</span>        <a class="code hl_typedef" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#aa8ee70c3aa9e15d5fe3e1601c002be65">dunedaq::fddetdataformats::WIBEthFrame::word_t</a> * second_half = (<a class="code hl_typedef" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#aa8ee70c3aa9e15d5fe3e1601c002be65">dunedaq::fddetdataformats::WIBEthFrame::word_t</a>*) cursor;</div>
<div class="line"><span class="lineno">  236</span>        <span class="comment">// Unpack another register and add it to the register array</span></div>
<div class="line"><span class="lineno">  237</span>        register_array-&gt;<a class="code hl_function" href="classswtpg__wibeth_1_1RegisterArray.html#a1b7ea1aabd9d501e13cc913b3f7c704b">set_ymm</a>(i+reg_index*<a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a>, <a class="code hl_function" href="namespaceswtpg__wibeth.html#a62216747dda630d556f9650402937dfc">unpack_one_register</a>(second_half));</div>
<div class="line"><span class="lineno">  238</span> </div>
<div class="line"><span class="lineno">  239</span>        reg_index += 1;</div>
<div class="line"><span class="lineno">  240</span>      }</div>
<div class="line"><span class="lineno">  241</span> </div>
<div class="line"><span class="lineno">  242</span> </div>
<div class="line"><span class="lineno">  243</span>    } <span class="comment">// loop over number of adc words per ts  </span></div>
<div class="line"><span class="lineno">  244</span>  } <span class="comment">// loop over time frames  </span></div>
<div class="line"><span class="lineno">  245</span> </div>
<div class="line"><span class="lineno">  246</span>}</div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a></div><div class="ttdoc">Class for accessing raw WIB eth frames, as used in ProtoDUNE-II.</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00033">WIBEthFrame.hpp:34</a></div></div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html_a40a9dbcec5f97cc57bb53c99260d003d"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a40a9dbcec5f97cc57bb53c99260d003d">dunedaq::fddetdataformats::WIBEthFrame::adc_words</a></div><div class="ttdeci">word_t adc_words[s_time_samples_per_frame][s_num_adc_words_per_ts]</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00080">WIBEthFrame.hpp:80</a></div></div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html_aa8ee70c3aa9e15d5fe3e1601c002be65"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#aa8ee70c3aa9e15d5fe3e1601c002be65">dunedaq::fddetdataformats::WIBEthFrame::word_t</a></div><div class="ttdeci">uint64_t word_t</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00041">WIBEthFrame.hpp:41</a></div></div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html_ac6b432e2195bb615ab222b2499149055"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#ac6b432e2195bb615ab222b2499149055">dunedaq::fddetdataformats::WIBEthFrame::s_num_adc_words_per_ts</a></div><div class="ttdeci">static constexpr int s_num_adc_words_per_ts</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00049">WIBEthFrame.hpp:49</a></div></div>
<div class="ttc" id="aclassswtpg__wibeth_1_1RegisterArray_html_a1b7ea1aabd9d501e13cc913b3f7c704b"><div class="ttname"><a href="classswtpg__wibeth_1_1RegisterArray.html#a1b7ea1aabd9d501e13cc913b3f7c704b">swtpg_wibeth::RegisterArray::set_ymm</a></div><div class="ttdeci">void set_ymm(size_t i, __m256i val)</div><div class="ttdef"><b>Definition</b> <a href="FrameExpand_8hpp_source.html#l00042">FrameExpand.hpp:42</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a62216747dda630d556f9650402937dfc"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a62216747dda630d556f9650402937dfc">swtpg_wibeth::unpack_one_register</a></div><div class="ttdeci">__m256i unpack_one_register(const dunedaq::fddetdataformats::WIBEthFrame::word_t *first_word)</div><div class="ttdef"><b>Definition</b> <a href="FrameExpand_8hpp_source.html#l00084">FrameExpand.hpp:84</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_adf6e94bcecc2386891f69bacfcf7ed3a"><div class="ttname"><a href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a></div><div class="ttdeci">const constexpr std::size_t FRAMES_PER_MSG</div><div class="ttdef"><b>Definition</b> <a href="TPGConstants__wibeth_8hpp_source.html#l00022">TPGConstants_wibeth.hpp:22</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae3cc08574de09a5a630a5ee2d8c282b8" name="ae3cc08574de09a5a630a5ee2d8c282b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae3cc08574de09a5a630a5ee2d8c282b8">&#9670;&#160;</a></span>firwin()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt; double &gt; swtpg_wibeth::firwin </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>N</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>cutoff</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="DesignFIR_8cpp_source.html#l00040">40</a> of file <a class="el" href="DesignFIR_8cpp_source.html">DesignFIR.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   41</span>{</div>
<div class="line"><span class="lineno">   42</span>  <span class="keywordtype">int</span> alpha = N / 2;</div>
<div class="line"><span class="lineno">   43</span>  std::vector&lt;double&gt; window = <a class="code hl_function" href="namespaceswtpg__wibeth.html#aa93821b1fdeb769b062c8ee015125891">hamming</a>(N);</div>
<div class="line"><span class="lineno">   44</span>  std::vector&lt;double&gt; ret;</div>
<div class="line"><span class="lineno">   45</span>  <span class="keywordtype">double</span> sum = 0;</div>
<div class="line"><span class="lineno">   46</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 0; m &lt; N; ++m) {</div>
<div class="line"><span class="lineno">   47</span>    <span class="keywordtype">double</span> val = window[m] * <a class="code hl_function" href="namespaceswtpg__wibeth.html#a60047280d41446f026abb36e0519a52d">sinc</a>(cutoff * (m - alpha));</div>
<div class="line"><span class="lineno">   48</span>    ret.push_back(val);</div>
<div class="line"><span class="lineno">   49</span>    sum += val;</div>
<div class="line"><span class="lineno">   50</span>  }</div>
<div class="line"><span class="lineno">   51</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m = 0; m &lt; N; ++m) {</div>
<div class="line"><span class="lineno">   52</span>    ret[m] /= sum;</div>
<div class="line"><span class="lineno">   53</span>  }</div>
<div class="line"><span class="lineno">   54</span>  <span class="keywordflow">return</span> <a class="code hl_variable" href="namespacecheckLinks.html#a54e97434ff6ffa7352831fbf2a93c0c3">ret</a>;</div>
<div class="line"><span class="lineno">   55</span>}</div>
<div class="ttc" id="anamespacecheckLinks_html_a54e97434ff6ffa7352831fbf2a93c0c3"><div class="ttname"><a href="namespacecheckLinks.html#a54e97434ff6ffa7352831fbf2a93c0c3">checkLinks.ret</a></div><div class="ttdeci">ret</div><div class="ttdef"><b>Definition</b> <a href="checkLinks_8py_source.html#l00008">checkLinks.py:8</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a60047280d41446f026abb36e0519a52d"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a60047280d41446f026abb36e0519a52d">swtpg_wibeth::sinc</a></div><div class="ttdeci">double sinc(double x)</div><div class="ttdef"><b>Definition</b> <a href="DesignFIR_8cpp_source.html#l00031">DesignFIR.cpp:31</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_aa93821b1fdeb769b062c8ee015125891"><div class="ttname"><a href="namespaceswtpg__wibeth.html#aa93821b1fdeb769b062c8ee015125891">swtpg_wibeth::hamming</a></div><div class="ttdeci">std::vector&lt; double &gt; hamming(int M)</div><div class="ttdef"><b>Definition</b> <a href="DesignFIR_8cpp_source.html#l00021">DesignFIR.cpp:21</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a7c9e193a2f70bfdbe9381096a762948e" name="a7c9e193a2f70bfdbe9381096a762948e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7c9e193a2f70bfdbe9381096a762948e">&#9670;&#160;</a></span>firwin_int()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt; int16_t &gt; swtpg_wibeth::firwin_int </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>N</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>cutoff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&#160;</td>
          <td class="paramname"><em>multiplier</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="DesignFIR_8cpp_source.html#l00058">58</a> of file <a class="el" href="DesignFIR_8cpp_source.html">DesignFIR.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   59</span>{</div>
<div class="line"><span class="lineno">   60</span>  std::vector&lt;double&gt; coeffs_double(<a class="code hl_function" href="namespaceswtpg__wibeth.html#ae3cc08574de09a5a630a5ee2d8c282b8">firwin</a>(N, cutoff));</div>
<div class="line"><span class="lineno">   61</span>  <span class="comment">// coeffs_double.push_back(0);</span></div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   63</span>  std::vector&lt;int16_t&gt; coeffs(N, 0);</div>
<div class="line"><span class="lineno">   64</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N; ++i) {</div>
<div class="line"><span class="lineno">   65</span>    coeffs[i] = round(multiplier * coeffs_double[i]);</div>
<div class="line"><span class="lineno">   66</span>  }</div>
<div class="line"><span class="lineno">   67</span>  <span class="keywordflow">return</span> coeffs;</div>
<div class="line"><span class="lineno">   68</span>}</div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_ae3cc08574de09a5a630a5ee2d8c282b8"><div class="ttname"><a href="namespaceswtpg__wibeth.html#ae3cc08574de09a5a630a5ee2d8c282b8">swtpg_wibeth::firwin</a></div><div class="ttdeci">std::vector&lt; double &gt; firwin(int N, double cutoff)</div><div class="ttdef"><b>Definition</b> <a href="DesignFIR_8cpp_source.html#l00040">DesignFIR.cpp:40</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aa8731711fae0e3e45367533babfb537b" name="aa8731711fae0e3e45367533babfb537b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa8731711fae0e3e45367533babfb537b">&#9670;&#160;</a></span>frugal_accum_update()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::frugal_accum_update </td>
          <td>(</td>
          <td class="paramtype">int16_t &amp;&#160;</td>
          <td class="paramname"><em>m</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int16_t&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int16_t &amp;&#160;</td>
          <td class="paramname"><em>acc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int16_t&#160;</td>
          <td class="paramname"><em>acclimit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="ProcessNaive_8hpp_source.html#l00022">22</a> of file <a class="el" href="ProcessNaive_8hpp_source.html">ProcessNaive.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   23</span>{</div>
<div class="line"><span class="lineno">   24</span>  <span class="keywordflow">if</span> (s &gt; m)</div>
<div class="line"><span class="lineno">   25</span>    ++acc;</div>
<div class="line"><span class="lineno">   26</span>  <span class="keywordflow">if</span> (s &lt; m)</div>
<div class="line"><span class="lineno">   27</span>    --acc;</div>
<div class="line"><span class="lineno">   28</span> </div>
<div class="line"><span class="lineno">   29</span>  <span class="keywordflow">if</span> (acc &gt; acclimit) {</div>
<div class="line"><span class="lineno">   30</span>    ++m;</div>
<div class="line"><span class="lineno">   31</span>    acc = 0;</div>
<div class="line"><span class="lineno">   32</span>  }</div>
<div class="line"><span class="lineno">   33</span> </div>
<div class="line"><span class="lineno">   34</span>  <span class="keywordflow">if</span> (acc &lt; -1 * acclimit) {</div>
<div class="line"><span class="lineno">   35</span>    --m;</div>
<div class="line"><span class="lineno">   36</span>    acc = 0;</div>
<div class="line"><span class="lineno">   37</span>  }</div>
<div class="line"><span class="lineno">   38</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a735ab62c0ab75097f18a50bd37089c21" name="a735ab62c0ab75097f18a50bd37089c21"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a735ab62c0ab75097f18a50bd37089c21">&#9670;&#160;</a></span>frugal_accum_update_avx2()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::frugal_accum_update_avx2 </td>
          <td>(</td>
          <td class="paramtype">__m256i &amp;__restrict__&#160;</td>
          <td class="paramname"><em>median</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const __m256i&#160;</td>
          <td class="paramname"><em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__m256i &amp;__restrict__&#160;</td>
          <td class="paramname"><em>accum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int16_t&#160;</td>
          <td class="paramname"><em>acclimit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const __m256i&#160;</td>
          <td class="paramname"><em>mask</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="UtilsAVX2_8hpp_source.html#l00025">25</a> of file <a class="el" href="UtilsAVX2_8hpp_source.html">UtilsAVX2.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   30</span>{</div>
<div class="line"><span class="lineno">   31</span>  <span class="comment">// if the sample is greater than the median, add one to the accumulator</span></div>
<div class="line"><span class="lineno">   32</span>  <span class="comment">// if the sample is less than the median, subtract one from the accumulator.</span></div>
<div class="line"><span class="lineno">   33</span> </div>
<div class="line"><span class="lineno">   34</span>  <span class="comment">// For reasons that I don&#39;t understand, there&#39;s no cmplt</span></div>
<div class="line"><span class="lineno">   35</span>  <span class="comment">// for &quot;compare less-than&quot;, so we have to compare greater,</span></div>
<div class="line"><span class="lineno">   36</span>  <span class="comment">// compare equal, and take everything else to be compared</span></div>
<div class="line"><span class="lineno">   37</span>  <span class="comment">// less-then</span></div>
<div class="line"><span class="lineno">   38</span>  __m256i is_gt = _mm256_cmpgt_epi16(s, median);</div>
<div class="line"><span class="lineno">   39</span>  __m256i is_eq = _mm256_cmpeq_epi16(s, median);</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span>  __m256i to_add = _mm256_set1_epi16(-1);</div>
<div class="line"><span class="lineno">   42</span>  <span class="comment">// Really want an epi16 version of this, but the cmpgt and</span></div>
<div class="line"><span class="lineno">   43</span>  <span class="comment">// cmplt functions set their epi16 parts to 0xff or 0x0,</span></div>
<div class="line"><span class="lineno">   44</span>  <span class="comment">// so treating everything as epi8 works the same</span></div>
<div class="line"><span class="lineno">   45</span>  to_add = _mm256_blendv_epi8(to_add, _mm256_set1_epi16(1), is_gt);</div>
<div class="line"><span class="lineno">   46</span>  to_add = _mm256_blendv_epi8(to_add, _mm256_set1_epi16(0), is_eq);</div>
<div class="line"><span class="lineno">   47</span> </div>
<div class="line"><span class="lineno">   48</span>  <span class="comment">// Don&#39;t add anything to the channels which are masked out</span></div>
<div class="line"><span class="lineno">   49</span>  to_add = _mm256_and_si256(to_add, mask);</div>
<div class="line"><span class="lineno">   50</span> </div>
<div class="line"><span class="lineno">   51</span>  accum = _mm256_add_epi16(accum, to_add);</div>
<div class="line"><span class="lineno">   52</span> </div>
<div class="line"><span class="lineno">   53</span>  <span class="comment">// if the accumulator is &gt;10, add one to the median and</span></div>
<div class="line"><span class="lineno">   54</span>  <span class="comment">// set the accumulator to zero. if the accumulator is</span></div>
<div class="line"><span class="lineno">   55</span>  <span class="comment">// &lt;-10, subtract one from the median and set the</span></div>
<div class="line"><span class="lineno">   56</span>  <span class="comment">// accumulator to zero</span></div>
<div class="line"><span class="lineno">   57</span>  is_gt = _mm256_cmpgt_epi16(accum, _mm256_set1_epi16(acclimit));</div>
<div class="line"><span class="lineno">   58</span>  __m256i is_lt =</div>
<div class="line"><span class="lineno">   59</span>    _mm256_cmpgt_epi16(_mm256_sign_epi16(accum, _mm256_set1_epi16(-1 * acclimit)), _mm256_set1_epi16(acclimit));</div>
<div class="line"><span class="lineno">   60</span> </div>
<div class="line"><span class="lineno">   61</span>  to_add = _mm256_setzero_si256();</div>
<div class="line"><span class="lineno">   62</span>  to_add = _mm256_blendv_epi8(to_add, _mm256_set1_epi16(1), is_gt);</div>
<div class="line"><span class="lineno">   63</span>  to_add = _mm256_blendv_epi8(to_add, _mm256_set1_epi16(-1), is_lt);</div>
<div class="line"><span class="lineno">   64</span> </div>
<div class="line"><span class="lineno">   65</span>  <span class="comment">// Don&#39;t add anything to the channels which are masked out</span></div>
<div class="line"><span class="lineno">   66</span>  to_add = _mm256_and_si256(to_add, mask);</div>
<div class="line"><span class="lineno">   67</span> </div>
<div class="line"><span class="lineno">   68</span>  median = _mm256_adds_epi16(median, to_add);</div>
<div class="line"><span class="lineno">   69</span> </div>
<div class="line"><span class="lineno">   70</span>  <span class="comment">// Reset the unmasked channels that were &gt;10 or &lt;-10 to zero, leaving the others unchanged</span></div>
<div class="line"><span class="lineno">   71</span>  __m256i need_reset = _mm256_or_si256(is_lt, is_gt);</div>
<div class="line"><span class="lineno">   72</span>  need_reset = _mm256_and_si256(need_reset, mask);</div>
<div class="line"><span class="lineno">   73</span>  accum = _mm256_blendv_epi8(accum, _mm256_setzero_si256(), need_reset);</div>
<div class="line"><span class="lineno">   74</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3cbf620849b300901d9348523eca2c23" name="a3cbf620849b300901d9348523eca2c23"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3cbf620849b300901d9348523eca2c23">&#9670;&#160;</a></span>get_register_to_offline_channel_map_wibeth() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structswtpg__wibeth_1_1RegisterChannelMap.html">RegisterChannelMap</a> swtpg_wibeth::get_register_to_offline_channel_map_wibeth </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a> *&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::shared_ptr&lt; dunedaq::detchannelmaps::TPCChannelMap &gt; &amp;&#160;</td>
          <td class="paramname"><em>ch_map</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The code that expands ADCs from WIBEth frame format into AVX registers for the software TP generation puts the channels in the output registers in some order that is convenient for the expansion code, but doesn't have any particular pattern to it. So we need to map from position-in-register to offline channel number. This function creates that map </p>

<p class="definition">Definition at line <a class="el" href="RegisterToChannelNumber_8cpp_source.html#l00036">36</a> of file <a class="el" href="RegisterToChannelNumber_8cpp_source.html">RegisterToChannelNumber.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   39</span>{</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span>  <span class="keyword">using </span><a class="code hl_enumvalue" href="namespacedunedaq_1_1datahandlinglibs_1_1logging.html#ab00a2bfcec741a6a6af343294645f23aaaf2b7dfc0a4ac135efd15050ddc4a74a">dunedaq::datahandlinglibs::logging::TLVL_BOOKKEEPING</a>;</div>
<div class="line"><span class="lineno">   42</span>  <span class="keyword">using </span><a class="code hl_enumvalue" href="namespacedunedaq_1_1datahandlinglibs_1_1logging.html#ab00a2bfcec741a6a6af343294645f23aa5f91b0fed65c060854fe86ff66b92123">dunedaq::datahandlinglibs::logging::TLVL_TAKE_NOTE</a>;</div>
<div class="line"><span class="lineno">   43</span> </div>
<div class="line"><span class="lineno">   44</span>  <span class="keyword">auto</span> start_time = std::chrono::steady_clock::now();</div>
<div class="line"><span class="lineno">   45</span> </div>
<div class="line"><span class="lineno">   46</span>  <span class="comment">// Find the lowest offline channel number of all the channels in the input frame</span></div>
<div class="line"><span class="lineno">   47</span>  uint min_ch = UINT_MAX;</div>
<div class="line"><span class="lineno">   48</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ich = 0; ich &lt; <a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#affb978644e55f7a4ca3ba5b770dc2c42">dunedaq::fddetdataformats::WIBEthFrame::s_channels_per_half_femb</a>; ++ich) {</div>
<div class="line"><span class="lineno">   49</span>    <span class="keyword">auto</span> offline_ch = ch_map-&gt;get_offline_channel_from_crate_slot_stream_chan(</div>
<div class="line"><span class="lineno">   50</span>      frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#ace5a8d625cd224e61bb818336daf34da">crate_id</a>, frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#a99d033aaae5d8c6903550c8ab450047b">slot_id</a>, frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#acd5f3d4d8d5d6c22811330d7b47f2d5e">stream_id</a>, ich);</div>
<div class="line"><span class="lineno">   51</span>    <span class="comment">//TLOG_DEBUG(TLVL_BOOKKEEPING) &lt;&lt; &quot; offline_ch &quot; &lt;&lt; offline_ch; </span></div>
<div class="line"><span class="lineno">   52</span>    min_ch = std::min(min_ch, offline_ch);</div>
<div class="line"><span class="lineno">   53</span>  }</div>
<div class="line"><span class="lineno">   54</span>  <a class="code hl_define" href="logging_2include_2logging_2internal_2macro_8hpp.html#a69dcfba03c6d43734c25d912a4f2288c">TLOG</a>() &lt;&lt; <span class="stringliteral">&quot;get_register_to_offline_channel_map_wibeth for crate &quot;</span> &lt;&lt; frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#ace5a8d625cd224e61bb818336daf34da">crate_id</a> &lt;&lt; <span class="stringliteral">&quot; slot &quot;</span></div>
<div class="line"><span class="lineno">   55</span>                &lt;&lt; frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#a99d033aaae5d8c6903550c8ab450047b">slot_id</a> &lt;&lt; <span class="stringliteral">&quot; stream &quot;</span> &lt;&lt; frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#acd5f3d4d8d5d6c22811330d7b47f2d5e">stream_id</a> &lt;&lt; <span class="stringliteral">&quot;. min_ch is &quot;</span></div>
<div class="line"><span class="lineno">   56</span>                &lt;&lt; min_ch;</div>
<div class="line"><span class="lineno">   57</span>  <span class="comment">// Now set each of the channels in our test frame to their</span></div>
<div class="line"><span class="lineno">   58</span>  <span class="comment">// corresponding offline channel number, minus the minimum channel</span></div>
<div class="line"><span class="lineno">   59</span>  <span class="comment">// number we just calculated (so we don&#39;t overflow the 12 bits we</span></div>
<div class="line"><span class="lineno">   60</span>  <span class="comment">// have available)</span></div>
<div class="line"><span class="lineno">   61</span>  <a class="code hl_struct" href="structdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter.html">dunedaq::fdreadoutlibs::types::DUNEWIBEthTypeAdapter</a> wibeth_frame;</div>
<div class="line"><span class="lineno">   62</span>  memset(wibeth_frame.<a class="code hl_variable" href="structdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter.html#acd471d0ee33251bd4520e655d08ce64b">data</a>, 0, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="structdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter.html">dunedaq::fdreadoutlibs::types::DUNEWIBEthTypeAdapter</a>));</div>
<div class="line"><span class="lineno">   63</span> </div>
<div class="line"><span class="lineno">   64</span>  <a class="code hl_class" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a>* test_frame =</div>
<div class="line"><span class="lineno">   65</span>    <span class="keyword">reinterpret_cast&lt;</span><a class="code hl_class" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a>*<span class="keyword">&gt;</span>(&amp;wibeth_frame);</div>
<div class="line"><span class="lineno">   66</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> time_sample = 0; time_sample &lt; <a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#ab41220f98184609f9c8f43f74efad3f4">dunedaq::fddetdataformats::WIBEthFrame::s_time_samples_per_frame</a>; ++time_sample) {  </div>
<div class="line"><span class="lineno">   67</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ich = 0; ich &lt; <a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#affb978644e55f7a4ca3ba5b770dc2c42">dunedaq::fddetdataformats::WIBEthFrame::s_channels_per_half_femb</a>; ++ich) { </div>
<div class="line"><span class="lineno">   68</span>      <span class="comment">//s_channels_per_half_femb is 64 because there is only one half FEMB</span></div>
<div class="line"><span class="lineno">   69</span>      <span class="keyword">auto</span> offline_ch = ch_map-&gt;get_offline_channel_from_crate_slot_stream_chan(</div>
<div class="line"><span class="lineno">   70</span>        frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#ace5a8d625cd224e61bb818336daf34da">crate_id</a>, frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#a99d033aaae5d8c6903550c8ab450047b">slot_id</a>, frame-&gt;<a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">daq_header</a>.<a class="code hl_variable" href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#acd5f3d4d8d5d6c22811330d7b47f2d5e">stream_id</a>, ich);</div>
<div class="line"><span class="lineno">   71</span>        test_frame-&gt;<a class="code hl_function" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a7336c300722cf0f38dd456cd1a212811">set_adc</a>(ich, time_sample, offline_ch - min_ch);</div>
<div class="line"><span class="lineno">   72</span>    }</div>
<div class="line"><span class="lineno">   73</span>  }</div>
<div class="line"><span class="lineno">   74</span> </div>
<div class="line"><span class="lineno">   75</span>  <span class="comment">// Expand the test frame, so the offline channel numbers are now in the relevant places in the output registers</span></div>
<div class="line"><span class="lineno">   76</span>  <a class="code hl_class" href="classswtpg__wibeth_1_1RegisterArray.html">swtpg_wibeth::MessageRegisters</a> register_array;</div>
<div class="line"><span class="lineno">   77</span>  <a class="code hl_function" href="namespaceswtpg__wibeth.html#a7ace901dccac1cb0bcb0826b2c948ddd">expand_wibeth_adcs</a>(&amp;wibeth_frame, &amp;register_array); </div>
<div class="line"><span class="lineno">   78</span> </div>
<div class="line"><span class="lineno">   79</span> </div>
<div class="line"><span class="lineno">   80</span>  RegisterChannelMap <a class="code hl_variable" href="namespacecheckLinks.html#a54e97434ff6ffa7352831fbf2a93c0c3">ret</a>;</div>
<div class="line"><span class="lineno">   81</span> </div>
<div class="line"><span class="lineno">   82</span>  <span class="comment">// Define the following variables for convenience</span></div>
<div class="line"><span class="lineno">   83</span>  <span class="comment">//int NREGISTERS = swtpg_wibeth::NUM_REGISTERS_PER_FRAME;</span></div>
<div class="line"><span class="lineno">   84</span>  <span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> = <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">swtpg_wibeth::SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">   85</span>  <span class="keywordtype">int</span> TIME_WINDOW_NUM_FRAMES = <a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#ab41220f98184609f9c8f43f74efad3f4">dunedaq::fddetdataformats::WIBEthFrame::s_time_samples_per_frame</a>;</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0;  i &lt; <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">swtpg_wibeth::NUM_REGISTERS_PER_FRAME</a> * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">swtpg_wibeth::SAMPLES_PER_REGISTER</a>; ++i) {</div>
<div class="line"><span class="lineno">   88</span>    <span class="comment">// expand_message_adcs_inplace reorders the output so</span></div>
<div class="line"><span class="lineno">   89</span>    <span class="comment">// adjacent-in-time registers are adjacent in memory, hence the</span></div>
<div class="line"><span class="lineno">   90</span>    <span class="comment">// need for this indexing. See the comment in that function for a</span></div>
<div class="line"><span class="lineno">   91</span>    <span class="comment">// diagram</span></div>
<div class="line"><span class="lineno">   92</span> </div>
<div class="line"><span class="lineno">   93</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_offset = i % <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">   94</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_index = i / <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">   95</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_t0_start = register_index * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * TIME_WINDOW_NUM_FRAMES;</div>
<div class="line"><span class="lineno">   96</span> </div>
<div class="line"><span class="lineno">   97</span>    <span class="comment">// AAA: in this function we only want the offline channel number</span></div>
<div class="line"><span class="lineno">   98</span>    <span class="comment">// so we do not care about the other time samples in the frame</span></div>
<div class="line"><span class="lineno">   99</span>    <span class="comment">// that&#39;s why itime is zero</span></div>
<div class="line"><span class="lineno">  100</span>    <span class="keywordtype">size_t</span> itime = 0; </div>
<div class="line"><span class="lineno">  101</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_index = itime / TIME_WINDOW_NUM_FRAMES;</div>
<div class="line"><span class="lineno">  102</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_time_offset = itime % TIME_WINDOW_NUM_FRAMES;</div>
<div class="line"><span class="lineno">  103</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_start_index = msg_index * (<a class="code hl_variable" href="namespaceswtpg__wibeth.html#a61ae264aec55185352ee186b065b92a1">swtpg_wibeth::ADCS_SIZE</a>) / <span class="keyword">sizeof</span>(uint16_t); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  104</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> offset_within_msg = register_t0_start + <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * msg_time_offset + register_offset;</div>
<div class="line"><span class="lineno">  105</span> </div>
<div class="line"><span class="lineno">  106</span>    <span class="comment">// The index in uint16_t of the start of the message we want. </span></div>
<div class="line"><span class="lineno">  107</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code hl_function" href="namespacerecv-restcmd.html#a50db3136ef77b352e83971470ef33d17">index</a> = msg_start_index + offset_within_msg;</div>
<div class="line"><span class="lineno">  108</span>    int16_t out_val = register_array.<a class="code hl_function" href="classswtpg__wibeth_1_1RegisterArray.html#a08f834300cfa5168469618088fb4d275">uint16</a>(index);</div>
<div class="line"><span class="lineno">  109</span>    <a class="code hl_variable" href="namespacecheckLinks.html#a54e97434ff6ffa7352831fbf2a93c0c3">ret</a>.channel[i] = out_val + min_ch;</div>
<div class="line"><span class="lineno">  110</span> </div>
<div class="line"><span class="lineno">  111</span>    <span class="comment">//std::cout &lt;&lt; &quot; index: &quot; &lt;&lt; index &lt;&lt; &quot;    value:   &quot; &lt;&lt; out_val &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">  112</span> </div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span> </div>
<div class="line"><span class="lineno">  115</span>  }</div>
<div class="line"><span class="lineno">  116</span> </div>
<div class="line"><span class="lineno">  117</span>  <span class="keyword">auto</span> end_time = std::chrono::steady_clock::now();</div>
<div class="line"><span class="lineno">  118</span>  <span class="keyword">auto</span> dur = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(end_time - start_time).count();</div>
<div class="line"><span class="lineno">  119</span>  <a class="code hl_define" href="logging_2include_2logging_2Logging_8hpp.html#a8c6732348bcdf3758aac3d18eb3995b9">TLOG_DEBUG</a>(TLVL_BOOKKEEPING) &lt;&lt; <span class="stringliteral">&quot;get_register_to_offline_channel_map_wibeth built map in &quot;</span> &lt;&lt; dur &lt;&lt; <span class="stringliteral">&quot;us&quot;</span>;</div>
<div class="line"><span class="lineno">  120</span>  <span class="keywordflow">return</span> <a class="code hl_variable" href="namespacecheckLinks.html#a54e97434ff6ffa7352831fbf2a93c0c3">ret</a>;</div>
<div class="line"><span class="lineno">  121</span>}</div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html_a7336c300722cf0f38dd456cd1a212811"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a7336c300722cf0f38dd456cd1a212811">dunedaq::fddetdataformats::WIBEthFrame::set_adc</a></div><div class="ttdeci">void set_adc(int i, int sample, uint16_t val)</div><div class="ttdoc">Set the ith ADC value in the frame to val.</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00121">WIBEthFrame.hpp:121</a></div></div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html_a98520678bbb554b40d68031dfd570061"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#a98520678bbb554b40d68031dfd570061">dunedaq::fddetdataformats::WIBEthFrame::daq_header</a></div><div class="ttdeci">detdataformats::DAQEthHeader daq_header</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00077">WIBEthFrame.hpp:77</a></div></div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html_ab41220f98184609f9c8f43f74efad3f4"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#ab41220f98184609f9c8f43f74efad3f4">dunedaq::fddetdataformats::WIBEthFrame::s_time_samples_per_frame</a></div><div class="ttdeci">static constexpr int s_time_samples_per_frame</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00045">WIBEthFrame.hpp:45</a></div></div>
<div class="ttc" id="aclassdunedaq_1_1fddetdataformats_1_1WIBEthFrame_html_affb978644e55f7a4ca3ba5b770dc2c42"><div class="ttname"><a href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#affb978644e55f7a4ca3ba5b770dc2c42">dunedaq::fddetdataformats::WIBEthFrame::s_channels_per_half_femb</a></div><div class="ttdeci">static constexpr int s_channels_per_half_femb</div><div class="ttdef"><b>Definition</b> <a href="WIBEthFrame_8hpp_source.html#l00046">WIBEthFrame.hpp:46</a></div></div>
<div class="ttc" id="aclassswtpg__wibeth_1_1RegisterArray_html"><div class="ttname"><a href="classswtpg__wibeth_1_1RegisterArray.html">swtpg_wibeth::RegisterArray</a></div><div class="ttdef"><b>Definition</b> <a href="FrameExpand_8hpp_source.html#l00025">FrameExpand.hpp:26</a></div></div>
<div class="ttc" id="aclassswtpg__wibeth_1_1RegisterArray_html_a08f834300cfa5168469618088fb4d275"><div class="ttname"><a href="classswtpg__wibeth_1_1RegisterArray.html#a08f834300cfa5168469618088fb4d275">swtpg_wibeth::RegisterArray::uint16</a></div><div class="ttdeci">uint16_t uint16(size_t i) const</div><div class="ttdef"><b>Definition</b> <a href="FrameExpand_8hpp_source.html#l00046">FrameExpand.hpp:46</a></div></div>
<div class="ttc" id="alogging_2include_2logging_2Logging_8hpp_html_a8c6732348bcdf3758aac3d18eb3995b9"><div class="ttname"><a href="logging_2include_2logging_2Logging_8hpp.html#a8c6732348bcdf3758aac3d18eb3995b9">TLOG_DEBUG</a></div><div class="ttdeci">#define TLOG_DEBUG(lvl,...)</div><div class="ttdef"><b>Definition</b> <a href="logging_2include_2logging_2Logging_8hpp_source.html#l00112">Logging.hpp:112</a></div></div>
<div class="ttc" id="alogging_2include_2logging_2internal_2macro_8hpp_html_a69dcfba03c6d43734c25d912a4f2288c"><div class="ttname"><a href="logging_2include_2logging_2internal_2macro_8hpp.html#a69dcfba03c6d43734c25d912a4f2288c">TLOG</a></div><div class="ttdeci">#define TLOG(...)</div><div class="ttdef"><b>Definition</b> <a href="logging_2include_2logging_2internal_2macro_8hpp_source.html#l00022">macro.hpp:22</a></div></div>
<div class="ttc" id="anamespacedunedaq_1_1datahandlinglibs_1_1logging_html_ab00a2bfcec741a6a6af343294645f23aa5f91b0fed65c060854fe86ff66b92123"><div class="ttname"><a href="namespacedunedaq_1_1datahandlinglibs_1_1logging.html#ab00a2bfcec741a6a6af343294645f23aa5f91b0fed65c060854fe86ff66b92123">dunedaq::datahandlinglibs::logging::TLVL_TAKE_NOTE</a></div><div class="ttdeci">@ TLVL_TAKE_NOTE</div><div class="ttdef"><b>Definition</b> <a href="ReadoutLogging_8hpp_source.html#l00021">ReadoutLogging.hpp:21</a></div></div>
<div class="ttc" id="anamespacedunedaq_1_1datahandlinglibs_1_1logging_html_ab00a2bfcec741a6a6af343294645f23aaaf2b7dfc0a4ac135efd15050ddc4a74a"><div class="ttname"><a href="namespacedunedaq_1_1datahandlinglibs_1_1logging.html#ab00a2bfcec741a6a6af343294645f23aaaf2b7dfc0a4ac135efd15050ddc4a74a">dunedaq::datahandlinglibs::logging::TLVL_BOOKKEEPING</a></div><div class="ttdeci">@ TLVL_BOOKKEEPING</div><div class="ttdef"><b>Definition</b> <a href="ReadoutLogging_8hpp_source.html#l00026">ReadoutLogging.hpp:26</a></div></div>
<div class="ttc" id="anamespacerecv-restcmd_html_a50db3136ef77b352e83971470ef33d17"><div class="ttname"><a href="namespacerecv-restcmd.html#a50db3136ef77b352e83971470ef33d17">recv-restcmd.index</a></div><div class="ttdeci">index()</div><div class="ttdef"><b>Definition</b> <a href="recv-restcmd_8py_source.html#l00014">recv-restcmd.py:14</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a35bc84983ac065eb2d0981e169ea3f61"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">swtpg_wibeth::NUM_REGISTERS_PER_FRAME</a></div><div class="ttdeci">const constexpr std::size_t NUM_REGISTERS_PER_FRAME</div><div class="ttdef"><b>Definition</b> <a href="TPGConstants__wibeth_8hpp_source.html#l00025">TPGConstants_wibeth.hpp:25</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a61ae264aec55185352ee186b065b92a1"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a61ae264aec55185352ee186b065b92a1">swtpg_wibeth::ADCS_SIZE</a></div><div class="ttdeci">const constexpr std::size_t ADCS_SIZE</div><div class="ttdef"><b>Definition</b> <a href="TPGConstants__wibeth_8hpp_source.html#l00036">TPGConstants_wibeth.hpp:36</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a65e5e08d51fb120e9f5566ed5d578df6"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">swtpg_wibeth::SAMPLES_PER_REGISTER</a></div><div class="ttdeci">const constexpr std::size_t SAMPLES_PER_REGISTER</div><div class="ttdef"><b>Definition</b> <a href="TPGConstants__wibeth_8hpp_source.html#l00031">TPGConstants_wibeth.hpp:31</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a7ace901dccac1cb0bcb0826b2c948ddd"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a7ace901dccac1cb0bcb0826b2c948ddd">swtpg_wibeth::expand_wibeth_adcs</a></div><div class="ttdeci">void expand_wibeth_adcs(const dunedaq::fdreadoutlibs::types::DUNEWIBEthTypeAdapter *__restrict__ ucs, swtpg_wibeth::MessageRegisters *__restrict__ register_array)</div><div class="ttdef"><b>Definition</b> <a href="FrameExpand_8hpp_source.html#l00193">FrameExpand.hpp:193</a></div></div>
<div class="ttc" id="astructdunedaq_1_1detdataformats_1_1DAQEthHeader_html_a99d033aaae5d8c6903550c8ab450047b"><div class="ttname"><a href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#a99d033aaae5d8c6903550c8ab450047b">dunedaq::detdataformats::DAQEthHeader::slot_id</a></div><div class="ttdeci">word_t slot_id</div><div class="ttdef"><b>Definition</b> <a href="DAQEthHeader_8hpp_source.html#l00025">DAQEthHeader.hpp:25</a></div></div>
<div class="ttc" id="astructdunedaq_1_1detdataformats_1_1DAQEthHeader_html_acd5f3d4d8d5d6c22811330d7b47f2d5e"><div class="ttname"><a href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#acd5f3d4d8d5d6c22811330d7b47f2d5e">dunedaq::detdataformats::DAQEthHeader::stream_id</a></div><div class="ttdeci">word_t stream_id</div><div class="ttdef"><b>Definition</b> <a href="DAQEthHeader_8hpp_source.html#l00025">DAQEthHeader.hpp:25</a></div></div>
<div class="ttc" id="astructdunedaq_1_1detdataformats_1_1DAQEthHeader_html_ace5a8d625cd224e61bb818336daf34da"><div class="ttname"><a href="structdunedaq_1_1detdataformats_1_1DAQEthHeader.html#ace5a8d625cd224e61bb818336daf34da">dunedaq::detdataformats::DAQEthHeader::crate_id</a></div><div class="ttdeci">word_t crate_id</div><div class="ttdef"><b>Definition</b> <a href="DAQEthHeader_8hpp_source.html#l00025">DAQEthHeader.hpp:25</a></div></div>
<div class="ttc" id="astructdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter_html"><div class="ttname"><a href="structdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter.html">dunedaq::fdreadoutlibs::types::DUNEWIBEthTypeAdapter</a></div><div class="ttdef"><b>Definition</b> <a href="DUNEWIBEthTypeAdapter_8hpp_source.html#l00023">DUNEWIBEthTypeAdapter.hpp:24</a></div></div>
<div class="ttc" id="astructdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter_html_acd471d0ee33251bd4520e655d08ce64b"><div class="ttname"><a href="structdunedaq_1_1fdreadoutlibs_1_1types_1_1DUNEWIBEthTypeAdapter.html#acd471d0ee33251bd4520e655d08ce64b">dunedaq::fdreadoutlibs::types::DUNEWIBEthTypeAdapter::data</a></div><div class="ttdeci">char data[kDUNEWIBEthSize]</div><div class="ttdef"><b>Definition</b> <a href="DUNEWIBEthTypeAdapter_8hpp_source.html#l00027">DUNEWIBEthTypeAdapter.hpp:27</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aed08777792686dd83a98894bf8518ced" name="aed08777792686dd83a98894bf8518ced"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed08777792686dd83a98894bf8518ced">&#9670;&#160;</a></span>get_register_to_offline_channel_map_wibeth() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structswtpg__wibeth_1_1RegisterChannelMap.html">RegisterChannelMap</a> swtpg_wibeth::get_register_to_offline_channel_map_wibeth </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html">dunedaq::fddetdataformats::WIBEthFrame</a> *&#160;</td>
          <td class="paramname"><em>frame</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::string&#160;</td>
          <td class="paramname"><em>channel_map_name</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="RegisterToChannelNumber_8cpp_source.html#l00124">124</a> of file <a class="el" href="RegisterToChannelNumber_8cpp_source.html">RegisterToChannelNumber.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  128</span>{</div>
<div class="line"><span class="lineno">  129</span>  <span class="keyword">auto</span> ch_map = dunedaq::detchannelmaps::make_map(channel_map_name);</div>
<div class="line"><span class="lineno">  130</span>  <span class="keywordflow">return</span> <a class="code hl_function" href="namespaceswtpg__wibeth.html#a3cbf620849b300901d9348523eca2c23">get_register_to_offline_channel_map_wibeth</a>(frame, ch_map);</div>
<div class="line"><span class="lineno">  131</span>}</div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a3cbf620849b300901d9348523eca2c23"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a3cbf620849b300901d9348523eca2c23">swtpg_wibeth::get_register_to_offline_channel_map_wibeth</a></div><div class="ttdeci">RegisterChannelMap get_register_to_offline_channel_map_wibeth(const dunedaq::fddetdataformats::WIBEthFrame *frame, std::shared_ptr&lt; dunedaq::detchannelmaps::TPCChannelMap &gt; &amp;ch_map)</div><div class="ttdef"><b>Definition</b> <a href="RegisterToChannelNumber_8cpp_source.html#l00036">RegisterToChannelNumber.cpp:36</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aa93821b1fdeb769b062c8ee015125891" name="aa93821b1fdeb769b062c8ee015125891"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa93821b1fdeb769b062c8ee015125891">&#9670;&#160;</a></span>hamming()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt; double &gt; swtpg_wibeth::hamming </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>M</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="DesignFIR_8cpp_source.html#l00021">21</a> of file <a class="el" href="DesignFIR_8cpp_source.html">DesignFIR.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   22</span>{</div>
<div class="line"><span class="lineno">   23</span>  std::vector&lt;double&gt; ret;</div>
<div class="line"><span class="lineno">   24</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 0; n &lt; M; ++n) {</div>
<div class="line"><span class="lineno">   25</span>    ret.push_back(0.54 - 0.46 * cos(2.0 * <a class="code hl_function" href="namespaceswtpg__wibeth.html#a847682637d862f1382e530153f94a5c0">swtpg_wibeth::pi</a>() * n / (M - 1)));</div>
<div class="line"><span class="lineno">   26</span>  }</div>
<div class="line"><span class="lineno">   27</span>  <span class="keywordflow">return</span> ret;</div>
<div class="line"><span class="lineno">   28</span>}</div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a847682637d862f1382e530153f94a5c0"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a847682637d862f1382e530153f94a5c0">swtpg_wibeth::pi</a></div><div class="ttdeci">constexpr double pi()</div><div class="ttdef"><b>Definition</b> <a href="DesignFIR_8hpp_source.html#l00022">DesignFIR.hpp:22</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a7c441e5c1080316199d1d9e19847b389" name="a7c441e5c1080316199d1d9e19847b389"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7c441e5c1080316199d1d9e19847b389">&#9670;&#160;</a></span>parse_wibeth_adcs()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::parse_wibeth_adcs </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="namespaceswtpg__wibeth.html#a3c505dbafbef97828b340152ec4d1009">swtpg_wibeth::MessageRegisters</a> *__restrict__&#160;</td>
          <td class="paramname"><em>register_array</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8hpp_source.html#l00252">252</a> of file <a class="el" href="FrameExpand_8hpp_source.html">FrameExpand.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  253</span>{</div>
<div class="line"><span class="lineno">  254</span>  <span class="keywordtype">size_t</span> NREGISTERS = <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">swtpg_wibeth::NUM_REGISTERS_PER_FRAME</a>;</div>
<div class="line"><span class="lineno">  255</span>  <span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> = <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">swtpg_wibeth::SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">  256</span>  <span class="keywordtype">size_t</span> TIME_WINDOW_NUM_FRAMES = <a class="code hl_variable" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#ab41220f98184609f9c8f43f74efad3f4">dunedaq::fddetdataformats::WIBEthFrame::s_time_samples_per_frame</a>;</div>
<div class="line"><span class="lineno">  257</span> </div>
<div class="line"><span class="lineno">  258</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; NREGISTERS * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>; ++j) {</div>
<div class="line"><span class="lineno">  259</span> </div>
<div class="line"><span class="lineno">  260</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_offset = j % <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">  261</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_index = j / <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">  262</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_t0_start = register_index * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * TIME_WINDOW_NUM_FRAMES;</div>
<div class="line"><span class="lineno">  263</span>    int16_t out_val;</div>
<div class="line"><span class="lineno">  264</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> itime = 0; itime &lt; TIME_WINDOW_NUM_FRAMES; ++itime) {</div>
<div class="line"><span class="lineno">  265</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_index = itime / TIME_WINDOW_NUM_FRAMES;</div>
<div class="line"><span class="lineno">  266</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_time_offset = itime % TIME_WINDOW_NUM_FRAMES;</div>
<div class="line"><span class="lineno">  267</span> </div>
<div class="line"><span class="lineno">  268</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_start_index = msg_index * (<a class="code hl_variable" href="namespaceswtpg__wibeth.html#a61ae264aec55185352ee186b065b92a1">swtpg_wibeth::ADCS_SIZE</a>) / <span class="keyword">sizeof</span>(uint16_t); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  269</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> offset_within_msg = register_t0_start + <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * msg_time_offset + register_offset;</div>
<div class="line"><span class="lineno">  270</span>      <span class="comment">// The index in uint16_t of the start of the message we want. </span></div>
<div class="line"><span class="lineno">  271</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> index = msg_start_index + offset_within_msg;</div>
<div class="line"><span class="lineno">  272</span>      <span class="comment">//const uint16_t* input16 = unpacked.data(); // NOLINT</span></div>
<div class="line"><span class="lineno">  273</span>      <span class="comment">//out_val = input16[index]</span></div>
<div class="line"><span class="lineno">  274</span>      out_val = register_array-&gt;<a class="code hl_function" href="classswtpg__wibeth_1_1RegisterArray.html#a08f834300cfa5168469618088fb4d275">uint16</a>(index);</div>
<div class="line"><span class="lineno">  275</span> </div>
<div class="line"><span class="lineno">  276</span>      <span class="keywordflow">if</span> (itime  == 0) {</div>
<div class="line"><span class="lineno">  277</span>        <span class="comment">//std::cout &lt;&lt; &quot;register_offset: &quot; &lt;&lt; register_offset &lt;&lt; &quot; register_index: &quot; &lt;&lt; register_index &lt;&lt; &quot; register_t0_start: &quot; &lt;&lt; register_t0_start &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">  278</span>        <span class="comment">//std::cout &lt;&lt; &quot;msg_index: &quot; &lt;&lt; msg_index &lt;&lt; &quot; msg_time_offset: &quot; &lt;&lt; msg_time_offset &lt;&lt; &quot; msg_start_index: &quot; &lt;&lt; msg_start_index &lt;&lt; &quot; offset_within_msg: &quot; &lt;&lt; offset_within_msg &lt;&lt; &quot; index: &quot; &lt;&lt; index &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">  279</span>        std::cout &lt;&lt; <span class="stringliteral">&quot;channel: &quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot; time_sample: &quot;</span> &lt;&lt; itime &lt;&lt; <span class="stringliteral">&quot; index_output: &quot;</span> &lt;&lt; index &lt;&lt; <span class="stringliteral">&quot;    value:   &quot;</span> &lt;&lt; out_val &lt;&lt; std::endl;</div>
<div class="line"><span class="lineno">  280</span>        std::cout &lt;&lt; <span class="stringliteral">&quot;============&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><span class="lineno">  281</span>      }</div>
<div class="line"><span class="lineno">  282</span> </div>
<div class="line"><span class="lineno">  283</span>    }</div>
<div class="line"><span class="lineno">  284</span>  }</div>
<div class="line"><span class="lineno">  285</span> </div>
<div class="line"><span class="lineno">  286</span> </div>
<div class="line"><span class="lineno">  287</span> </div>
<div class="line"><span class="lineno">  288</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a847682637d862f1382e530153f94a5c0" name="a847682637d862f1382e530153f94a5c0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a847682637d862f1382e530153f94a5c0">&#9670;&#160;</a></span>pi()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">constexpr double swtpg_wibeth::pi </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="DesignFIR_8hpp_source.html#l00022">22</a> of file <a class="el" href="DesignFIR_8hpp_source.html">DesignFIR.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   23</span>{</div>
<div class="line"><span class="lineno">   24</span>  <span class="keywordflow">return</span> std::atan(1) * 4;</div>
<div class="line"><span class="lineno">   25</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a030e7d1bf33810eef23881b0d7dc90b1" name="a030e7d1bf33810eef23881b0d7dc90b1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a030e7d1bf33810eef23881b0d7dc90b1">&#9670;&#160;</a></span>print256()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::print256 </td>
          <td>(</td>
          <td class="paramtype">__m256i&#160;</td>
          <td class="paramname"><em>var</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8cpp_source.html#l00017">17</a> of file <a class="el" href="FrameExpand_8cpp_source.html">FrameExpand.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   18</span>{</div>
<div class="line"><span class="lineno">   19</span>  uint8_t* val = (uint8_t*)&amp;var; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   20</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 32; ++i)</div>
<div class="line"><span class="lineno">   21</span>    printf(<span class="stringliteral">&quot;%02x &quot;</span>, val[i]); <span class="comment">// NOLINT(runtime/output_format)</span></div>
<div class="line"><span class="lineno">   22</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acf24c544eafe9ef300b2e084639bf323" name="acf24c544eafe9ef300b2e084639bf323"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acf24c544eafe9ef300b2e084639bf323">&#9670;&#160;</a></span>print256_as16()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::print256_as16 </td>
          <td>(</td>
          <td class="paramtype">__m256i&#160;</td>
          <td class="paramname"><em>var</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8cpp_source.html#l00037">37</a> of file <a class="el" href="FrameExpand_8cpp_source.html">FrameExpand.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   38</span>{</div>
<div class="line"><span class="lineno">   39</span>  uint16_t* val = (uint16_t*)&amp;var; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   40</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 16; ++i)</div>
<div class="line"><span class="lineno">   41</span>    printf(<span class="stringliteral">&quot;%04x &quot;</span>, val[i]); <span class="comment">// NOLINT(runtime/output_format)</span></div>
<div class="line"><span class="lineno">   42</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="adfeea1783a8a114dc678104a15f7974c" name="adfeea1783a8a114dc678104a15f7974c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adfeea1783a8a114dc678104a15f7974c">&#9670;&#160;</a></span>print256_as16_dec()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::print256_as16_dec </td>
          <td>(</td>
          <td class="paramtype">__m256i&#160;</td>
          <td class="paramname"><em>var</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8cpp_source.html#l00047">47</a> of file <a class="el" href="FrameExpand_8cpp_source.html">FrameExpand.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   48</span>{</div>
<div class="line"><span class="lineno">   49</span>  int16_t* val = (int16_t*)&amp;var; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   50</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 16; ++i)</div>
<div class="line"><span class="lineno">   51</span>    printf(<span class="stringliteral">&quot;%+6d &quot;</span>, val[i]); <span class="comment">// NOLINT(runtime/output_format)</span></div>
<div class="line"><span class="lineno">   52</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a7f2ba1d5fc86a0db73bd77e077ec6997" name="a7f2ba1d5fc86a0db73bd77e077ec6997"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7f2ba1d5fc86a0db73bd77e077ec6997">&#9670;&#160;</a></span>printr256()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::printr256 </td>
          <td>(</td>
          <td class="paramtype">__m256i&#160;</td>
          <td class="paramname"><em>var</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8cpp_source.html#l00027">27</a> of file <a class="el" href="FrameExpand_8cpp_source.html">FrameExpand.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   28</span>{</div>
<div class="line"><span class="lineno">   29</span>  uint8_t* val = (uint8_t*)&amp;var; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   30</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 31; i &gt;= 0; --i)</div>
<div class="line"><span class="lineno">   31</span>    printf(<span class="stringliteral">&quot;%02x &quot;</span>, val[i]); <span class="comment">// NOLINT(runtime/output_format)</span></div>
<div class="line"><span class="lineno">   32</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ac7d721395ca97161451f878e2cf23630" name="ac7d721395ca97161451f878e2cf23630"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac7d721395ca97161451f878e2cf23630">&#9670;&#160;</a></span>process_window_avx2()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;size_t NREGISTERS&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::process_window_avx2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;&#160;</td>
          <td class="paramname"><em>info</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="ProcessAVX2_8hpp_source.html#l00025">25</a> of file <a class="el" href="ProcessAVX2_8hpp_source.html">ProcessAVX2.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   26</span>{</div>
<div class="line"><span class="lineno">   27</span>  <span class="keyword">const</span> __m256i overflowMax = _mm256_set1_epi16(INT16_MAX);</div>
<div class="line"><span class="lineno">   28</span> </div>
<div class="line"><span class="lineno">   29</span>  <span class="comment">// Pointer to keep track of where we&#39;ll write the next output hit</span></div>
<div class="line"><span class="lineno">   30</span>  __m256i* output_loc = (__m256i*)(info.output); <span class="comment">// NOLINT(readability/casting)</span></div>
<div class="line"><span class="lineno">   31</span> </div>
<div class="line"><span class="lineno">   32</span>  <span class="keyword">const</span> __m256i iota = _mm256_set_epi16(14, 13, 12, 11, 10, 9, 8, 15, 7, 6, 5, 4, 3, 2, 1, 0);</div>
<div class="line"><span class="lineno">   33</span> </div>
<div class="line"><span class="lineno">   34</span>  <span class="keywordtype">int</span> nhits = 0;</div>
<div class="line"><span class="lineno">   35</span> </div>
<div class="line"><span class="lineno">   36</span>  <span class="keywordflow">for</span> (uint16_t ireg = info.first_register; ireg &lt; info.last_register; ++ireg) { <span class="comment">// NOLINT(build/unsigned)</span></div>
<div class="line"><span class="lineno">   37</span> </div>
<div class="line"><span class="lineno">   38</span>    <span class="comment">// ------------------------------------</span></div>
<div class="line"><span class="lineno">   39</span>    <span class="comment">// Variables for pedestal subtraction</span></div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span>    <span class="comment">// The current estimate of the pedestal in each channel: get</span></div>
<div class="line"><span class="lineno">   42</span>    <span class="comment">// from the previous go-around.</span></div>
<div class="line"><span class="lineno">   43</span> </div>
<div class="line"><span class="lineno">   44</span>    <a class="code hl_struct" href="structswtpg__wibeth_1_1ChanState.html">ChanState&lt;NREGISTERS&gt;</a>&amp; state = info.chanState;</div>
<div class="line"><span class="lineno">   45</span>    __m256i median = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>) + ireg);      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   46</span>    <span class="comment">// The accumulator that we increase/decrease when the current</span></div>
<div class="line"><span class="lineno">   47</span>    <span class="comment">// sample is greater/less than the median</span></div>
<div class="line"><span class="lineno">   48</span>    __m256i accum = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   49</span> </div>
<div class="line"><span class="lineno">   50</span>    <span class="comment">// ------------------------------------</span></div>
<div class="line"><span class="lineno">   51</span>    <span class="comment">// Variables for hit finding</span></div>
<div class="line"><span class="lineno">   52</span> </div>
<div class="line"><span class="lineno">   53</span>    <span class="comment">// Was the previous step over threshold?</span></div>
<div class="line"><span class="lineno">   54</span>    __m256i prev_was_over = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   55</span>    <span class="comment">// The integrated charge (so far) of the current hit</span></div>
<div class="line"><span class="lineno">   56</span>    __m256i hit_charge = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   57</span>    <span class="comment">// The time-over-threshold (so far) of the current hit</span></div>
<div class="line"><span class="lineno">   58</span>    __m256i hit_tover = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   59</span> </div>
<div class="line"><span class="lineno">   60</span>    <span class="comment">// The peak adc value</span></div>
<div class="line"><span class="lineno">   61</span>    __m256i hit_peak_adc = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   63</span>    <span class="comment">// The time of the peak of the current hit</span></div>
<div class="line"><span class="lineno">   64</span>    __m256i hit_peak_time = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   65</span> </div>
<div class="line"><span class="lineno">   66</span>    <span class="comment">// The channel numbers in each of the slots in the register</span></div>
<div class="line"><span class="lineno">   67</span>    __m256i channel_base = _mm256_set1_epi16(ireg * SAMPLES_PER_REGISTER);</div>
<div class="line"><span class="lineno">   68</span>    __m256i channels = _mm256_add_epi16(channel_base, iota);</div>
<div class="line"><span class="lineno">   69</span> </div>
<div class="line"><span class="lineno">   70</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> itime = 0; itime &lt; info.timeWindowNumFrames; ++itime) {</div>
<div class="line"><span class="lineno">   71</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_index = itime / info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">   72</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_time_offset = itime % info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">   73</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> index = msg_index * NREGISTERS * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a> + <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a> * ireg + msg_time_offset;</div>
<div class="line"><span class="lineno">   74</span>      <span class="comment">// const __m256i* rawp=reinterpret_cast&lt;const __m256i*&gt;(info.input)+index; // NOLINT</span></div>
<div class="line"><span class="lineno">   75</span> </div>
<div class="line"><span class="lineno">   76</span>      <span class="comment">// The current sample</span></div>
<div class="line"><span class="lineno">   77</span>      __m256i s = info.input-&gt;ymm(index);</div>
<div class="line"><span class="lineno">   78</span>      <span class="comment">//printf(&quot;raw ADC:          &quot;); print256_as16_dec(s);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">   79</span> </div>
<div class="line"><span class="lineno">   80</span><span class="preprocessor">#pragma GCC diagnostic push</span></div>
<div class="line"><span class="lineno">   81</span><span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Woverflow&quot;</span></div>
<div class="line"><span class="lineno">   82</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#a735ab62c0ab75097f18a50bd37089c21">swtpg_wibeth::frugal_accum_update_avx2</a>(median, s, accum, 10, _mm256_set1_epi16(0xffff));</div>
<div class="line"><span class="lineno">   83</span><span class="preprocessor">#pragma GCC diagnostic pop</span></div>
<div class="line"><span class="lineno">   84</span>      <span class="comment">// Actually subtract the pedestal</span></div>
<div class="line"><span class="lineno">   85</span>      s = _mm256_sub_epi16(s, median);</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>      <span class="comment">// Don&#39;t let the sample exceed adcMax, which is the value</span></div>
<div class="line"><span class="lineno">   88</span>      <span class="comment">// at which its filtered version might overflow</span></div>
<div class="line"><span class="lineno">   89</span>      <span class="comment">//s = _mm256_min_epi16(s, overflowMax);</span></div>
<div class="line"><span class="lineno">   90</span> </div>
<div class="line"><span class="lineno">   91</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   92</span>      <span class="comment">// Hit finding</span></div>
<div class="line"><span class="lineno">   93</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   94</span>      <span class="comment">// Mask for channels that are over the threshold in this step</span></div>
<div class="line"><span class="lineno">   95</span>      </div>
<div class="line"><span class="lineno">   96</span>      <span class="comment">// FIXED THRESHOLD</span></div>
<div class="line"><span class="lineno">   97</span>      __m256i threshold = _mm256_set1_epi16(info.threshold);</div>
<div class="line"><span class="lineno">   98</span>      __m256i is_over = _mm256_cmpgt_epi16(s, threshold);</div>
<div class="line"><span class="lineno">   99</span> </div>
<div class="line"><span class="lineno">  100</span>      <span class="comment">// Mask for channels that left &quot;over threshold&quot; state this step</span></div>
<div class="line"><span class="lineno">  101</span>      <span class="comment">// Comparison with previous TP</span></div>
<div class="line"><span class="lineno">  102</span>      __m256i left = _mm256_andnot_si256(is_over, prev_was_over);</div>
<div class="line"><span class="lineno">  103</span> </div>
<div class="line"><span class="lineno">  104</span>      <span class="comment">//-----------------------------------------</span></div>
<div class="line"><span class="lineno">  105</span>      <span class="comment">// Update hit start times for the channels where a hit started</span></div>
<div class="line"><span class="lineno">  106</span>      <span class="comment">//const __m256i timenow = _mm256_set1_epi16(itime);</span></div>
<div class="line"><span class="lineno">  107</span>      <span class="keyword">const</span> __m256i timenow = _mm256_set1_epi16(itime);</div>
<div class="line"><span class="lineno">  108</span>      <span class="comment">//-----------------------------------------</span></div>
<div class="line"><span class="lineno">  109</span>      <span class="comment">// Accumulate charge and time-over-threshold in the is_over channels</span></div>
<div class="line"><span class="lineno">  110</span> </div>
<div class="line"><span class="lineno">  111</span>      <span class="comment">// Really want an epi16 version of this, but the cmpgt and</span></div>
<div class="line"><span class="lineno">  112</span>      <span class="comment">// cmplt functions set their epi16 parts to 0xff or 0x0,</span></div>
<div class="line"><span class="lineno">  113</span>      <span class="comment">// so treating everything as epi8 works the same</span></div>
<div class="line"><span class="lineno">  114</span>      __m256i to_add_charge = _mm256_blendv_epi8(_mm256_set1_epi16(0), s, is_over);</div>
<div class="line"><span class="lineno">  115</span>      hit_charge = _mm256_add_epi16(hit_charge, to_add_charge);</div>
<div class="line"><span class="lineno">  116</span> </div>
<div class="line"><span class="lineno">  117</span>      <span class="comment">// Avoid overflow of the hit charge, if needed in practice </span></div>
<div class="line"><span class="lineno">  118</span>      hit_charge = _mm256_min_epi16(hit_charge, overflowMax);</div>
<div class="line"><span class="lineno">  119</span> </div>
<div class="line"><span class="lineno">  120</span>      <span class="comment">//if(ireg==0){</span></div>
<div class="line"><span class="lineno">  121</span>      <span class="comment">//     printf(&quot;itime=%ld\n&quot;, itime);</span></div>
<div class="line"><span class="lineno">  122</span>      <span class="comment">//     printf(&quot;ADC value:             &quot;); print256_as16_dec(s);             printf(&quot;\n\n&quot;);</span></div>
<div class="line"><span class="lineno">  123</span>      <span class="comment">//     printf(&quot;median:        &quot;); print256_as16_dec(median);        printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  124</span>      <span class="comment">//     printf(&quot;sigma:         &quot;); print256_as16_dec(sigma);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  125</span>      <span class="comment">//     printf(&quot;threshold:         &quot;); print256_as16_dec(threshold);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  126</span>      <span class="comment">//     printf(&quot;to_add_charge: &quot;); print256_as16_dec(to_add_charge); printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  127</span>      <span class="comment">//     printf(&quot;hit_charge:    &quot;); print256_as16_dec(hit_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  128</span>      <span class="comment">//     printf(&quot;channels:    &quot;); print256_as16_dec(channels);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  129</span>      <span class="comment">//     printf(&quot;is_over:          &quot;); print256_as16_dec(is_over);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  130</span>      <span class="comment">//     printf(&quot;left:          &quot;); print256_as16_dec(left);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  131</span>      <span class="comment">//}</span></div>
<div class="line"><span class="lineno">  132</span> </div>
<div class="line"><span class="lineno">  133</span>      <span class="comment">// 1. Calculation of the hit peak time and ADC</span></div>
<div class="line"><span class="lineno">  134</span>      __m256i is_sample_over_adc_peak = _mm256_cmpgt_epi16(s, hit_peak_adc);</div>
<div class="line"><span class="lineno">  135</span>      hit_peak_adc = _mm256_blendv_epi8(hit_peak_adc, s, is_sample_over_adc_peak); </div>
<div class="line"><span class="lineno">  136</span>      hit_peak_time = _mm256_blendv_epi8(hit_peak_time, hit_tover, is_sample_over_adc_peak);</div>
<div class="line"><span class="lineno">  137</span> </div>
<div class="line"><span class="lineno">  138</span>      <span class="comment">// 2. Update of the hit time over threshold  </span></div>
<div class="line"><span class="lineno">  139</span>      __m256i to_add_tover = _mm256_blendv_epi8(_mm256_set1_epi16(0), _mm256_set1_epi16(1), is_over);</div>
<div class="line"><span class="lineno">  140</span>      hit_tover = _mm256_adds_epi16(hit_tover, to_add_tover);</div>
<div class="line"><span class="lineno">  141</span> </div>
<div class="line"><span class="lineno">  142</span>      <span class="comment">// 3. Stop tover from overflowing if needed in practice </span></div>
<div class="line"><span class="lineno">  143</span>      <span class="comment">//hit_tover = _mm256_min_epi16(hit_tover, overflowMax);</span></div>
<div class="line"><span class="lineno">  144</span>    </div>
<div class="line"><span class="lineno">  145</span>      <span class="comment">// Only store the values if there are &gt;0 hits ending on</span></div>
<div class="line"><span class="lineno">  146</span>      <span class="comment">// this sample. We have to save the entire 16-channel</span></div>
<div class="line"><span class="lineno">  147</span>      <span class="comment">// register, which is inefficient, but whatever</span></div>
<div class="line"><span class="lineno">  148</span> </div>
<div class="line"><span class="lineno">  149</span>      <span class="comment">// Testing whether a whole register is zeroes turns out to be tricky. Here&#39;s a way:</span></div>
<div class="line"><span class="lineno">  150</span>      <span class="comment">//</span></div>
<div class="line"><span class="lineno">  151</span>      <span class="comment">// https://stackoverflow.com/questions/22674205/is-there-an-or-equivalent-to-ptest-in-x64-assembly</span></div>
<div class="line"><span class="lineno">  152</span>      <span class="comment">//</span></div>
<div class="line"><span class="lineno">  153</span>      <span class="comment">// In x64 assembly, PTEST %XMM0 -&gt; %XMM1 sets the</span></div>
<div class="line"><span class="lineno">  154</span>      <span class="comment">// zero-flag if none of the same bits are set in %XMM0 and</span></div>
<div class="line"><span class="lineno">  155</span>      <span class="comment">// %XMM1, and sets the carry-flag if everything that is</span></div>
<div class="line"><span class="lineno">  156</span>      <span class="comment">// set in %XMM0 is also set in %XMM1:</span></div>
<div class="line"><span class="lineno">  157</span>      <span class="keyword">const</span> <span class="keywordtype">int</span> no_hits_to_store = _mm256_testc_si256(_mm256_setzero_si256(), left);</div>
<div class="line"><span class="lineno">  158</span> </div>
<div class="line"><span class="lineno">  159</span>      <span class="keywordflow">if</span> (!no_hits_to_store) {</div>
<div class="line"><span class="lineno">  160</span>        <span class="comment">//printf(&quot;------&quot;);  printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  161</span>        <span class="comment">//printf(&quot;channels:    &quot;); print256_as16_dec(channels);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  162</span>        <span class="comment">//printf(&quot;hit_charge:  &quot;); print256_as16_dec(hit_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  163</span>        <span class="comment">//printf(&quot;left:        &quot;); print256_as16_dec(left);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  164</span> </div>
<div class="line"><span class="lineno">  165</span>        ++nhits;</div>
<div class="line"><span class="lineno">  166</span>        <span class="comment">// We have to save the whole register, including the</span></div>
<div class="line"><span class="lineno">  167</span>        <span class="comment">// lanes that don&#39;t have anything interesting, but</span></div>
<div class="line"><span class="lineno">  168</span>        <span class="comment">// we&#39;ll mask them to zero so they&#39;re easy to remove</span></div>
<div class="line"><span class="lineno">  169</span>        <span class="comment">// in a later processing step.</span></div>
<div class="line"><span class="lineno">  170</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  171</span>        <span class="comment">// (TODO: Maybe we should do that processing step in this function?)</span></div>
<div class="line"><span class="lineno">  172</span>        <span class="comment">//#define STORE_MASK(x) _mm256_storeu_si256(output_loc++, _mm256_blendv_epi8(_mm256_set1_epi16(0), x, left));</span></div>
<div class="line"><span class="lineno">  173</span> </div>
<div class="line"><span class="lineno">  174</span>        _mm256_storeu_si256(output_loc++, channels); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  175</span>        <span class="comment">// Store the end time of the hit, not the start</span></div>
<div class="line"><span class="lineno">  176</span>        <span class="comment">// time. Since we also have the time-over-threshold,</span></div>
<div class="line"><span class="lineno">  177</span>        <span class="comment">// we can calculate the absolute 64-bit start time in</span></div>
<div class="line"><span class="lineno">  178</span>        <span class="comment">// the caller. This saves faffing with hits that span</span></div>
<div class="line"><span class="lineno">  179</span>        <span class="comment">// a message boundary, hopefully</span></div>
<div class="line"><span class="lineno">  180</span>    </div>
<div class="line"><span class="lineno">  181</span>        _mm256_storeu_si256(output_loc++, timenow); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  182</span>        <span class="comment">// STORE_MASK(hit_charge);</span></div>
<div class="line"><span class="lineno">  183</span>        <span class="comment">//_mm256_storeu_si256(output_loc++, // NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  184</span>        <span class="comment">//                    _mm256_blendv_epi8(_mm256_set1_epi16(0), hit_charge, left));</span></div>
<div class="line"><span class="lineno">  185</span>        _mm256_storeu_si256(output_loc++, hit_charge);</div>
<div class="line"><span class="lineno">  186</span> </div>
<div class="line"><span class="lineno">  187</span>        _mm256_storeu_si256(output_loc++, hit_tover); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  188</span> </div>
<div class="line"><span class="lineno">  189</span>        _mm256_storeu_si256(output_loc++, hit_peak_adc); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  190</span> </div>
<div class="line"><span class="lineno">  191</span>          _mm256_storeu_si256(output_loc++, hit_peak_time); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  192</span> </div>
<div class="line"><span class="lineno">  193</span>        <span class="comment">// Make sure to count only the channels that are above threshold</span></div>
<div class="line"><span class="lineno">  194</span>          <span class="comment">// Store the flags per channel that indicated the waveform went below threshold</span></div>
<div class="line"><span class="lineno">  195</span>          <span class="comment">// in order to recover the exact channel(s) that have complete hits. </span></div>
<div class="line"><span class="lineno">  196</span>        _mm256_storeu_si256(output_loc++, left); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  197</span> </div>
<div class="line"><span class="lineno">  198</span> </div>
<div class="line"><span class="lineno">  199</span>        <span class="comment">// reset hit_start, hit_charge and hit_tover in the channels we saved</span></div>
<div class="line"><span class="lineno">  200</span>        <span class="keyword">const</span> __m256i zero = _mm256_setzero_si256();</div>
<div class="line"><span class="lineno">  201</span>        hit_charge = _mm256_blendv_epi8(hit_charge, zero, left);</div>
<div class="line"><span class="lineno">  202</span>        hit_tover = _mm256_blendv_epi8(hit_tover, zero, left);</div>
<div class="line"><span class="lineno">  203</span>        hit_peak_adc = _mm256_blendv_epi8(hit_peak_adc, zero, left);</div>
<div class="line"><span class="lineno">  204</span>        hit_peak_time = _mm256_blendv_epi8(hit_peak_time, zero, left);</div>
<div class="line"><span class="lineno">  205</span> </div>
<div class="line"><span class="lineno">  206</span>      } <span class="comment">// end if(!no_hits_to_store)</span></div>
<div class="line"><span class="lineno">  207</span>      prev_was_over = is_over;</div>
<div class="line"><span class="lineno">  208</span> </div>
<div class="line"><span class="lineno">  209</span>    } <span class="comment">// end loop over itime (times for this register)</span></div>
<div class="line"><span class="lineno">  210</span> </div>
<div class="line"><span class="lineno">  211</span>    <span class="comment">// Store the state, ready for the next time round</span></div>
<div class="line"><span class="lineno">  212</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>) + ireg, median);      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  213</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>) + ireg, accum);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  214</span> </div>
<div class="line"><span class="lineno">  215</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>) + ireg, prev_was_over); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  216</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>) + ireg, hit_charge);       <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  217</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>) + ireg, hit_tover);         <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  218</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>) + ireg, hit_peak_adc);         <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  219</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>) + ireg, hit_peak_time);         <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  220</span> </div>
<div class="line"><span class="lineno">  221</span>  } <span class="comment">// end loop over ireg (the swtpg_wibeth::SAMPLES_PER_REGISTER, e.g. 8, registers in this frame)</span></div>
<div class="line"><span class="lineno">  222</span>  <span class="comment">// Arguably not needed, we can avoid using MAGIC</span></div>
<div class="line"><span class="lineno">  223</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 7; ++i) {</div>
<div class="line"><span class="lineno">  224</span>    _mm256_storeu_si256(output_loc++, _mm256_set1_epi16(<a class="code hl_variable" href="namespaceswtpg__wibeth.html#afe2e22f04ea0340dd844dc6b56b5b617">swtpg_wibeth::MAGIC</a>)); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  225</span>  }</div>
<div class="line"><span class="lineno">  226</span> </div>
<div class="line"><span class="lineno">  227</span>  <a class="code hl_variable" href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">info</a>.nhits = nhits;</div>
<div class="line"><span class="lineno">  228</span> </div>
<div class="line"><span class="lineno">  229</span>} <span class="comment">// NOLINT(readability/fn_size)</span></div>
<div class="ttc" id="anamespacereadout-affinity_html_abe2db36c4d39fa615239b96236911da9"><div class="ttname"><a href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">readout-affinity.info</a></div><div class="ttdeci">str info</div><div class="ttdef"><b>Definition</b> <a href="readout-affinity_8py_source.html#l00010">readout-affinity.py:10</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a735ab62c0ab75097f18a50bd37089c21"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a735ab62c0ab75097f18a50bd37089c21">swtpg_wibeth::frugal_accum_update_avx2</a></div><div class="ttdeci">void frugal_accum_update_avx2(__m256i &amp;__restrict__ median, const __m256i s, __m256i &amp;__restrict__ accum, const int16_t acclimit, const __m256i mask) __attribute__((always_inline))</div><div class="ttdef"><b>Definition</b> <a href="UtilsAVX2_8hpp_source.html#l00025">UtilsAVX2.hpp:25</a></div></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_afe2e22f04ea0340dd844dc6b56b5b617"><div class="ttname"><a href="namespaceswtpg__wibeth.html#afe2e22f04ea0340dd844dc6b56b5b617">swtpg_wibeth::MAGIC</a></div><div class="ttdeci">const constexpr std::uint16_t MAGIC</div><div class="ttdef"><b>Definition</b> <a href="TPGConstants__wibeth_8hpp_source.html#l00017">TPGConstants_wibeth.hpp:17</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html">swtpg_wibeth::ChanState</a></div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00021">ProcessingInfo.hpp:22</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a30b1bdc4ba9eca41c4ee1498a0e6e26e"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">swtpg_wibeth::ChanState::hit_tover</a></div><div class="ttdeci">uint16_t __restrict__ hit_tover[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00068">ProcessingInfo.hpp:68</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a4d58fa8042eca78e5cf6ac55fc41e884"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">swtpg_wibeth::ChanState::hit_charge</a></div><div class="ttdeci">uint16_t __restrict__ hit_charge[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00067">ProcessingInfo.hpp:67</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a7077372a4d647714c384400493ca14f5"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">swtpg_wibeth::ChanState::hit_peak_time</a></div><div class="ttdeci">uint16_t __restrict__ hit_peak_time[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00070">ProcessingInfo.hpp:70</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a79fffc7052fb5399a22ae95012f2d580"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">swtpg_wibeth::ChanState::prev_was_over</a></div><div class="ttdeci">uint16_t __restrict__ prev_was_over[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00066">ProcessingInfo.hpp:66</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a820e6edfd09813d719a07bda8e3ad198"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">swtpg_wibeth::ChanState::hit_peak_adc</a></div><div class="ttdeci">uint16_t __restrict__ hit_peak_adc[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00071">ProcessingInfo.hpp:71</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_aabfea33b4e6599246a071a2f53c4342c"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">swtpg_wibeth::ChanState::accum</a></div><div class="ttdeci">int16_t __restrict__ accum[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00048">ProcessingInfo.hpp:48</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_ab15580827204936dbfba55ae050b2a93"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">swtpg_wibeth::ChanState::pedestals</a></div><div class="ttdeci">int16_t __restrict__ pedestals[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00047">ProcessingInfo.hpp:47</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a13939e481227cf7cf43c0ac78c4c7fd4" name="a13939e481227cf7cf43c0ac78c4c7fd4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a13939e481227cf7cf43c0ac78c4c7fd4">&#9670;&#160;</a></span>process_window_naive()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;size_t NREGISTERS&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::process_window_naive </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;&#160;</td>
          <td class="paramname"><em>info</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="ProcessNaive_8hpp_source.html#l00042">42</a> of file <a class="el" href="ProcessNaive_8hpp_source.html">ProcessNaive.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   43</span>{</div>
<div class="line"><span class="lineno">   44</span>  <span class="comment">// Start with taps as floats that add to 1. Multiply by some</span></div>
<div class="line"><span class="lineno">   45</span>  <span class="comment">// power of two (2**N) and round to int. Before filtering, cap the</span></div>
<div class="line"><span class="lineno">   46</span>  <span class="comment">// value of the input to INT16_MAX/(2**N)</span></div>
<div class="line"><span class="lineno">   47</span> </div>
<div class="line"><span class="lineno">   48</span>  uint16_t* output_loc = info.output;           <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   49</span>  <span class="keyword">const</span> uint16_t* input16 = info.input-&gt;data(); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   50</span>  <span class="keywordtype">int</span> nhits = 0;</div>
<div class="line"><span class="lineno">   51</span> </div>
<div class="line"><span class="lineno">   52</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ichan = 0; ichan &lt; NREGISTERS * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>; ++ichan) {</div>
<div class="line"><span class="lineno">   53</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_index = ichan / <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">   54</span>    <span class="keywordflow">if</span> (register_index &lt; info.first_register || register_index &gt;= info.last_register)</div>
<div class="line"><span class="lineno">   55</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">   56</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_offset = ichan % <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">   57</span> </div>
<div class="line"><span class="lineno">   58</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_t0_start = register_index * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a>;</div>
<div class="line"><span class="lineno">   59</span> </div>
<div class="line"><span class="lineno">   60</span>    <span class="comment">// Get all the state variables by reference so they &quot;automatically&quot; get saved for the next go-round</span></div>
<div class="line"><span class="lineno">   61</span>    <a class="code hl_struct" href="structswtpg__wibeth_1_1ChanState.html">ChanState&lt;NREGISTERS&gt;</a>&amp; state = info.chanState;</div>
<div class="line"><span class="lineno">   62</span>    int16_t&amp; median = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>[ichan];</div>
<div class="line"><span class="lineno">   63</span>    int16_t&amp; accum = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>[ichan];</div>
<div class="line"><span class="lineno">   64</span> </div>
<div class="line"><span class="lineno">   65</span>    <span class="comment">// Variables for hit finding</span></div>
<div class="line"><span class="lineno">   66</span>    uint16_t&amp; prev_was_over = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>[ichan]; <span class="comment">// was the previous sample over threshold?</span></div>
<div class="line"><span class="lineno">   67</span>    uint16_t&amp; hit_charge = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>[ichan];</div>
<div class="line"><span class="lineno">   68</span>    uint16_t&amp; hit_tover = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>[ichan]; <span class="comment">// time over threshold</span></div>
<div class="line"><span class="lineno">   69</span>    uint16_t&amp; hit_peak_adc = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>[ichan]; <span class="comment">// time over threshold</span></div>
<div class="line"><span class="lineno">   70</span>    uint16_t&amp; hit_peak_time = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>[ichan]; <span class="comment">// time over threshold</span></div>
<div class="line"><span class="lineno">   71</span> </div>
<div class="line"><span class="lineno">   72</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> itime = 0; itime &lt; info.timeWindowNumFrames; ++itime) {</div>
<div class="line"><span class="lineno">   73</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_index = itime / info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">   74</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_time_offset = itime % info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">   75</span>      <span class="comment">// The index in uint16_t of the start of the message we want // NOLINT</span></div>
<div class="line"><span class="lineno">   76</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_start_index = msg_index * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a61ae264aec55185352ee186b065b92a1">swtpg_wibeth::ADCS_SIZE</a> / <span class="keyword">sizeof</span>(uint16_t); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   77</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> offset_within_msg = register_t0_start + <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * msg_time_offset + register_offset;</div>
<div class="line"><span class="lineno">   78</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> index = msg_start_index + offset_within_msg;</div>
<div class="line"><span class="lineno">   79</span> </div>
<div class="line"><span class="lineno">   80</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   81</span>      <span class="comment">// Pedestal finding/coherent noise removal</span></div>
<div class="line"><span class="lineno">   82</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   83</span>      int16_t sample = input16[index]; </div>
<div class="line"><span class="lineno">   84</span> </div>
<div class="line"><span class="lineno">   85</span>      <span class="comment">//frugal_accum_update(median, sample, accum, 10);</span></div>
<div class="line"><span class="lineno">   86</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#aa8731711fae0e3e45367533babfb537b">frugal_accum_update</a>((int16_t&amp;)median, sample, (int16_t&amp;)accum, 10);</div>
<div class="line"><span class="lineno">   87</span> </div>
<div class="line"><span class="lineno">   88</span>      sample -= median;</div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   91</span>      <span class="comment">// Hit finding</span></div>
<div class="line"><span class="lineno">   92</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   93</span>      <span class="keywordtype">bool</span> is_over = sample &gt; info.threshold;</div>
<div class="line"><span class="lineno">   94</span>      <span class="comment">//printf(&quot;% 5d % 5d % 5d % 5d\n&quot;, (uint16_t)ichan, (uint16_t)itime, sample, info.threshold); // NOLINT</span></div>
<div class="line"><span class="lineno">   95</span>      <span class="keywordflow">if</span> (is_over) {</div>
<div class="line"><span class="lineno">   96</span>        <span class="comment">// Simulate saturated add</span></div>
<div class="line"><span class="lineno">   97</span>        uint32_t tmp_charge = hit_charge;</div>
<div class="line"><span class="lineno">   98</span>        tmp_charge += sample;</div>
<div class="line"><span class="lineno">   99</span>        tmp_charge = std::min(tmp_charge, std::numeric_limits&lt;uint32_t&gt;::max());</div>
<div class="line"><span class="lineno">  100</span>        <span class="keywordflow">if</span> (sample &gt; hit_peak_adc) {</div>
<div class="line"><span class="lineno">  101</span>          hit_peak_adc = (uint16_t)sample;</div>
<div class="line"><span class="lineno">  102</span>          hit_peak_time = hit_tover;</div>
<div class="line"><span class="lineno">  103</span>        }</div>
<div class="line"><span class="lineno">  104</span>        hit_charge = tmp_charge;</div>
<div class="line"><span class="lineno">  105</span>        hit_tover++;</div>
<div class="line"><span class="lineno">  106</span>      }</div>
<div class="line"><span class="lineno">  107</span>      <span class="keywordflow">if</span> (prev_was_over &amp;&amp; !is_over) {</div>
<div class="line"><span class="lineno">  108</span>         <span class="comment">//if(hit_tover==1){</span></div>
<div class="line"><span class="lineno">  109</span>         <span class="comment">//    printf(&quot;% 5d % 5d % 5d % 5d\n&quot;, (uint16_t)ichan, (uint16_t)itime, hit_charge, hit_tover); // NOLINT</span></div>
<div class="line"><span class="lineno">  110</span>         <span class="comment">//}</span></div>
<div class="line"><span class="lineno">  111</span> </div>
<div class="line"><span class="lineno">  112</span>        <span class="comment">// We reached the end of the hit: write it out</span></div>
<div class="line"><span class="lineno">  113</span>    (*output_loc++) = (uint16_t)ichan; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  114</span>        (*output_loc++) = (uint16_t)itime;         <span class="comment">// NOLINT </span></div>
<div class="line"><span class="lineno">  115</span>        (*output_loc++) = hit_charge;      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  116</span>        (*output_loc++) = hit_tover;     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  117</span>        (*output_loc++) = hit_peak_adc;    <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  118</span>        (*output_loc++) = hit_peak_time;   <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  119</span> </div>
<div class="line"><span class="lineno">  120</span>        hit_charge = 0;</div>
<div class="line"><span class="lineno">  121</span>        hit_tover = 0;</div>
<div class="line"><span class="lineno">  122</span>        hit_peak_adc = 0;</div>
<div class="line"><span class="lineno">  123</span>        hit_peak_time = 0;</div>
<div class="line"><span class="lineno">  124</span> </div>
<div class="line"><span class="lineno">  125</span>        ++nhits;</div>
<div class="line"><span class="lineno">  126</span> </div>
<div class="line"><span class="lineno">  127</span>      } <span class="comment">// end if left hit</span></div>
<div class="line"><span class="lineno">  128</span>      prev_was_over = is_over;</div>
<div class="line"><span class="lineno">  129</span>    </div>
<div class="line"><span class="lineno">  130</span>    } <span class="comment">// end loop over samples</span></div>
<div class="line"><span class="lineno">  131</span>  }   <span class="comment">// end loop over channels</span></div>
<div class="line"><span class="lineno">  132</span> </div>
<div class="line"><span class="lineno">  133</span>  <span class="comment">// printf(&quot;Found %d hits\n&quot;, nhits);</span></div>
<div class="line"><span class="lineno">  134</span>  <a class="code hl_variable" href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">info</a>.nhits = nhits;</div>
<div class="line"><span class="lineno">  135</span> </div>
<div class="line"><span class="lineno">  136</span>  <span class="comment">// Write a magic &quot;end-of-hits&quot; value into the list of hits</span></div>
<div class="line"><span class="lineno">  137</span>  <span class="comment">// Arguably not needed, we can avoid using MAGIC </span></div>
<div class="line"><span class="lineno">  138</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 6; ++i) {</div>
<div class="line"><span class="lineno">  139</span>    (*output_loc++) = MAGIC; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  140</span>  }</div>
<div class="line"><span class="lineno">  141</span>}</div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_aa8731711fae0e3e45367533babfb537b"><div class="ttname"><a href="namespaceswtpg__wibeth.html#aa8731711fae0e3e45367533babfb537b">swtpg_wibeth::frugal_accum_update</a></div><div class="ttdeci">void frugal_accum_update(int16_t &amp;m, const int16_t s, int16_t &amp;acc, const int16_t acclimit)</div><div class="ttdef"><b>Definition</b> <a href="ProcessNaive_8hpp_source.html#l00022">ProcessNaive.hpp:22</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af4d03648c65e1b9e26960130d6ffe706" name="af4d03648c65e1b9e26960130d6ffe706"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af4d03648c65e1b9e26960130d6ffe706">&#9670;&#160;</a></span>process_window_naive_RS()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;size_t NREGISTERS&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::process_window_naive_RS </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;&#160;</td>
          <td class="paramname"><em>info</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="ProcessNaiveRS_8hpp_source.html#l00024">24</a> of file <a class="el" href="ProcessNaiveRS_8hpp_source.html">ProcessNaiveRS.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   25</span>{</div>
<div class="line"><span class="lineno">   26</span>  <span class="comment">// Start with taps as floats that add to 1. Multiply by some</span></div>
<div class="line"><span class="lineno">   27</span>  <span class="comment">// power of two (2**N) and round to int. Before filtering, cap the</span></div>
<div class="line"><span class="lineno">   28</span>  <span class="comment">// value of the input to INT16_MAX/(2**N)</span></div>
<div class="line"><span class="lineno">   29</span>  <span class="keyword">const</span> int16_t sigmaMax = (1 &lt;&lt; 15) / (info.multiplier * 5);</div>
<div class="line"><span class="lineno">   30</span>  <span class="keyword">const</span> <span class="keywordtype">float</span>   R = 0.8; <span class="comment">//&quot;deweighting factor&quot; for running sum</span></div>
<div class="line"><span class="lineno">   31</span>  <span class="comment">//scaling factor to stop the ADCs from overflowing (may not needs this, depends on magnitude of FIR output) </span></div>
<div class="line"><span class="lineno">   32</span>  <span class="keyword">const</span> <span class="keywordtype">size_t</span>  <a class="code hl_variable" href="conversions-impl_8hh.html#a80d402d10e8341004c0caf10133b80ab">scale</a> = 2; </div>
<div class="line"><span class="lineno">   33</span> </div>
<div class="line"><span class="lineno">   34</span>  uint16_t* output_loc = info.output;           <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   35</span>  <span class="keyword">const</span> uint16_t* input16 = info.input-&gt;data(); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   36</span>  <span class="keywordtype">int</span> nhits = 0;</div>
<div class="line"><span class="lineno">   37</span> </div>
<div class="line"><span class="lineno">   38</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ichan = 0; ichan &lt; NREGISTERS * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>; ++ichan) {</div>
<div class="line"><span class="lineno">   39</span> </div>
<div class="line"><span class="lineno">   40</span>    <span class="comment">// AAA: debugging </span></div>
<div class="line"><span class="lineno">   41</span>    <span class="comment">//std::cout &lt;&lt; &quot;CHANNEL: &quot; &lt;&lt; ichan &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">   42</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_index = ichan / <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">   43</span>    <span class="keywordflow">if</span> (register_index &lt; info.first_register || register_index &gt;= info.last_register)</div>
<div class="line"><span class="lineno">   44</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">   45</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_offset = ichan % <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a>;</div>
<div class="line"><span class="lineno">   46</span> </div>
<div class="line"><span class="lineno">   47</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> register_t0_start = register_index * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a>;</div>
<div class="line"><span class="lineno">   48</span> </div>
<div class="line"><span class="lineno">   49</span>    <span class="comment">// Get all the state variables by reference so they &quot;automatically&quot; get saved for the next go-round</span></div>
<div class="line"><span class="lineno">   50</span>    <a class="code hl_struct" href="structswtpg__wibeth_1_1ChanState.html">ChanState&lt;NREGISTERS&gt;</a>&amp; state = info.chanState;</div>
<div class="line"><span class="lineno">   51</span>    int16_t&amp; median     = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>[ichan];</div>
<div class="line"><span class="lineno">   52</span>    int16_t&amp; accum      = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>[ichan];</div>
<div class="line"><span class="lineno">   53</span>    </div>
<div class="line"><span class="lineno">   54</span>    int16_t&amp; RS         = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ad1999924a94240a7e1a80e50dd9d6773">RS</a>[ichan]; <span class="comment">//value of the RS for the previous sample</span></div>
<div class="line"><span class="lineno">   55</span>    int16_t&amp; medianRS   = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#af70566bf6e3833535cc95a684c1dc88f">pedestalsRS</a>[ichan]; <span class="comment">//median for the RS waveform needed for IQR &amp; separate pedsub</span></div>
<div class="line"><span class="lineno">   56</span>    int16_t&amp; accumRS    = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a2c33cf4db203f62c39de3f5d3231d6e5">accumRS</a>[ichan];</div>
<div class="line"><span class="lineno">   57</span>    <span class="comment">//IQR</span></div>
<div class="line"><span class="lineno">   58</span>    int16_t&amp; accum25    = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aec8235b36cbd80bd2725905b45185b7e">accum25</a>[ichan];</div>
<div class="line"><span class="lineno">   59</span>    int16_t&amp; accum75    = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab88d420fd8a979343dc1d818120b29c4">accum75</a>[ichan];</div>
<div class="line"><span class="lineno">   60</span>    int16_t&amp; quantile25 = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a37aa8a67a7ba63f7ac4cbda2aeb9fcb0">quantile25</a>[ichan];</div>
<div class="line"><span class="lineno">   61</span>    int16_t&amp; quantile75 = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a88c970107accb4939c206a0fb226618b">quantile75</a>[ichan];</div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   63</span>    <span class="comment">// Variables for hit finding</span></div>
<div class="line"><span class="lineno">   64</span>    uint16_t&amp; prev_was_over = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>[ichan]; <span class="comment">// was the previous sample over threshold?</span></div>
<div class="line"><span class="lineno">   65</span>    uint16_t&amp; hit_charge = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>[ichan];</div>
<div class="line"><span class="lineno">   66</span>    uint16_t&amp; hit_tover = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>[ichan]; <span class="comment">// time over threshold</span></div>
<div class="line"><span class="lineno">   67</span>    uint16_t&amp; hit_peak_adc = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>[ichan]; <span class="comment">// time over threshold</span></div>
<div class="line"><span class="lineno">   68</span>    uint16_t&amp; hit_peak_time = state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>[ichan]; <span class="comment">// time over threshold    </span></div>
<div class="line"><span class="lineno">   69</span> </div>
<div class="line"><span class="lineno">   70</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> itime = 0; itime &lt; info.timeWindowNumFrames; ++itime) {</div>
<div class="line"><span class="lineno">   71</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_index = itime / <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a>;</div>
<div class="line"><span class="lineno">   72</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_time_offset = itime % <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">swtpg_wibeth::FRAMES_PER_MSG</a>;</div>
<div class="line"><span class="lineno">   73</span> </div>
<div class="line"><span class="lineno">   74</span>      <span class="comment">// The index in uint16_t of the start of the message we want // NOLINT</span></div>
<div class="line"><span class="lineno">   75</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_start_index = msg_index * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a61ae264aec55185352ee186b065b92a1">swtpg_wibeth::ADCS_SIZE</a> / <span class="keyword">sizeof</span>(uint16_t); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   76</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> offset_within_msg = register_t0_start + <a class="code hl_variable" href="namespaceswtpg__wibeth.html#a65e5e08d51fb120e9f5566ed5d578df6">SAMPLES_PER_REGISTER</a> * msg_time_offset + register_offset;</div>
<div class="line"><span class="lineno">   77</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> index = msg_start_index + offset_within_msg;</div>
<div class="line"><span class="lineno">   78</span> </div>
<div class="line"><span class="lineno">   79</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   80</span>      <span class="comment">// Pedestal finding/coherent noise removal</span></div>
<div class="line"><span class="lineno">   81</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   82</span>      </div>
<div class="line"><span class="lineno">   83</span>      int16_t sample = input16[index];</div>
<div class="line"><span class="lineno">   84</span> </div>
<div class="line"><span class="lineno">   85</span>      std::stringstream ss;</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>      ss &lt;&lt; <span class="stringliteral">&quot;ADC value: &quot;</span> &lt;&lt; sample;</div>
<div class="line"><span class="lineno">   88</span> </div>
<div class="line"><span class="lineno">   89</span>      <span class="comment">//frugal_accum_update(median, sample, accum, 10);</span></div>
<div class="line"><span class="lineno">   90</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#aa8731711fae0e3e45367533babfb537b">frugal_accum_update</a>((int16_t&amp;)median, sample, (int16_t&amp;)accum, 10);</div>
<div class="line"><span class="lineno">   91</span>      sample -= median;</div>
<div class="line"><span class="lineno">   92</span> </div>
<div class="line"><span class="lineno">   93</span>      ss &lt;&lt; <span class="stringliteral">&quot;\tsample: &quot;</span> &lt;&lt; sample;</div>
<div class="line"><span class="lineno">   94</span> </div>
<div class="line"><span class="lineno">   95</span>      <span class="comment">//--------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   96</span>      <span class="comment">// Absolute Running Sum</span></div>
<div class="line"><span class="lineno">   97</span>      <span class="comment">//--------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">   98</span>      </div>
<div class="line"><span class="lineno">   99</span>      <span class="comment">//RS = (R * RS) + std::abs(sample)/scale;       </span></div>
<div class="line"><span class="lineno">  100</span> </div>
<div class="line"><span class="lineno">  101</span>      <span class="keywordtype">float</span> first_part = R*RS;</div>
<div class="line"><span class="lineno">  102</span>      <span class="keywordtype">float</span> second_part = (float)std::abs(sample)/<a class="code hl_variable" href="conversions-impl_8hh.html#a80d402d10e8341004c0caf10133b80ab">scale</a>; </div>
<div class="line"><span class="lineno">  103</span>      <span class="comment">//int16_t second_part = std::abs(sample); </span></div>
<div class="line"><span class="lineno">  104</span> </div>
<div class="line"><span class="lineno">  105</span>      <span class="comment">// Round the RS result to the closest int16_t because</span></div>
<div class="line"><span class="lineno">  106</span>      <span class="comment">// AVX code uses only int16_t</span></div>
<div class="line"><span class="lineno">  107</span>      RS = std::round(first_part+second_part); </div>
<div class="line"><span class="lineno">  108</span> </div>
<div class="line"><span class="lineno">  109</span>      ss &lt;&lt; <span class="stringliteral">&quot;  \tFirst part: &quot;</span> &lt;&lt; first_part;</div>
<div class="line"><span class="lineno">  110</span>      ss &lt;&lt; <span class="stringliteral">&quot;  \tSecond part: &quot;</span> &lt;&lt; second_part;</div>
<div class="line"><span class="lineno">  111</span>      ss &lt;&lt; <span class="stringliteral">&quot;  \tRS value: &quot;</span> &lt;&lt; RS;</div>
<div class="line"><span class="lineno">  112</span> </div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span> </div>
<div class="line"><span class="lineno">  115</span> </div>
<div class="line"><span class="lineno">  116</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  117</span>      <span class="comment">// Pedsub &amp; IQR</span></div>
<div class="line"><span class="lineno">  118</span>      <span class="comment">// --------------------------------------------------------------      </span></div>
<div class="line"><span class="lineno">  119</span>      ss &lt;&lt; <span class="stringliteral">&quot;  \t25: &quot;</span> &lt;&lt; quantile25;</div>
<div class="line"><span class="lineno">  120</span>      ss &lt;&lt; <span class="stringliteral">&quot;  \t75: &quot;</span> &lt;&lt; quantile75;</div>
<div class="line"><span class="lineno">  121</span> </div>
<div class="line"><span class="lineno">  122</span>      <span class="keywordflow">if</span> (RS &lt; medianRS) {</div>
<div class="line"><span class="lineno">  123</span>        <a class="code hl_function" href="namespaceswtpg__wibeth.html#aa8731711fae0e3e45367533babfb537b">frugal_accum_update</a>(quantile25, RS, accum25, 10);      </div>
<div class="line"><span class="lineno">  124</span>      }</div>
<div class="line"><span class="lineno">  125</span>      <span class="keywordflow">if</span> (RS &gt; medianRS) {</div>
<div class="line"><span class="lineno">  126</span>        frugal_accum_update(quantile75, RS, accum75, 10);</div>
<div class="line"><span class="lineno">  127</span>      }  </div>
<div class="line"><span class="lineno">  128</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#aa8731711fae0e3e45367533babfb537b">frugal_accum_update</a>(medianRS, RS, accumRS, 10);</div>
<div class="line"><span class="lineno">  129</span> </div>
<div class="line"><span class="lineno">  130</span>      ss &lt;&lt; <span class="stringliteral">&quot;  \tMedianRS: &quot;</span> &lt;&lt; medianRS ;</div>
<div class="line"><span class="lineno">  131</span> </div>
<div class="line"><span class="lineno">  132</span>      <span class="comment">/*</span></div>
<div class="line"><span class="lineno">  133</span><span class="comment">      int16_t sigma = quantile75 - quantile25;</span></div>
<div class="line"><span class="lineno">  134</span><span class="comment"></span> </div>
<div class="line"><span class="lineno">  135</span><span class="comment">     // The maximum value that sigma can have before the threshold overflows a 16-bit signed integer</span></div>
<div class="line"><span class="lineno">  136</span><span class="comment">      sigma = std::min(sigma, sigmaMax);</span></div>
<div class="line"><span class="lineno">  137</span><span class="comment"></span> </div>
<div class="line"><span class="lineno">  138</span><span class="comment"></span> </div>
<div class="line"><span class="lineno">  139</span><span class="comment">      ss &lt;&lt; &quot;  \tsigma: &quot; &lt;&lt; sigma;</span></div>
<div class="line"><span class="lineno">  140</span><span class="comment"></span> </div>
<div class="line"><span class="lineno">  141</span><span class="comment"></span> </div>
<div class="line"><span class="lineno">  142</span><span class="comment">      RS -= medianRS;</span></div>
<div class="line"><span class="lineno">  143</span><span class="comment"></span> </div>
<div class="line"><span class="lineno">  144</span><span class="comment">      ss &lt;&lt; &quot;  \tRS after pedsub: &quot; &lt;&lt; RS ;</span></div>
<div class="line"><span class="lineno">  145</span><span class="comment"></span> </div>
<div class="line"><span class="lineno">  146</span><span class="comment">      */</span></div>
<div class="line"><span class="lineno">  147</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  148</span>      <span class="comment">// Hit finding</span></div>
<div class="line"><span class="lineno">  149</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  150</span>      <span class="keywordtype">bool</span> is_over = RS &gt; <a class="code hl_variable" href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">info</a>.threshold;</div>
<div class="line"><span class="lineno">  151</span>      <span class="keywordflow">if</span> (is_over) {</div>
<div class="line"><span class="lineno">  152</span>        <span class="comment">// Simulate saturated add</span></div>
<div class="line"><span class="lineno">  153</span>        int32_t tmp_charge = hit_charge;</div>
<div class="line"><span class="lineno">  154</span>        tmp_charge += sample &gt;&gt; <a class="code hl_variable" href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">info</a>.tap_exponent;</div>
<div class="line"><span class="lineno">  155</span>        tmp_charge = std::min(tmp_charge, (int32_t)std::numeric_limits&lt;int16_t&gt;::max());</div>
<div class="line"><span class="lineno">  156</span>        <span class="keywordflow">if</span> (sample &gt; hit_peak_adc) {</div>
<div class="line"><span class="lineno">  157</span>          hit_peak_adc = (uint16_t)sample;</div>
<div class="line"><span class="lineno">  158</span>          hit_peak_time = hit_tover;</div>
<div class="line"><span class="lineno">  159</span>        }</div>
<div class="line"><span class="lineno">  160</span>        hit_charge = (int16_t)tmp_charge;</div>
<div class="line"><span class="lineno">  161</span>        hit_tover++;</div>
<div class="line"><span class="lineno">  162</span>        prev_was_over = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  163</span>      }</div>
<div class="line"><span class="lineno">  164</span>      <span class="keywordflow">if</span> (prev_was_over &amp;&amp; !is_over) {</div>
<div class="line"><span class="lineno">  165</span> </div>
<div class="line"><span class="lineno">  166</span>        ss &lt;&lt; <span class="stringliteral">&quot;\tis_over: &quot;</span> &lt;&lt; is_over;</div>
<div class="line"><span class="lineno">  167</span> </div>
<div class="line"><span class="lineno">  168</span>        <span class="comment">// if(hit_tover==1){</span></div>
<div class="line"><span class="lineno">  169</span>        <span class="comment">//     printf(&quot;% 5d % 5d % 5d % 5d\n&quot;, (uint16_t)ichan, (uint16_t)itime, hit_charge, hit_tover); // NOLINT</span></div>
<div class="line"><span class="lineno">  170</span>        <span class="comment">// }</span></div>
<div class="line"><span class="lineno">  171</span> </div>
<div class="line"><span class="lineno">  172</span>        <span class="comment">// We reached the end of the hit: write it out</span></div>
<div class="line"><span class="lineno">  173</span>        (*output_loc++) = (uint16_t)ichan; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  174</span>        (*output_loc++) = itime;           <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  175</span>        (*output_loc++) = hit_charge;      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  176</span>        (*output_loc++) = hit_tover;       <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  177</span>        (*output_loc++) = hit_peak_adc;    <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  178</span>        (*output_loc++) = hit_peak_time;   <span class="comment">// NOLINT        </span></div>
<div class="line"><span class="lineno">  179</span> </div>
<div class="line"><span class="lineno">  180</span>        hit_charge = 0;</div>
<div class="line"><span class="lineno">  181</span>        hit_tover = 0;</div>
<div class="line"><span class="lineno">  182</span>        hit_peak_adc = 0;</div>
<div class="line"><span class="lineno">  183</span>        hit_peak_time = 0;</div>
<div class="line"><span class="lineno">  184</span> </div>
<div class="line"><span class="lineno">  185</span> </div>
<div class="line"><span class="lineno">  186</span>        ++nhits;</div>
<div class="line"><span class="lineno">  187</span>        prev_was_over = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  188</span> </div>
<div class="line"><span class="lineno">  189</span>      } <span class="comment">// end if left hit</span></div>
<div class="line"><span class="lineno">  190</span> </div>
<div class="line"><span class="lineno">  191</span>      <span class="comment">//std::cout &lt;&lt; ss.str() &lt;&lt; std::endl;      </span></div>
<div class="line"><span class="lineno">  192</span> </div>
<div class="line"><span class="lineno">  193</span> </div>
<div class="line"><span class="lineno">  194</span>    } <span class="comment">// end loop over samples</span></div>
<div class="line"><span class="lineno">  195</span>  }   <span class="comment">// end loop over channels</span></div>
<div class="line"><span class="lineno">  196</span> </div>
<div class="line"><span class="lineno">  197</span>  <span class="comment">// Write a magic &quot;end-of-hits&quot; value into the list of hits</span></div>
<div class="line"><span class="lineno">  198</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 6; ++i) {</div>
<div class="line"><span class="lineno">  199</span>    (*output_loc++) = MAGIC; <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  200</span>  }</div>
<div class="line"><span class="lineno">  201</span> </div>
<div class="line"><span class="lineno">  202</span>  <a class="code hl_variable" href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">info</a>.nhits += nhits;</div>
<div class="line"><span class="lineno">  203</span> </div>
<div class="line"><span class="lineno">  204</span>  <span class="comment">//if (nhits &gt; 0) { </span></div>
<div class="line"><span class="lineno">  205</span>  <span class="comment">//  std::cout &lt;&lt; &quot;FOUND HITS: &quot; &lt;&lt; nhits &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">  206</span>  <span class="comment">//} </span></div>
<div class="line"><span class="lineno">  207</span> </div>
<div class="line"><span class="lineno">  208</span> </div>
<div class="line"><span class="lineno">  209</span>  printf(<span class="stringliteral">&quot;Found %d hits\n&quot;</span>, nhits);</div>
<div class="line"><span class="lineno">  210</span> </div>
<div class="line"><span class="lineno">  211</span> </div>
<div class="line"><span class="lineno">  212</span>}</div>
<div class="ttc" id="aconversions-impl_8hh_html_a80d402d10e8341004c0caf10133b80ab"><div class="ttname"><a href="conversions-impl_8hh.html#a80d402d10e8341004c0caf10133b80ab">scale</a></div><div class="ttdeci">double scale</div><div class="ttdef"><b>Definition</b> <a href="conversions-impl_8hh_source.html#l00027">conversions-impl.hh:27</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a2c33cf4db203f62c39de3f5d3231d6e5"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a2c33cf4db203f62c39de3f5d3231d6e5">swtpg_wibeth::ChanState::accumRS</a></div><div class="ttdeci">int16_t __restrict__ accumRS[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00053">ProcessingInfo.hpp:53</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a37aa8a67a7ba63f7ac4cbda2aeb9fcb0"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a37aa8a67a7ba63f7ac4cbda2aeb9fcb0">swtpg_wibeth::ChanState::quantile25</a></div><div class="ttdeci">int16_t __restrict__ quantile25[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00059">ProcessingInfo.hpp:59</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_a88c970107accb4939c206a0fb226618b"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#a88c970107accb4939c206a0fb226618b">swtpg_wibeth::ChanState::quantile75</a></div><div class="ttdeci">int16_t __restrict__ quantile75[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00060">ProcessingInfo.hpp:60</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_ab88d420fd8a979343dc1d818120b29c4"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#ab88d420fd8a979343dc1d818120b29c4">swtpg_wibeth::ChanState::accum75</a></div><div class="ttdeci">int16_t __restrict__ accum75[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00057">ProcessingInfo.hpp:57</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_ad1999924a94240a7e1a80e50dd9d6773"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#ad1999924a94240a7e1a80e50dd9d6773">swtpg_wibeth::ChanState::RS</a></div><div class="ttdeci">int16_t __restrict__ RS[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00051">ProcessingInfo.hpp:51</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_aec8235b36cbd80bd2725905b45185b7e"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#aec8235b36cbd80bd2725905b45185b7e">swtpg_wibeth::ChanState::accum25</a></div><div class="ttdeci">int16_t __restrict__ accum25[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00056">ProcessingInfo.hpp:56</a></div></div>
<div class="ttc" id="astructswtpg__wibeth_1_1ChanState_html_af70566bf6e3833535cc95a684c1dc88f"><div class="ttname"><a href="structswtpg__wibeth_1_1ChanState.html#af70566bf6e3833535cc95a684c1dc88f">swtpg_wibeth::ChanState::pedestalsRS</a></div><div class="ttdeci">int16_t __restrict__ pedestalsRS[NREGISTERS *SAMPLES_PER_REGISTER]</div><div class="ttdef"><b>Definition</b> <a href="ProcessingInfo_8hpp_source.html#l00052">ProcessingInfo.hpp:52</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae3e721a661c262e8c8f39957add0f5bb" name="ae3e721a661c262e8c8f39957add0f5bb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae3e721a661c262e8c8f39957add0f5bb">&#9670;&#160;</a></span>process_window_rs_avx2()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;size_t NREGISTERS&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::process_window_rs_avx2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;&#160;</td>
          <td class="paramname"><em>info</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="ProcessAbsRSAVX2_8hpp_source.html#l00023">23</a> of file <a class="el" href="ProcessAbsRSAVX2_8hpp_source.html">ProcessAbsRSAVX2.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   24</span>{</div>
<div class="line"><span class="lineno">   25</span> </div>
<div class="line"><span class="lineno">   26</span>  <span class="keyword">const</span> __m256i overflowMax = _mm256_set1_epi16(INT16_MAX);</div>
<div class="line"><span class="lineno">   27</span>      </div>
<div class="line"><span class="lineno">   28</span> </div>
<div class="line"><span class="lineno">   29</span>  <span class="comment">// Running sum scaling factor</span></div>
<div class="line"><span class="lineno">   30</span>  <span class="keyword">const</span> __m256i R_factor = _mm256_set1_epi16(8);</div>
<div class="line"><span class="lineno">   31</span> </div>
<div class="line"><span class="lineno">   32</span>  <span class="comment">// Scaling factor to stop the ADCs from overflowing </span></div>
<div class="line"><span class="lineno">   33</span>  <span class="comment">// (may not needs this, depends on magnitude of FIR output) </span></div>
<div class="line"><span class="lineno">   34</span>  <span class="keyword">const</span> __m256i scale_factor = _mm256_set1_epi16(5);</div>
<div class="line"><span class="lineno">   35</span> </div>
<div class="line"><span class="lineno">   36</span>  <span class="comment">// The maximum value that sigma can have before the threshold overflows a 16-bit signed integer</span></div>
<div class="line"><span class="lineno">   37</span>  <span class="comment">//const __m256i sigmaMax = _mm256_set1_epi16((1 &lt;&lt; 15) / (info.multiplier * info.threshold));</span></div>
<div class="line"><span class="lineno">   38</span> </div>
<div class="line"><span class="lineno">   39</span>  <span class="comment">// Pointer to keep track of where we&#39;ll write the next output hit</span></div>
<div class="line"><span class="lineno">   40</span>  __m256i* output_loc = (__m256i*)(info.output); <span class="comment">// NOLINT(readability/casting)</span></div>
<div class="line"><span class="lineno">   41</span> </div>
<div class="line"><span class="lineno">   42</span>  <span class="keyword">const</span> __m256i iota = _mm256_set_epi16(14, 13, 12, 11, 10, 9, 8, 15, 7, 6, 5, 4, 3, 2, 1, 0);</div>
<div class="line"><span class="lineno">   43</span> </div>
<div class="line"><span class="lineno">   44</span>  <span class="keywordtype">int</span> nhits = 0;</div>
<div class="line"><span class="lineno">   45</span> </div>
<div class="line"><span class="lineno">   46</span>  <span class="keywordflow">for</span> (uint16_t ireg = info.first_register; ireg &lt; info.last_register; ++ireg) { <span class="comment">// NOLINT(build/unsigned)</span></div>
<div class="line"><span class="lineno">   47</span> </div>
<div class="line"><span class="lineno">   48</span>    <span class="comment">//printf(&quot;ireg:          &quot;); std::cout &lt;&lt; (ireg) &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">   49</span> </div>
<div class="line"><span class="lineno">   50</span> </div>
<div class="line"><span class="lineno">   51</span>    <span class="comment">// ------------------------------------</span></div>
<div class="line"><span class="lineno">   52</span>    <span class="comment">// Variables for pedestal subtraction</span></div>
<div class="line"><span class="lineno">   53</span> </div>
<div class="line"><span class="lineno">   54</span>    <span class="comment">// The current estimate of the pedestal in each channel: get</span></div>
<div class="line"><span class="lineno">   55</span>    <span class="comment">// from the previous go-around.</span></div>
<div class="line"><span class="lineno">   56</span> </div>
<div class="line"><span class="lineno">   57</span>    <a class="code hl_struct" href="structswtpg__wibeth_1_1ChanState.html">ChanState&lt;NREGISTERS&gt;</a>&amp; state = info.chanState;</div>
<div class="line"><span class="lineno">   58</span>    __m256i median = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>) + ireg);      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   59</span>    <span class="comment">//__m256i quantile25 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile25) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   60</span>    <span class="comment">//__m256i quantile75 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile75) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   61</span> </div>
<div class="line"><span class="lineno">   62</span>    <span class="comment">// The accumulator that we increase/decrease when the current</span></div>
<div class="line"><span class="lineno">   63</span>    <span class="comment">// sample is greater/less than the median</span></div>
<div class="line"><span class="lineno">   64</span>    __m256i accum = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   65</span>    <span class="comment">//__m256i accum25 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum25) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   66</span>    <span class="comment">//__m256i accum75 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum75) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   67</span> </div>
<div class="line"><span class="lineno">   68</span>    <span class="comment">// Runnin Sum variables</span></div>
<div class="line"><span class="lineno">   69</span> </div>
<div class="line"><span class="lineno">   70</span>    __m256i RS = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ad1999924a94240a7e1a80e50dd9d6773">RS</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   71</span>    __m256i medianRS = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#af70566bf6e3833535cc95a684c1dc88f">pedestalsRS</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   72</span>    __m256i accumRS = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a2c33cf4db203f62c39de3f5d3231d6e5">accumRS</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   73</span> </div>
<div class="line"><span class="lineno">   74</span>    <span class="comment">// ------------------------------------</span></div>
<div class="line"><span class="lineno">   75</span>    <span class="comment">// Variables for hit finding</span></div>
<div class="line"><span class="lineno">   76</span> </div>
<div class="line"><span class="lineno">   77</span>    <span class="comment">// Was the previous step over threshold?</span></div>
<div class="line"><span class="lineno">   78</span>    __m256i prev_was_over = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   79</span>    ;</div>
<div class="line"><span class="lineno">   80</span>    <span class="comment">// The integrated charge (so far) of the current hit</span></div>
<div class="line"><span class="lineno">   81</span>    __m256i hit_charge = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   82</span>    ;</div>
<div class="line"><span class="lineno">   83</span>    <span class="comment">// The time-over-threshold (so far) of the current hit</span></div>
<div class="line"><span class="lineno">   84</span>    __m256i hit_tover = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   85</span>    ;</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>    <span class="comment">// The peak adc value</span></div>
<div class="line"><span class="lineno">   88</span>    __m256i hit_peak_adc = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>    <span class="comment">// The time of the peak of the current hit</span></div>
<div class="line"><span class="lineno">   91</span>    __m256i hit_peak_time = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>) + ireg); <span class="comment">// NOLINT    </span></div>
<div class="line"><span class="lineno">   92</span> </div>
<div class="line"><span class="lineno">   93</span>    <span class="comment">// The channel numbers in each of the slots in the register</span></div>
<div class="line"><span class="lineno">   94</span>    __m256i channel_base = _mm256_set1_epi16(ireg * SAMPLES_PER_REGISTER);</div>
<div class="line"><span class="lineno">   95</span>    __m256i channels = _mm256_add_epi16(channel_base, iota);</div>
<div class="line"><span class="lineno">   96</span> </div>
<div class="line"><span class="lineno">   97</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> itime = 0; itime &lt; info.timeWindowNumFrames; ++itime) {</div>
<div class="line"><span class="lineno">   98</span>      <span class="comment">//printf(&quot;itime=%ld\n&quot;, itime);</span></div>
<div class="line"><span class="lineno">   99</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_index = itime / info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">  100</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_time_offset = itime % info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">  101</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> index = msg_index * NREGISTERS * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a> + <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a> * ireg + msg_time_offset;</div>
<div class="line"><span class="lineno">  102</span>      <span class="comment">// const __m256i* rawp=reinterpret_cast&lt;const __m256i*&gt;(info.input)+index; // NOLINT</span></div>
<div class="line"><span class="lineno">  103</span> </div>
<div class="line"><span class="lineno">  104</span> </div>
<div class="line"><span class="lineno">  105</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  106</span>      <span class="comment">// Pedestal finding/coherent noise removal</span></div>
<div class="line"><span class="lineno">  107</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  108</span> </div>
<div class="line"><span class="lineno">  109</span> </div>
<div class="line"><span class="lineno">  110</span>      <span class="comment">// The current sample</span></div>
<div class="line"><span class="lineno">  111</span>      __m256i s = info.input-&gt;ymm(index);</div>
<div class="line"><span class="lineno">  112</span>      <span class="comment">//printf(&quot;Input ADC value:\t\t\t\t&quot;); print256_as16_dec(s);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span>      <span class="comment">// Update the median itself in all channels</span></div>
<div class="line"><span class="lineno">  115</span><span class="preprocessor">#pragma GCC diagnostic push</span></div>
<div class="line"><span class="lineno">  116</span><span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Woverflow&quot;</span></div>
<div class="line"><span class="lineno">  117</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#a735ab62c0ab75097f18a50bd37089c21">swtpg_wibeth::frugal_accum_update_avx2</a>(median, s, accum, 10, _mm256_set1_epi16(0xffff));</div>
<div class="line"><span class="lineno">  118</span><span class="preprocessor">#pragma GCC diagnostic pop</span></div>
<div class="line"><span class="lineno">  119</span>      <span class="comment">// Actually subtract the pedestal</span></div>
<div class="line"><span class="lineno">  120</span>      s = _mm256_sub_epi16(s, median);</div>
<div class="line"><span class="lineno">  121</span>      <span class="comment">//printf(&quot;after pedestal:        &quot;); print256_as16_dec(s);        printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  122</span> </div>
<div class="line"><span class="lineno">  123</span> </div>
<div class="line"><span class="lineno">  124</span>    </div>
<div class="line"><span class="lineno">  125</span> </div>
<div class="line"><span class="lineno">  126</span> </div>
<div class="line"><span class="lineno">  127</span>      <span class="comment">//--------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  128</span>      <span class="comment">// Absolute Running Sum</span></div>
<div class="line"><span class="lineno">  129</span>      <span class="comment">//--------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  130</span>      </div>
<div class="line"><span class="lineno">  131</span>      <span class="comment">// Naive: RS = (R_factor * RS) + std::abs(filt)/scale; </span></div>
<div class="line"><span class="lineno">  132</span> </div>
<div class="line"><span class="lineno">  133</span>      <span class="comment">// Instead of using floats in the calcualation of the RS we multiply by 10 and </span></div>
<div class="line"><span class="lineno">  134</span>      <span class="comment">// do operations on the integers. In the end we divide by 10. </span></div>
<div class="line"><span class="lineno">  135</span> </div>
<div class="line"><span class="lineno">  136</span>     __m256i first_part = _mm256_mullo_epi16(RS, R_factor);</div>
<div class="line"><span class="lineno">  137</span>     <span class="comment">//__m256i first_part_div = _mm256_div_epi16(RS, 10);</span></div>
<div class="line"><span class="lineno">  138</span> </div>
<div class="line"><span class="lineno">  139</span>     __m256i second_part = _mm256_mullo_epi16(_mm256_abs_epi16(s), scale_factor);</div>
<div class="line"><span class="lineno">  140</span>     <span class="comment">//__m256i second_part_div = _mm256_div_epi16(_mm256_abs_epi16(s), 10);</span></div>
<div class="line"><span class="lineno">  141</span> </div>
<div class="line"><span class="lineno">  142</span>     <span class="comment">//RS = _mm256_div_epi16(_mm256_add_epi16(first_part, second_part), 10);</span></div>
<div class="line"><span class="lineno">  143</span>     RS = <a class="code hl_function" href="namespaceswtpg__wibeth.html#a01f29e52679785e2fc8a805a8a18c517">swtpg_wibeth::_mm256_div_epi16</a>(_mm256_add_epi16(first_part, second_part), 10);</div>
<div class="line"><span class="lineno">  144</span> </div>
<div class="line"><span class="lineno">  145</span>     <span class="comment">//printf(&quot;first_part:\t\t\t\t&quot;); print256_as16_dec(first_part);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  146</span>     <span class="comment">//printf(&quot;second_part:\t\t\t\t&quot;); print256_as16_dec(second_part);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  147</span>     <span class="comment">//printf(&quot;RS_value:\t\t\t\t&quot;); print256_as16_dec(RS);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  148</span> </div>
<div class="line"><span class="lineno">  149</span>      <span class="comment">// Update the medianRS itself in all channels</span></div>
<div class="line"><span class="lineno">  150</span>      <span class="comment">//printf(&quot;MedianRS:\t\t\t\t&quot;); print256_as16_dec(medianRS);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  151</span> </div>
<div class="line"><span class="lineno">  152</span><span class="preprocessor">#pragma GCC diagnostic push</span></div>
<div class="line"><span class="lineno">  153</span><span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Woverflow&quot;</span></div>
<div class="line"><span class="lineno">  154</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#a735ab62c0ab75097f18a50bd37089c21">swtpg_wibeth::frugal_accum_update_avx2</a>(medianRS, RS, accumRS, 10, _mm256_set1_epi16(0xffff));</div>
<div class="line"><span class="lineno">  155</span><span class="preprocessor">#pragma GCC diagnostic pop</span></div>
<div class="line"><span class="lineno">  156</span> </div>
<div class="line"><span class="lineno">  157</span>      <span class="comment">// __m256i sigma = _mm256_set1_epi16(2000); // 20 ADC</span></div>
<div class="line"><span class="lineno">  158</span>      RS = _mm256_sub_epi16(RS, medianRS);</div>
<div class="line"><span class="lineno">  159</span> </div>
<div class="line"><span class="lineno">  160</span>      <span class="comment">//printf(&quot;RS_after_medianRS:\t\t\t\t&quot;); print256_as16_dec(RS);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  161</span> </div>
<div class="line"><span class="lineno">  162</span> </div>
<div class="line"><span class="lineno">  163</span> </div>
<div class="line"><span class="lineno">  164</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  165</span>      <span class="comment">// Inter-quantile range</span></div>
<div class="line"><span class="lineno">  166</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  167</span> </div>
<div class="line"><span class="lineno">  168</span>      <span class="comment">// Find the interquartile range</span></div>
<div class="line"><span class="lineno">  169</span>      <span class="comment">//__m256i sigma = _mm256_sub_epi16(quantile75, quantile25);</span></div>
<div class="line"><span class="lineno">  170</span>      </div>
<div class="line"><span class="lineno">  171</span>      <span class="comment">// Clamp sigma to a range where it won&#39;t overflow when</span></div>
<div class="line"><span class="lineno">  172</span>      <span class="comment">// multiplied by info.multiplier*5</span></div>
<div class="line"><span class="lineno">  173</span>      <span class="comment">//sigma = _mm256_min_epi16(sigma, sigmaMax);</span></div>
<div class="line"><span class="lineno">  174</span> </div>
<div class="line"><span class="lineno">  175</span> </div>
<div class="line"><span class="lineno">  176</span> </div>
<div class="line"><span class="lineno">  177</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  178</span>      <span class="comment">// Hit finding</span></div>
<div class="line"><span class="lineno">  179</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  180</span>      <span class="comment">// Mask for channels that are over the threshold in this step</span></div>
<div class="line"><span class="lineno">  181</span> </div>
<div class="line"><span class="lineno">  182</span>      <span class="comment">// IQR-based THRESHOLD</span></div>
<div class="line"><span class="lineno">  183</span>      <span class="comment">//__m256i is_over = _mm256_cmpgt_epi16(RS, sigma * info.threshold);</span></div>
<div class="line"><span class="lineno">  184</span> </div>
<div class="line"><span class="lineno">  185</span>      <span class="comment">// FIXED THRESHOLD</span></div>
<div class="line"><span class="lineno">  186</span>      __m256i threshold = _mm256_set1_epi16(info.threshold);</div>
<div class="line"><span class="lineno">  187</span>      __m256i is_over = _mm256_cmpgt_epi16(RS, threshold);</div>
<div class="line"><span class="lineno">  188</span> </div>
<div class="line"><span class="lineno">  189</span> </div>
<div class="line"><span class="lineno">  190</span>      <span class="comment">// Mask for channels that left &quot;over threshold&quot; state this step</span></div>
<div class="line"><span class="lineno">  191</span>      __m256i left = _mm256_andnot_si256(is_over, prev_was_over);</div>
<div class="line"><span class="lineno">  192</span> </div>
<div class="line"><span class="lineno">  193</span>      <span class="comment">//-----------------------------------------</span></div>
<div class="line"><span class="lineno">  194</span>      <span class="comment">// Update hit start times for the channels where a hit started</span></div>
<div class="line"><span class="lineno">  195</span>      <span class="keyword">const</span> __m256i timenow = _mm256_set1_epi16(itime);</div>
<div class="line"><span class="lineno">  196</span>      <span class="comment">//-----------------------------------------</span></div>
<div class="line"><span class="lineno">  197</span>      <span class="comment">// Accumulate charge and time-over-threshold in the is_over channels</span></div>
<div class="line"><span class="lineno">  198</span> </div>
<div class="line"><span class="lineno">  199</span>      <span class="comment">// Really want an epi16 version of this, but the cmpgt and</span></div>
<div class="line"><span class="lineno">  200</span>      <span class="comment">// cmplt functions set their epi16 parts to 0xff or 0x0,</span></div>
<div class="line"><span class="lineno">  201</span>      <span class="comment">// so treating everything as epi8 works the same</span></div>
<div class="line"><span class="lineno">  202</span>      __m256i to_add_charge = _mm256_blendv_epi8(_mm256_set1_epi16(0), s, is_over);</div>
<div class="line"><span class="lineno">  203</span>      hit_charge = _mm256_adds_epi16(hit_charge, to_add_charge);</div>
<div class="line"><span class="lineno">  204</span> </div>
<div class="line"><span class="lineno">  205</span>      <span class="comment">// Avoid overflow of the hit charge, if needed in practice </span></div>
<div class="line"><span class="lineno">  206</span>      hit_charge = _mm256_min_epi16(hit_charge, overflowMax);</div>
<div class="line"><span class="lineno">  207</span> </div>
<div class="line"><span class="lineno">  208</span> </div>
<div class="line"><span class="lineno">  209</span>      <span class="comment">//if(ireg==0){</span></div>
<div class="line"><span class="lineno">  210</span>      <span class="comment">//     printf(&quot;itime=%ld\n&quot;, itime);</span></div>
<div class="line"><span class="lineno">  211</span>      <span class="comment">//     printf(&quot;s:             &quot;); print256_as16_dec(s);             printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  212</span>      <span class="comment">//     printf(&quot;median:        &quot;); print256_as16_dec(median);        printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  213</span>      <span class="comment">//     printf(&quot;RS:         &quot;); print256_as16_dec(RS);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  214</span>      <span class="comment">//     printf(&quot;sigma:         &quot;); print256_as16_dec(sigma);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  215</span>      <span class="comment">//     printf(&quot;filt:          &quot;); print256_as16_dec(filt);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  216</span>      <span class="comment">//     printf(&quot;to_add_charge: &quot;); print256_as16_dec(to_add_charge); printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  217</span>      <span class="comment">//     printf(&quot;hit_charge:    &quot;); print256_as16_dec(hit_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  218</span>      <span class="comment">//     printf(&quot;channels:    &quot;); print256_as16_dec(channels);    printf(&quot;\n&quot;);     </span></div>
<div class="line"><span class="lineno">  219</span>      <span class="comment">//     printf(&quot;is_over:          &quot;); print256_as16_dec(is_over);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  220</span>      <span class="comment">//     printf(&quot;left:          &quot;); print256_as16_dec(left);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  221</span>      <span class="comment">//}</span></div>
<div class="line"><span class="lineno">  222</span> </div>
<div class="line"><span class="lineno">  223</span>      <span class="comment">// 1. Calculation of the hit peak time and ADC</span></div>
<div class="line"><span class="lineno">  224</span>      __m256i is_sample_over_adc_peak = _mm256_cmpgt_epi16(s, hit_peak_adc);</div>
<div class="line"><span class="lineno">  225</span>      hit_peak_adc = _mm256_blendv_epi8(hit_peak_adc, s, is_sample_over_adc_peak); </div>
<div class="line"><span class="lineno">  226</span>      hit_peak_time = _mm256_blendv_epi8(hit_peak_time, hit_tover, is_sample_over_adc_peak);</div>
<div class="line"><span class="lineno">  227</span> </div>
<div class="line"><span class="lineno">  228</span>      <span class="comment">// 2. Update of the hit time over threshold  </span></div>
<div class="line"><span class="lineno">  229</span>      __m256i to_add_tover = _mm256_blendv_epi8(_mm256_set1_epi16(0), _mm256_set1_epi16(1), is_over);</div>
<div class="line"><span class="lineno">  230</span>      hit_tover = _mm256_adds_epi16(hit_tover, to_add_tover);</div>
<div class="line"><span class="lineno">  231</span> </div>
<div class="line"><span class="lineno">  232</span>      <span class="comment">// 3. Stop tover from overflowing if needed in practice </span></div>
<div class="line"><span class="lineno">  233</span>      <span class="comment">//hit_tover = _mm256_min_epi16(hit_tover, overflowMax);      </span></div>
<div class="line"><span class="lineno">  234</span> </div>
<div class="line"><span class="lineno">  235</span>      <span class="comment">// Only store the values if there are &gt;0 hits ending on</span></div>
<div class="line"><span class="lineno">  236</span>      <span class="comment">// this sample. We have to save the entire 16-channel</span></div>
<div class="line"><span class="lineno">  237</span>      <span class="comment">// register, which is inefficient, but whatever</span></div>
<div class="line"><span class="lineno">  238</span> </div>
<div class="line"><span class="lineno">  239</span>      <span class="comment">// Testing whether a whole register is zeroes turns out to be tricky. Here&#39;s a way:</span></div>
<div class="line"><span class="lineno">  240</span>      <span class="comment">//</span></div>
<div class="line"><span class="lineno">  241</span>      <span class="comment">// https://stackoverflow.com/questions/22674205/is-there-an-or-equivalent-to-ptest-in-x64-assembly</span></div>
<div class="line"><span class="lineno">  242</span>      <span class="comment">//</span></div>
<div class="line"><span class="lineno">  243</span>      <span class="comment">// In x64 assembly, PTEST %XMM0 -&gt; %XMM1 sets the</span></div>
<div class="line"><span class="lineno">  244</span>      <span class="comment">// zero-flag if none of the same bits are set in %XMM0 and</span></div>
<div class="line"><span class="lineno">  245</span>      <span class="comment">// %XMM1, and sets the carry-flag if everything that is</span></div>
<div class="line"><span class="lineno">  246</span>      <span class="comment">// set in %XMM0 is also set in %XMM1:</span></div>
<div class="line"><span class="lineno">  247</span>      <span class="keyword">const</span> <span class="keywordtype">int</span> no_hits_to_store = _mm256_testc_si256(_mm256_setzero_si256(), left);</div>
<div class="line"><span class="lineno">  248</span>      <span class="comment">//printf(&quot;left:          &quot;); print256_as16_dec(left);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  249</span> </div>
<div class="line"><span class="lineno">  250</span> </div>
<div class="line"><span class="lineno">  251</span>      <span class="keywordflow">if</span> (!no_hits_to_store) {</div>
<div class="line"><span class="lineno">  252</span> </div>
<div class="line"><span class="lineno">  253</span> </div>
<div class="line"><span class="lineno">  254</span>        ++nhits;</div>
<div class="line"><span class="lineno">  255</span>        <span class="comment">// We have to save the whole register, including the</span></div>
<div class="line"><span class="lineno">  256</span>        <span class="comment">// lanes that don&#39;t have anything interesting, but</span></div>
<div class="line"><span class="lineno">  257</span>        <span class="comment">// we&#39;ll mask them to zero so they&#39;re easy to remove</span></div>
<div class="line"><span class="lineno">  258</span>        <span class="comment">// in a later processing step.</span></div>
<div class="line"><span class="lineno">  259</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  260</span>        <span class="comment">// (TODO: Maybe we should do that processing step in this function?)</span></div>
<div class="line"><span class="lineno">  261</span>        <span class="comment">//#define STORE_MASK(x) _mm256_storeu_si256(output_loc++, _mm256_blendv_epi8(_mm256_set1_epi16(0), x, left));</span></div>
<div class="line"><span class="lineno">  262</span> </div>
<div class="line"><span class="lineno">  263</span>        _mm256_storeu_si256(output_loc++, channels); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  264</span>        <span class="comment">//printf(&quot;channels:          &quot;); print256_as16_dec(channels);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  265</span>        <span class="comment">//printf(&quot;to_add_charge:    &quot;); print256_as16_dec(to_add_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  266</span>        <span class="comment">//printf(&quot;hit_charge:    &quot;); print256_as16_dec(hit_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  267</span>        <span class="comment">//printf(&quot;to_add_tover:    &quot;); print256_as16_dec(to_add_tover);    printf(&quot;\n&quot;);      </span></div>
<div class="line"><span class="lineno">  268</span>        <span class="comment">//printf(&quot;hit_tover:    &quot;); print256_as16_dec(hit_tover);    printf(&quot;\n&quot;);      </span></div>
<div class="line"><span class="lineno">  269</span> </div>
<div class="line"><span class="lineno">  270</span>        <span class="comment">// Store the end time of the hit, not the start</span></div>
<div class="line"><span class="lineno">  271</span>        <span class="comment">// time. Since we also have the time-over-threshold,</span></div>
<div class="line"><span class="lineno">  272</span>        <span class="comment">// we can calculate the absolute 64-bit start time in</span></div>
<div class="line"><span class="lineno">  273</span>        <span class="comment">// the caller. This saves faffing with hits that span</span></div>
<div class="line"><span class="lineno">  274</span>        <span class="comment">// a message boundary, hopefully</span></div>
<div class="line"><span class="lineno">  275</span> </div>
<div class="line"><span class="lineno">  276</span>        _mm256_storeu_si256(output_loc++, timenow); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  277</span>        <span class="comment">// STORE_MASK(hit_charge);</span></div>
<div class="line"><span class="lineno">  278</span>        _mm256_storeu_si256(output_loc++, <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  279</span>                            _mm256_blendv_epi8(_mm256_set1_epi16(0), hit_charge, left));</div>
<div class="line"><span class="lineno">  280</span>        _mm256_storeu_si256(output_loc++, hit_tover); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  281</span> </div>
<div class="line"><span class="lineno">  282</span>        _mm256_storeu_si256(output_loc++, hit_peak_adc); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  283</span> </div>
<div class="line"><span class="lineno">  284</span>          _mm256_storeu_si256(output_loc++, hit_peak_time); <span class="comment">// NOLINT(runtime/increment_decrement)  </span></div>
<div class="line"><span class="lineno">  285</span> </div>
<div class="line"><span class="lineno">  286</span>        <span class="comment">// Make sure to count only the channels that are above threshold</span></div>
<div class="line"><span class="lineno">  287</span>        <span class="comment">// Store the flags per channel that indicated the waveform went below threshold</span></div>
<div class="line"><span class="lineno">  288</span>        <span class="comment">// in order to recover the exact channel(s) that have complete hits.    </span></div>
<div class="line"><span class="lineno">  289</span>          _mm256_storeu_si256(output_loc++, left); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  290</span> </div>
<div class="line"><span class="lineno">  291</span>        <span class="comment">// reset hit_start, hit_charge and hit_tover in the channels we saved</span></div>
<div class="line"><span class="lineno">  292</span>        <span class="keyword">const</span> __m256i zero = _mm256_setzero_si256();</div>
<div class="line"><span class="lineno">  293</span>        hit_charge = _mm256_blendv_epi8(hit_charge, zero, left);</div>
<div class="line"><span class="lineno">  294</span>        hit_tover = _mm256_blendv_epi8(hit_tover, zero, left);</div>
<div class="line"><span class="lineno">  295</span>        hit_peak_adc = _mm256_blendv_epi8(hit_peak_adc, zero, left);</div>
<div class="line"><span class="lineno">  296</span>        hit_peak_time = _mm256_blendv_epi8(hit_peak_time, zero, left);  </div>
<div class="line"><span class="lineno">  297</span> </div>
<div class="line"><span class="lineno">  298</span>      } <span class="comment">// end if(!no_hits_to_store)</span></div>
<div class="line"><span class="lineno">  299</span>      <span class="comment">//printf(&quot;nhits:          &quot;); std::cout &lt;&lt; (nhits) &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">  300</span> </div>
<div class="line"><span class="lineno">  301</span> </div>
<div class="line"><span class="lineno">  302</span>      prev_was_over = is_over;</div>
<div class="line"><span class="lineno">  303</span> </div>
<div class="line"><span class="lineno">  304</span>    } <span class="comment">// end loop over itime (times for this register)</span></div>
<div class="line"><span class="lineno">  305</span> </div>
<div class="line"><span class="lineno">  306</span> </div>
<div class="line"><span class="lineno">  307</span>    <span class="comment">// Store the state, ready for the next time round</span></div>
<div class="line"><span class="lineno">  308</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>) + ireg, median);      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  309</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile25) + ireg, quantile25); // NOLINT</span></div>
<div class="line"><span class="lineno">  310</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile75) + ireg, quantile75); // NOLINT</span></div>
<div class="line"><span class="lineno">  311</span> </div>
<div class="line"><span class="lineno">  312</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>) + ireg, accum);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  313</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum25) + ireg, accum25); // NOLINT</span></div>
<div class="line"><span class="lineno">  314</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum75) + ireg, accum75); // NOLINT</span></div>
<div class="line"><span class="lineno">  315</span> </div>
<div class="line"><span class="lineno">  316</span> </div>
<div class="line"><span class="lineno">  317</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ad1999924a94240a7e1a80e50dd9d6773">RS</a>) + ireg, RS);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  318</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#af70566bf6e3833535cc95a684c1dc88f">pedestalsRS</a>) + ireg, medianRS); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  319</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a2c33cf4db203f62c39de3f5d3231d6e5">accumRS</a>) + ireg, accumRS); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  320</span>    </div>
<div class="line"><span class="lineno">  321</span> </div>
<div class="line"><span class="lineno">  322</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>) + ireg, prev_was_over); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  323</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>) + ireg, hit_charge);       <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  324</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>) + ireg, hit_tover);         <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  325</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>) + ireg, hit_peak_adc);         <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  326</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>) + ireg, hit_peak_time);         <span class="comment">// NOLINT    </span></div>
<div class="line"><span class="lineno">  327</span> </div>
<div class="line"><span class="lineno">  328</span>  } <span class="comment">// end loop over ireg (the 8 registers in this frame)</span></div>
<div class="line"><span class="lineno">  329</span> </div>
<div class="line"><span class="lineno">  330</span> </div>
<div class="line"><span class="lineno">  331</span>  <span class="comment">// Store the output</span></div>
<div class="line"><span class="lineno">  332</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 7; ++i) {</div>
<div class="line"><span class="lineno">  333</span>    _mm256_storeu_si256(output_loc++, _mm256_set1_epi16(<a class="code hl_variable" href="namespaceswtpg__wibeth.html#afe2e22f04ea0340dd844dc6b56b5b617">swtpg_wibeth::MAGIC</a>)); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  334</span>  }</div>
<div class="line"><span class="lineno">  335</span> </div>
<div class="line"><span class="lineno">  336</span>  <a class="code hl_variable" href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">info</a>.nhits = nhits;</div>
<div class="line"><span class="lineno">  337</span>  <span class="comment">//printf(&quot;Found %d hits\n&quot;, nhits);</span></div>
<div class="line"><span class="lineno">  338</span> </div>
<div class="line"><span class="lineno">  339</span> </div>
<div class="line"><span class="lineno">  340</span>} <span class="comment">// NOLINT(readability/fn_size)</span></div>
<div class="ttc" id="anamespaceswtpg__wibeth_html_a01f29e52679785e2fc8a805a8a18c517"><div class="ttname"><a href="namespaceswtpg__wibeth.html#a01f29e52679785e2fc8a805a8a18c517">swtpg_wibeth::_mm256_div_epi16</a></div><div class="ttdeci">__m256i _mm256_div_epi16(const __m256i va, const int b)</div><div class="ttdef"><b>Definition</b> <a href="UtilsAVX2_8hpp_source.html#l00077">UtilsAVX2.hpp:77</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a53054061d015653bc31f57921c938094" name="a53054061d015653bc31f57921c938094"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a53054061d015653bc31f57921c938094">&#9670;&#160;</a></span>process_window_standard_rs_avx2()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;size_t NREGISTERS&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void swtpg_wibeth::process_window_standard_rs_avx2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structswtpg__wibeth_1_1ProcessingInfo.html">ProcessingInfo</a>&lt; NREGISTERS &gt; &amp;&#160;</td>
          <td class="paramname"><em>info</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="ProcessStandardRSAVX2_8hpp_source.html#l00023">23</a> of file <a class="el" href="ProcessStandardRSAVX2_8hpp_source.html">ProcessStandardRSAVX2.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   24</span>{</div>
<div class="line"><span class="lineno">   25</span> </div>
<div class="line"><span class="lineno">   26</span>  <span class="keyword">const</span> __m256i overflowMax = _mm256_set1_epi16(INT16_MAX);</div>
<div class="line"><span class="lineno">   27</span>      </div>
<div class="line"><span class="lineno">   28</span> </div>
<div class="line"><span class="lineno">   29</span>  <span class="comment">// Running sum scaling factor</span></div>
<div class="line"><span class="lineno">   30</span>  <span class="keyword">const</span> __m256i R_factor = _mm256_set1_epi16(8);</div>
<div class="line"><span class="lineno">   31</span> </div>
<div class="line"><span class="lineno">   32</span>  <span class="comment">// Scaling factor to stop the ADCs from overflowing </span></div>
<div class="line"><span class="lineno">   33</span>  <span class="comment">// (may not needs this, depends on magnitude of FIR output) </span></div>
<div class="line"><span class="lineno">   34</span>  <span class="keyword">const</span> __m256i scale_factor = _mm256_set1_epi16(5);</div>
<div class="line"><span class="lineno">   35</span> </div>
<div class="line"><span class="lineno">   36</span>  <span class="comment">// The maximum value that sigma can have before the threshold overflows a 16-bit signed integer</span></div>
<div class="line"><span class="lineno">   37</span>  <span class="comment">//const __m256i sigmaMax = _mm256_set1_epi16((1 &lt;&lt; 15) / (info.multiplier * info.threshold));</span></div>
<div class="line"><span class="lineno">   38</span> </div>
<div class="line"><span class="lineno">   39</span>  <span class="comment">// Pointer to keep track of where we&#39;ll write the next output hit</span></div>
<div class="line"><span class="lineno">   40</span>  __m256i* output_loc = (__m256i*)(info.output); <span class="comment">// NOLINT(readability/casting)</span></div>
<div class="line"><span class="lineno">   41</span> </div>
<div class="line"><span class="lineno">   42</span>  <span class="keyword">const</span> __m256i iota = _mm256_set_epi16(14, 13, 12, 11, 10, 9, 8, 15, 7, 6, 5, 4, 3, 2, 1, 0);</div>
<div class="line"><span class="lineno">   43</span> </div>
<div class="line"><span class="lineno">   44</span>  <span class="keywordtype">int</span> nhits = 0;</div>
<div class="line"><span class="lineno">   45</span> </div>
<div class="line"><span class="lineno">   46</span>  <span class="keywordflow">for</span> (uint16_t ireg = info.first_register; ireg &lt; info.last_register; ++ireg) { <span class="comment">// NOLINT(build/unsigned)</span></div>
<div class="line"><span class="lineno">   47</span> </div>
<div class="line"><span class="lineno">   48</span>    <span class="comment">//printf(&quot;ireg:          &quot;); std::cout &lt;&lt; (ireg) &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">   49</span> </div>
<div class="line"><span class="lineno">   50</span> </div>
<div class="line"><span class="lineno">   51</span>    <span class="comment">// ------------------------------------</span></div>
<div class="line"><span class="lineno">   52</span>    <span class="comment">// Variables for pedestal subtraction</span></div>
<div class="line"><span class="lineno">   53</span> </div>
<div class="line"><span class="lineno">   54</span>    <span class="comment">// The current estimate of the pedestal in each channel: get</span></div>
<div class="line"><span class="lineno">   55</span>    <span class="comment">// from the previous go-around.</span></div>
<div class="line"><span class="lineno">   56</span> </div>
<div class="line"><span class="lineno">   57</span>    <a class="code hl_struct" href="structswtpg__wibeth_1_1ChanState.html">ChanState&lt;NREGISTERS&gt;</a>&amp; state = info.chanState;</div>
<div class="line"><span class="lineno">   58</span>    __m256i median = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>) + ireg);      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   59</span>    <span class="comment">//__m256i quantile25 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile25) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   60</span>    <span class="comment">//__m256i quantile75 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile75) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   61</span> </div>
<div class="line"><span class="lineno">   62</span>    <span class="comment">// The accumulator that we increase/decrease when the current</span></div>
<div class="line"><span class="lineno">   63</span>    <span class="comment">// sample is greater/less than the median</span></div>
<div class="line"><span class="lineno">   64</span>    __m256i accum = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   65</span>    <span class="comment">//__m256i accum25 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum25) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   66</span>    <span class="comment">//__m256i accum75 = _mm256_lddqu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum75) + ireg); // NOLINT</span></div>
<div class="line"><span class="lineno">   67</span> </div>
<div class="line"><span class="lineno">   68</span>    <span class="comment">// Runnin Sum variables</span></div>
<div class="line"><span class="lineno">   69</span> </div>
<div class="line"><span class="lineno">   70</span>    __m256i RS = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ad1999924a94240a7e1a80e50dd9d6773">RS</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   71</span>    __m256i medianRS = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#af70566bf6e3833535cc95a684c1dc88f">pedestalsRS</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   72</span>    __m256i accumRS = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a2c33cf4db203f62c39de3f5d3231d6e5">accumRS</a>) + ireg);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   73</span> </div>
<div class="line"><span class="lineno">   74</span>    <span class="comment">// ------------------------------------</span></div>
<div class="line"><span class="lineno">   75</span>    <span class="comment">// Variables for hit finding</span></div>
<div class="line"><span class="lineno">   76</span> </div>
<div class="line"><span class="lineno">   77</span>    <span class="comment">// Was the previous step over threshold?</span></div>
<div class="line"><span class="lineno">   78</span>    __m256i prev_was_over = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   79</span>    ;</div>
<div class="line"><span class="lineno">   80</span>    <span class="comment">// The integrated charge (so far) of the current hit</span></div>
<div class="line"><span class="lineno">   81</span>    __m256i hit_charge = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   82</span>    ;</div>
<div class="line"><span class="lineno">   83</span>    <span class="comment">// The time-over-threshold (so far) of the current hit</span></div>
<div class="line"><span class="lineno">   84</span>    __m256i hit_tover = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   85</span>    ;</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>    <span class="comment">// The peak adc value</span></div>
<div class="line"><span class="lineno">   88</span>    __m256i hit_peak_adc = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>) + ireg); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>    <span class="comment">// The time of the peak of the current hit</span></div>
<div class="line"><span class="lineno">   91</span>    __m256i hit_peak_time = _mm256_lddqu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>) + ireg); <span class="comment">// NOLINT    </span></div>
<div class="line"><span class="lineno">   92</span> </div>
<div class="line"><span class="lineno">   93</span>    <span class="comment">// The channel numbers in each of the slots in the register</span></div>
<div class="line"><span class="lineno">   94</span>    __m256i channel_base = _mm256_set1_epi16(ireg * SAMPLES_PER_REGISTER);</div>
<div class="line"><span class="lineno">   95</span>    __m256i channels = _mm256_add_epi16(channel_base, iota);</div>
<div class="line"><span class="lineno">   96</span> </div>
<div class="line"><span class="lineno">   97</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> itime = 0; itime &lt; info.timeWindowNumFrames; ++itime) {</div>
<div class="line"><span class="lineno">   98</span>      <span class="comment">//printf(&quot;itime=%ld\n&quot;, itime);</span></div>
<div class="line"><span class="lineno">   99</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_index = itime / info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">  100</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> msg_time_offset = itime % info.timeWindowNumFrames;</div>
<div class="line"><span class="lineno">  101</span>      <span class="keyword">const</span> <span class="keywordtype">size_t</span> index = msg_index * NREGISTERS * <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a> + <a class="code hl_variable" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a> * ireg + msg_time_offset;</div>
<div class="line"><span class="lineno">  102</span>      <span class="comment">// const __m256i* rawp=reinterpret_cast&lt;const __m256i*&gt;(info.input)+index; // NOLINT</span></div>
<div class="line"><span class="lineno">  103</span> </div>
<div class="line"><span class="lineno">  104</span> </div>
<div class="line"><span class="lineno">  105</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  106</span>      <span class="comment">// Pedestal finding/coherent noise removal</span></div>
<div class="line"><span class="lineno">  107</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  108</span> </div>
<div class="line"><span class="lineno">  109</span> </div>
<div class="line"><span class="lineno">  110</span>      <span class="comment">// The current sample</span></div>
<div class="line"><span class="lineno">  111</span>      __m256i s = info.input-&gt;ymm(index);</div>
<div class="line"><span class="lineno">  112</span>      <span class="comment">//printf(&quot;Input ADC value:\t\t\t\t&quot;); print256_as16_dec(s);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span>      <span class="comment">// Update the median itself in all channels</span></div>
<div class="line"><span class="lineno">  115</span><span class="preprocessor">#pragma GCC diagnostic push</span></div>
<div class="line"><span class="lineno">  116</span><span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Woverflow&quot;</span></div>
<div class="line"><span class="lineno">  117</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#a735ab62c0ab75097f18a50bd37089c21">swtpg_wibeth::frugal_accum_update_avx2</a>(median, s, accum, 10, _mm256_set1_epi16(0xffff));</div>
<div class="line"><span class="lineno">  118</span><span class="preprocessor">#pragma GCC diagnostic pop</span></div>
<div class="line"><span class="lineno">  119</span>      <span class="comment">// Actually subtract the pedestal</span></div>
<div class="line"><span class="lineno">  120</span>      s = _mm256_sub_epi16(s, median);</div>
<div class="line"><span class="lineno">  121</span>      <span class="comment">//printf(&quot;after pedestal:        &quot;); print256_as16_dec(s);        printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  122</span> </div>
<div class="line"><span class="lineno">  123</span> </div>
<div class="line"><span class="lineno">  124</span>    </div>
<div class="line"><span class="lineno">  125</span> </div>
<div class="line"><span class="lineno">  126</span> </div>
<div class="line"><span class="lineno">  127</span>      <span class="comment">//--------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  128</span>      <span class="comment">// Absolute Running Sum</span></div>
<div class="line"><span class="lineno">  129</span>      <span class="comment">//--------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  130</span>      </div>
<div class="line"><span class="lineno">  131</span>      <span class="comment">// Naive: RS = (R_factor * RS) + std::abs(filt)/scale; </span></div>
<div class="line"><span class="lineno">  132</span> </div>
<div class="line"><span class="lineno">  133</span>      <span class="comment">// Instead of using floats in the calcualation of the RS we multiply by 10 and </span></div>
<div class="line"><span class="lineno">  134</span>      <span class="comment">// do operations on the integers. In the end we divide by 10. </span></div>
<div class="line"><span class="lineno">  135</span> </div>
<div class="line"><span class="lineno">  136</span>     __m256i first_part = _mm256_mullo_epi16(RS, R_factor);</div>
<div class="line"><span class="lineno">  137</span>     <span class="comment">//__m256i first_part_div = _mm256_div_epi16(RS, 10);</span></div>
<div class="line"><span class="lineno">  138</span> </div>
<div class="line"><span class="lineno">  139</span>     <span class="comment">//__m256i second_part = s;</span></div>
<div class="line"><span class="lineno">  140</span>     RS = <a class="code hl_function" href="namespaceswtpg__wibeth.html#a01f29e52679785e2fc8a805a8a18c517">swtpg_wibeth::_mm256_div_epi16</a>(_mm256_add_epi16(first_part, s), 10);</div>
<div class="line"><span class="lineno">  141</span> </div>
<div class="line"><span class="lineno">  142</span>     <span class="comment">//printf(&quot;first_part:\t\t\t\t&quot;); print256_as16_dec(first_part);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  143</span>     <span class="comment">//printf(&quot;second_part:\t\t\t\t&quot;); print256_as16_dec(second_part);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  144</span>     <span class="comment">//printf(&quot;RS_value:\t\t\t\t&quot;); print256_as16_dec(RS);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  145</span> </div>
<div class="line"><span class="lineno">  146</span>      <span class="comment">// Update the medianRS itself in all channels</span></div>
<div class="line"><span class="lineno">  147</span>      <span class="comment">//printf(&quot;MedianRS:\t\t\t\t&quot;); print256_as16_dec(medianRS);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  148</span> </div>
<div class="line"><span class="lineno">  149</span><span class="preprocessor">#pragma GCC diagnostic push</span></div>
<div class="line"><span class="lineno">  150</span><span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Woverflow&quot;</span></div>
<div class="line"><span class="lineno">  151</span>      <a class="code hl_function" href="namespaceswtpg__wibeth.html#a735ab62c0ab75097f18a50bd37089c21">swtpg_wibeth::frugal_accum_update_avx2</a>(medianRS, RS, accumRS, 10, _mm256_set1_epi16(0xffff));</div>
<div class="line"><span class="lineno">  152</span><span class="preprocessor">#pragma GCC diagnostic pop</span></div>
<div class="line"><span class="lineno">  153</span> </div>
<div class="line"><span class="lineno">  154</span>      <span class="comment">// __m256i sigma = _mm256_set1_epi16(2000); // 20 ADC</span></div>
<div class="line"><span class="lineno">  155</span>      RS = _mm256_sub_epi16(RS, medianRS);</div>
<div class="line"><span class="lineno">  156</span> </div>
<div class="line"><span class="lineno">  157</span>      <span class="comment">//printf(&quot;RS_after_medianRS:\t\t\t\t&quot;); print256_as16_dec(RS);         printf(&quot;\n&quot;); </span></div>
<div class="line"><span class="lineno">  158</span> </div>
<div class="line"><span class="lineno">  159</span> </div>
<div class="line"><span class="lineno">  160</span> </div>
<div class="line"><span class="lineno">  161</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  162</span>      <span class="comment">// Inter-quantile range</span></div>
<div class="line"><span class="lineno">  163</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  164</span> </div>
<div class="line"><span class="lineno">  165</span>      <span class="comment">// Find the interquartile range</span></div>
<div class="line"><span class="lineno">  166</span>      <span class="comment">//__m256i sigma = _mm256_sub_epi16(quantile75, quantile25);</span></div>
<div class="line"><span class="lineno">  167</span>      </div>
<div class="line"><span class="lineno">  168</span>      <span class="comment">// Clamp sigma to a range where it won&#39;t overflow when</span></div>
<div class="line"><span class="lineno">  169</span>      <span class="comment">// multiplied by info.multiplier*5</span></div>
<div class="line"><span class="lineno">  170</span>      <span class="comment">//sigma = _mm256_min_epi16(sigma, sigmaMax);</span></div>
<div class="line"><span class="lineno">  171</span> </div>
<div class="line"><span class="lineno">  172</span> </div>
<div class="line"><span class="lineno">  173</span> </div>
<div class="line"><span class="lineno">  174</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  175</span>      <span class="comment">// Hit finding</span></div>
<div class="line"><span class="lineno">  176</span>      <span class="comment">// --------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  177</span>      <span class="comment">// Mask for channels that are over the threshold in this step</span></div>
<div class="line"><span class="lineno">  178</span> </div>
<div class="line"><span class="lineno">  179</span>      <span class="comment">// IQR-based THRESHOLD</span></div>
<div class="line"><span class="lineno">  180</span>      <span class="comment">//__m256i is_over = _mm256_cmpgt_epi16(RS, sigma * info.threshold);</span></div>
<div class="line"><span class="lineno">  181</span> </div>
<div class="line"><span class="lineno">  182</span>      <span class="comment">// FIXED THRESHOLD</span></div>
<div class="line"><span class="lineno">  183</span>      __m256i threshold = _mm256_set1_epi16(info.threshold);</div>
<div class="line"><span class="lineno">  184</span>      __m256i is_over = _mm256_cmpgt_epi16(RS, threshold);</div>
<div class="line"><span class="lineno">  185</span> </div>
<div class="line"><span class="lineno">  186</span> </div>
<div class="line"><span class="lineno">  187</span>      <span class="comment">// Mask for channels that left &quot;over threshold&quot; state this step</span></div>
<div class="line"><span class="lineno">  188</span>      __m256i left = _mm256_andnot_si256(is_over, prev_was_over);</div>
<div class="line"><span class="lineno">  189</span> </div>
<div class="line"><span class="lineno">  190</span>      <span class="comment">//-----------------------------------------</span></div>
<div class="line"><span class="lineno">  191</span>      <span class="comment">// Update hit start times for the channels where a hit started</span></div>
<div class="line"><span class="lineno">  192</span>      <span class="keyword">const</span> __m256i timenow = _mm256_set1_epi16(itime);</div>
<div class="line"><span class="lineno">  193</span>      <span class="comment">//-----------------------------------------</span></div>
<div class="line"><span class="lineno">  194</span>      <span class="comment">// Accumulate charge and time-over-threshold in the is_over channels</span></div>
<div class="line"><span class="lineno">  195</span> </div>
<div class="line"><span class="lineno">  196</span>      <span class="comment">// Really want an epi16 version of this, but the cmpgt and</span></div>
<div class="line"><span class="lineno">  197</span>      <span class="comment">// cmplt functions set their epi16 parts to 0xff or 0x0,</span></div>
<div class="line"><span class="lineno">  198</span>      <span class="comment">// so treating everything as epi8 works the same</span></div>
<div class="line"><span class="lineno">  199</span>      __m256i to_add_charge = _mm256_blendv_epi8(_mm256_set1_epi16(0), s, is_over);</div>
<div class="line"><span class="lineno">  200</span>      hit_charge = _mm256_adds_epi16(hit_charge, to_add_charge);</div>
<div class="line"><span class="lineno">  201</span> </div>
<div class="line"><span class="lineno">  202</span>      <span class="comment">// Avoid overflow of the hit charge, if needed in practice </span></div>
<div class="line"><span class="lineno">  203</span>      hit_charge = _mm256_min_epi16(hit_charge, overflowMax);</div>
<div class="line"><span class="lineno">  204</span> </div>
<div class="line"><span class="lineno">  205</span> </div>
<div class="line"><span class="lineno">  206</span>      <span class="comment">//if(ireg==0){</span></div>
<div class="line"><span class="lineno">  207</span>      <span class="comment">//     printf(&quot;itime=%ld\n&quot;, itime);</span></div>
<div class="line"><span class="lineno">  208</span>      <span class="comment">//     printf(&quot;s:             &quot;); print256_as16_dec(s);             printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  209</span>      <span class="comment">//     printf(&quot;median:        &quot;); print256_as16_dec(median);        printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  210</span>      <span class="comment">//     printf(&quot;RS:         &quot;); print256_as16_dec(RS);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  211</span>      <span class="comment">//     printf(&quot;sigma:         &quot;); print256_as16_dec(sigma);         printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  212</span>      <span class="comment">//     printf(&quot;filt:          &quot;); print256_as16_dec(filt);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  213</span>      <span class="comment">//     printf(&quot;to_add_charge: &quot;); print256_as16_dec(to_add_charge); printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  214</span>      <span class="comment">//     printf(&quot;hit_charge:    &quot;); print256_as16_dec(hit_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  215</span>      <span class="comment">//     printf(&quot;channels:    &quot;); print256_as16_dec(channels);    printf(&quot;\n&quot;);     </span></div>
<div class="line"><span class="lineno">  216</span>      <span class="comment">//     printf(&quot;is_over:          &quot;); print256_as16_dec(is_over);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  217</span>      <span class="comment">//     printf(&quot;left:          &quot;); print256_as16_dec(left);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  218</span>      <span class="comment">//}</span></div>
<div class="line"><span class="lineno">  219</span> </div>
<div class="line"><span class="lineno">  220</span>      <span class="comment">// 1. Calculation of the hit peak time and ADC</span></div>
<div class="line"><span class="lineno">  221</span>      __m256i is_sample_over_adc_peak = _mm256_cmpgt_epi16(s, hit_peak_adc);</div>
<div class="line"><span class="lineno">  222</span>      hit_peak_adc = _mm256_blendv_epi8(hit_peak_adc, s, is_sample_over_adc_peak); </div>
<div class="line"><span class="lineno">  223</span>      hit_peak_time = _mm256_blendv_epi8(hit_peak_time, hit_tover, is_sample_over_adc_peak);</div>
<div class="line"><span class="lineno">  224</span> </div>
<div class="line"><span class="lineno">  225</span>      <span class="comment">// 2. Update of the hit time over threshold  </span></div>
<div class="line"><span class="lineno">  226</span>      __m256i to_add_tover = _mm256_blendv_epi8(_mm256_set1_epi16(0), _mm256_set1_epi16(1), is_over);</div>
<div class="line"><span class="lineno">  227</span>      hit_tover = _mm256_adds_epi16(hit_tover, to_add_tover);</div>
<div class="line"><span class="lineno">  228</span> </div>
<div class="line"><span class="lineno">  229</span>      <span class="comment">// 3. Stop tover from overflowing if needed in practice </span></div>
<div class="line"><span class="lineno">  230</span>      <span class="comment">//hit_tover = _mm256_min_epi16(hit_tover, overflowMax);      </span></div>
<div class="line"><span class="lineno">  231</span> </div>
<div class="line"><span class="lineno">  232</span>      <span class="comment">// Only store the values if there are &gt;0 hits ending on</span></div>
<div class="line"><span class="lineno">  233</span>      <span class="comment">// this sample. We have to save the entire 16-channel</span></div>
<div class="line"><span class="lineno">  234</span>      <span class="comment">// register, which is inefficient, but whatever</span></div>
<div class="line"><span class="lineno">  235</span> </div>
<div class="line"><span class="lineno">  236</span>      <span class="comment">// Testing whether a whole register is zeroes turns out to be tricky. Here&#39;s a way:</span></div>
<div class="line"><span class="lineno">  237</span>      <span class="comment">//</span></div>
<div class="line"><span class="lineno">  238</span>      <span class="comment">// https://stackoverflow.com/questions/22674205/is-there-an-or-equivalent-to-ptest-in-x64-assembly</span></div>
<div class="line"><span class="lineno">  239</span>      <span class="comment">//</span></div>
<div class="line"><span class="lineno">  240</span>      <span class="comment">// In x64 assembly, PTEST %XMM0 -&gt; %XMM1 sets the</span></div>
<div class="line"><span class="lineno">  241</span>      <span class="comment">// zero-flag if none of the same bits are set in %XMM0 and</span></div>
<div class="line"><span class="lineno">  242</span>      <span class="comment">// %XMM1, and sets the carry-flag if everything that is</span></div>
<div class="line"><span class="lineno">  243</span>      <span class="comment">// set in %XMM0 is also set in %XMM1:</span></div>
<div class="line"><span class="lineno">  244</span>      <span class="keyword">const</span> <span class="keywordtype">int</span> no_hits_to_store = _mm256_testc_si256(_mm256_setzero_si256(), left);</div>
<div class="line"><span class="lineno">  245</span>      <span class="comment">//printf(&quot;left:          &quot;); print256_as16_dec(left);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  246</span> </div>
<div class="line"><span class="lineno">  247</span> </div>
<div class="line"><span class="lineno">  248</span>      <span class="keywordflow">if</span> (!no_hits_to_store) {</div>
<div class="line"><span class="lineno">  249</span> </div>
<div class="line"><span class="lineno">  250</span> </div>
<div class="line"><span class="lineno">  251</span>        ++nhits;</div>
<div class="line"><span class="lineno">  252</span>        <span class="comment">// We have to save the whole register, including the</span></div>
<div class="line"><span class="lineno">  253</span>        <span class="comment">// lanes that don&#39;t have anything interesting, but</span></div>
<div class="line"><span class="lineno">  254</span>        <span class="comment">// we&#39;ll mask them to zero so they&#39;re easy to remove</span></div>
<div class="line"><span class="lineno">  255</span>        <span class="comment">// in a later processing step.</span></div>
<div class="line"><span class="lineno">  256</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  257</span>        <span class="comment">// (TODO: Maybe we should do that processing step in this function?)</span></div>
<div class="line"><span class="lineno">  258</span>        <span class="comment">//#define STORE_MASK(x) _mm256_storeu_si256(output_loc++, _mm256_blendv_epi8(_mm256_set1_epi16(0), x, left));</span></div>
<div class="line"><span class="lineno">  259</span> </div>
<div class="line"><span class="lineno">  260</span>        _mm256_storeu_si256(output_loc++, channels); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  261</span>        <span class="comment">//printf(&quot;channels:          &quot;); print256_as16_dec(channels);          printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  262</span>        <span class="comment">//printf(&quot;to_add_charge:    &quot;); print256_as16_dec(to_add_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  263</span>        <span class="comment">//printf(&quot;hit_charge:    &quot;); print256_as16_dec(hit_charge);    printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  264</span>        <span class="comment">//printf(&quot;to_add_tover:    &quot;); print256_as16_dec(to_add_tover);    printf(&quot;\n&quot;);      </span></div>
<div class="line"><span class="lineno">  265</span>        <span class="comment">//printf(&quot;hit_tover:    &quot;); print256_as16_dec(hit_tover);    printf(&quot;\n&quot;);      </span></div>
<div class="line"><span class="lineno">  266</span> </div>
<div class="line"><span class="lineno">  267</span>        <span class="comment">// Store the end time of the hit, not the start</span></div>
<div class="line"><span class="lineno">  268</span>        <span class="comment">// time. Since we also have the time-over-threshold,</span></div>
<div class="line"><span class="lineno">  269</span>        <span class="comment">// we can calculate the absolute 64-bit start time in</span></div>
<div class="line"><span class="lineno">  270</span>        <span class="comment">// the caller. This saves faffing with hits that span</span></div>
<div class="line"><span class="lineno">  271</span>        <span class="comment">// a message boundary, hopefully</span></div>
<div class="line"><span class="lineno">  272</span> </div>
<div class="line"><span class="lineno">  273</span>        _mm256_storeu_si256(output_loc++, timenow); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  274</span>        <span class="comment">// STORE_MASK(hit_charge);</span></div>
<div class="line"><span class="lineno">  275</span>        _mm256_storeu_si256(output_loc++, <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  276</span>                            _mm256_blendv_epi8(_mm256_set1_epi16(0), hit_charge, left));</div>
<div class="line"><span class="lineno">  277</span>        _mm256_storeu_si256(output_loc++, hit_tover); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  278</span> </div>
<div class="line"><span class="lineno">  279</span>        _mm256_storeu_si256(output_loc++, hit_peak_adc); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  280</span> </div>
<div class="line"><span class="lineno">  281</span>      _mm256_storeu_si256(output_loc++, hit_peak_time); <span class="comment">// NOLINT(runtime/increment_decrement)  </span></div>
<div class="line"><span class="lineno">  282</span> </div>
<div class="line"><span class="lineno">  283</span>        <span class="comment">// Make sure to count only the channels that are above threshold</span></div>
<div class="line"><span class="lineno">  284</span>        <span class="comment">// Store the flags per channel that indicated the waveform went below threshold</span></div>
<div class="line"><span class="lineno">  285</span>        <span class="comment">// in order to recover the exact channel(s) that have complete hits.    </span></div>
<div class="line"><span class="lineno">  286</span>      _mm256_storeu_si256(output_loc++, left); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  287</span> </div>
<div class="line"><span class="lineno">  288</span>        <span class="comment">// reset hit_start, hit_charge and hit_tover in the channels we saved</span></div>
<div class="line"><span class="lineno">  289</span>        <span class="keyword">const</span> __m256i zero = _mm256_setzero_si256();</div>
<div class="line"><span class="lineno">  290</span>        hit_charge = _mm256_blendv_epi8(hit_charge, zero, left);</div>
<div class="line"><span class="lineno">  291</span>        hit_tover = _mm256_blendv_epi8(hit_tover, zero, left);</div>
<div class="line"><span class="lineno">  292</span>        hit_peak_adc = _mm256_blendv_epi8(hit_peak_adc, zero, left);</div>
<div class="line"><span class="lineno">  293</span>        hit_peak_time = _mm256_blendv_epi8(hit_peak_time, zero, left);  </div>
<div class="line"><span class="lineno">  294</span> </div>
<div class="line"><span class="lineno">  295</span>      } <span class="comment">// end if(!no_hits_to_store)</span></div>
<div class="line"><span class="lineno">  296</span>      <span class="comment">//printf(&quot;nhits:          &quot;); std::cout &lt;&lt; (nhits) &lt;&lt; std::endl;</span></div>
<div class="line"><span class="lineno">  297</span> </div>
<div class="line"><span class="lineno">  298</span> </div>
<div class="line"><span class="lineno">  299</span>      prev_was_over = is_over;</div>
<div class="line"><span class="lineno">  300</span> </div>
<div class="line"><span class="lineno">  301</span>    } <span class="comment">// end loop over itime (times for this register)</span></div>
<div class="line"><span class="lineno">  302</span> </div>
<div class="line"><span class="lineno">  303</span> </div>
<div class="line"><span class="lineno">  304</span>    <span class="comment">// Store the state, ready for the next time round</span></div>
<div class="line"><span class="lineno">  305</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ab15580827204936dbfba55ae050b2a93">pedestals</a>) + ireg, median);      <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  306</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile25) + ireg, quantile25); // NOLINT</span></div>
<div class="line"><span class="lineno">  307</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.quantile75) + ireg, quantile75); // NOLINT</span></div>
<div class="line"><span class="lineno">  308</span> </div>
<div class="line"><span class="lineno">  309</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#aabfea33b4e6599246a071a2f53c4342c">accum</a>) + ireg, accum);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  310</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum25) + ireg, accum25); // NOLINT</span></div>
<div class="line"><span class="lineno">  311</span>    <span class="comment">//_mm256_storeu_si256(reinterpret_cast&lt;__m256i*&gt;(state.accum75) + ireg, accum75); // NOLINT</span></div>
<div class="line"><span class="lineno">  312</span> </div>
<div class="line"><span class="lineno">  313</span> </div>
<div class="line"><span class="lineno">  314</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#ad1999924a94240a7e1a80e50dd9d6773">RS</a>) + ireg, RS);     <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  315</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#af70566bf6e3833535cc95a684c1dc88f">pedestalsRS</a>) + ireg, medianRS); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  316</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a2c33cf4db203f62c39de3f5d3231d6e5">accumRS</a>) + ireg, accumRS); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  317</span>    </div>
<div class="line"><span class="lineno">  318</span> </div>
<div class="line"><span class="lineno">  319</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a79fffc7052fb5399a22ae95012f2d580">prev_was_over</a>) + ireg, prev_was_over); <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  320</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a4d58fa8042eca78e5cf6ac55fc41e884">hit_charge</a>) + ireg, hit_charge);       <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  321</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a30b1bdc4ba9eca41c4ee1498a0e6e26e">hit_tover</a>) + ireg, hit_tover);         <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  322</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a820e6edfd09813d719a07bda8e3ad198">hit_peak_adc</a>) + ireg, hit_peak_adc);         <span class="comment">// NOLINT</span></div>
<div class="line"><span class="lineno">  323</span>    _mm256_storeu_si256(<span class="keyword">reinterpret_cast&lt;</span>__m256i*<span class="keyword">&gt;</span>(state.<a class="code hl_variable" href="structswtpg__wibeth_1_1ChanState.html#a7077372a4d647714c384400493ca14f5">hit_peak_time</a>) + ireg, hit_peak_time);         <span class="comment">// NOLINT    </span></div>
<div class="line"><span class="lineno">  324</span> </div>
<div class="line"><span class="lineno">  325</span>  } <span class="comment">// end loop over ireg (the 8 registers in this frame)</span></div>
<div class="line"><span class="lineno">  326</span> </div>
<div class="line"><span class="lineno">  327</span> </div>
<div class="line"><span class="lineno">  328</span>  <span class="comment">// Store the output</span></div>
<div class="line"><span class="lineno">  329</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 7; ++i) {</div>
<div class="line"><span class="lineno">  330</span>    _mm256_storeu_si256(output_loc++, _mm256_set1_epi16(<a class="code hl_variable" href="namespaceswtpg__wibeth.html#afe2e22f04ea0340dd844dc6b56b5b617">swtpg_wibeth::MAGIC</a>)); <span class="comment">// NOLINT(runtime/increment_decrement)</span></div>
<div class="line"><span class="lineno">  331</span>  }</div>
<div class="line"><span class="lineno">  332</span> </div>
<div class="line"><span class="lineno">  333</span>  <a class="code hl_variable" href="namespacereadout-affinity.html#abe2db36c4d39fa615239b96236911da9">info</a>.nhits = nhits;</div>
<div class="line"><span class="lineno">  334</span>  <span class="comment">//printf(&quot;Found %d hits\n&quot;, nhits);</span></div>
<div class="line"><span class="lineno">  335</span> </div>
<div class="line"><span class="lineno">  336</span> </div>
<div class="line"><span class="lineno">  337</span>} <span class="comment">// NOLINT(readability/fn_size)</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a60047280d41446f026abb36e0519a52d" name="a60047280d41446f026abb36e0519a52d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a60047280d41446f026abb36e0519a52d">&#9670;&#160;</a></span>sinc()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double swtpg_wibeth::sinc </td>
          <td>(</td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>x</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="DesignFIR_8cpp_source.html#l00031">31</a> of file <a class="el" href="DesignFIR_8cpp_source.html">DesignFIR.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   32</span>{</div>
<div class="line"><span class="lineno">   33</span>  <span class="keywordflow">if</span> (x == 0) {</div>
<div class="line"><span class="lineno">   34</span>    <span class="keywordflow">return</span> 1;</div>
<div class="line"><span class="lineno">   35</span>  }</div>
<div class="line"><span class="lineno">   36</span>  <span class="keywordflow">return</span> sin(pi() * x) / (pi() * x);</div>
<div class="line"><span class="lineno">   37</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a62216747dda630d556f9650402937dfc" name="a62216747dda630d556f9650402937dfc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a62216747dda630d556f9650402937dfc">&#9670;&#160;</a></span>unpack_one_register()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">__m256i swtpg_wibeth::unpack_one_register </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classdunedaq_1_1fddetdataformats_1_1WIBEthFrame.html#aa8ee70c3aa9e15d5fe3e1601c002be65">dunedaq::fddetdataformats::WIBEthFrame::word_t</a> *&#160;</td>
          <td class="paramname"><em>first_word</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="FrameExpand_8hpp_source.html#l00084">84</a> of file <a class="el" href="FrameExpand_8hpp_source.html">FrameExpand.hpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   85</span>{</div>
<div class="line"><span class="lineno">   86</span>    __m256i reg=_mm256_lddqu_si256((__m256i*)first_word);</div>
<div class="line"><span class="lineno">   87</span>    <span class="comment">// printf(&quot;Input:      &quot;);</span></div>
<div class="line"><span class="lineno">   88</span>    <span class="comment">// print256(reg);</span></div>
<div class="line"><span class="lineno">   89</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">   90</span> </div>
<div class="line"><span class="lineno">   91</span>    <span class="comment">// The register initially contains 18-and-a-bit 14-bit ADCs, but</span></div>
<div class="line"><span class="lineno">   92</span>    <span class="comment">// we only have space for 16 after expansion, so the last 32-bit</span></div>
<div class="line"><span class="lineno">   93</span>    <span class="comment">// word is unused. Copy word 3 so it appears twice, and move the</span></div>
<div class="line"><span class="lineno">   94</span>    <span class="comment">// later words down one</span></div>
<div class="line"><span class="lineno">   95</span>    __m256i idx=_mm256_set_epi32(6, 5, 4, 3, 3, 2, 1, 0);</div>
<div class="line"><span class="lineno">   96</span>    __m256i shuf1=_mm256_permutevar8x32_epi32(reg, idx);</div>
<div class="line"><span class="lineno">   97</span>    <span class="comment">// printf(&quot;shuf1:      &quot;);</span></div>
<div class="line"><span class="lineno">   98</span>    <span class="comment">// print256(shuf1);</span></div>
<div class="line"><span class="lineno">   99</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  100</span> </div>
<div class="line"><span class="lineno">  101</span>    <span class="comment">// Each 32-bit word contains at least one full 14-bit ADC. Shift</span></div>
<div class="line"><span class="lineno">  102</span>    <span class="comment">// the words by variable amounts s.t. the high 16 bits of each</span></div>
<div class="line"><span class="lineno">  103</span>    <span class="comment">// word contains a 14-bit ADC at the right place (with the two</span></div>
<div class="line"><span class="lineno">  104</span>    <span class="comment">// high bits still needing to be masked to zero). That result is</span></div>
<div class="line"><span class="lineno">  105</span>    <span class="comment">// in `high_half`</span></div>
<div class="line"><span class="lineno">  106</span>    <span class="comment">// __mmask8 mask=0xffu;</span></div>
<div class="line"><span class="lineno">  107</span>    <span class="comment">// __m256i src=_mm256_set1_epi32(0);</span></div>
<div class="line"><span class="lineno">  108</span>    <span class="comment">// The amounts by which we shift each 32-bit word</span></div>
<div class="line"><span class="lineno">  109</span>    __m256i count1=_mm256_set_epi32(12, 8, 4, 0, 14, 10, 6, 2);</div>
<div class="line"><span class="lineno">  110</span>    <span class="comment">// __m256i high_half=_mm256_mask_sllv_epi32(src, mask, shuf1, count1);</span></div>
<div class="line"><span class="lineno">  111</span>    __m256i high_half=_mm256_sllv_epi32(shuf1, count1);</div>
<div class="line"><span class="lineno">  112</span>    <span class="comment">// Mask out the low 16 bits, and the high two bits in the high half</span></div>
<div class="line"><span class="lineno">  113</span>    __m256i high_half_mask=_mm256_set1_epi32(0x3fff0000u);</div>
<div class="line"><span class="lineno">  114</span> </div>
<div class="line"><span class="lineno">  115</span>    high_half=_mm256_and_si256(high_half, high_half_mask);</div>
<div class="line"><span class="lineno">  116</span>    <span class="comment">// high_half2=_mm256_and_si256(high_half2, high_half_mask);</span></div>
<div class="line"><span class="lineno">  117</span> </div>
<div class="line"><span class="lineno">  118</span>    <span class="comment">// printf(&quot;high_half:  &quot;);</span></div>
<div class="line"><span class="lineno">  119</span>    <span class="comment">// print256(high_half);</span></div>
<div class="line"><span class="lineno">  120</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  121</span> </div>
<div class="line"><span class="lineno">  122</span>    <span class="comment">//------------------------------------------------------------------</span></div>
<div class="line"><span class="lineno">  123</span>    <span class="comment">// Now we start the process of setting the low 16 bits of each</span></div>
<div class="line"><span class="lineno">  124</span>    <span class="comment">// word to the right value. This is trickier because now the bits</span></div>
<div class="line"><span class="lineno">  125</span>    <span class="comment">// are spread across two words. First, left-shift each word so</span></div>
<div class="line"><span class="lineno">  126</span>    <span class="comment">// that the higher bits of the ADC are in the right place</span></div>
<div class="line"><span class="lineno">  127</span>    __m256i count2=_mm256_set_epi32(10, 6, 2, 0, 12, 8, 4, 0);</div>
<div class="line"><span class="lineno">  128</span>    __m256i shift2=_mm256_sllv_epi32(shuf1, count2);</div>
<div class="line"><span class="lineno">  129</span>    <span class="comment">// printf(&quot;shift2:     &quot;);</span></div>
<div class="line"><span class="lineno">  130</span>    <span class="comment">// print256(shift2);</span></div>
<div class="line"><span class="lineno">  131</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  132</span> </div>
<div class="line"><span class="lineno">  133</span>    <span class="comment">// Next, permute the register so that the words containing the low</span></div>
<div class="line"><span class="lineno">  134</span>    <span class="comment">// bits of the ADCs we want are in the same positions as the words</span></div>
<div class="line"><span class="lineno">  135</span>    <span class="comment">// containing the corresponding high bits. This just amounts to</span></div>
<div class="line"><span class="lineno">  136</span>    <span class="comment">// moving the words down by one</span></div>
<div class="line"><span class="lineno">  137</span>    __m256i idx2=_mm256_set_epi32(5, 4, 3, 2, 2, 1, 0, 0);</div>
<div class="line"><span class="lineno">  138</span>    __m256i shuf2=_mm256_permutevar8x32_epi32(reg, idx2);</div>
<div class="line"><span class="lineno">  139</span>    <span class="comment">// printf(&quot;shuf2:      &quot;);</span></div>
<div class="line"><span class="lineno">  140</span>    <span class="comment">// print256(shuf2);</span></div>
<div class="line"><span class="lineno">  141</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  142</span> </div>
<div class="line"><span class="lineno">  143</span>    <span class="comment">// Shift each word right by the amount that brings those low bits</span></div>
<div class="line"><span class="lineno">  144</span>    <span class="comment">// into the right place, putting the result in `shift3`</span></div>
<div class="line"><span class="lineno">  145</span>    __m256i count3=_mm256_set_epi32(22, 26, 30, 0, 20, 24, 28, 0);</div>
<div class="line"><span class="lineno">  146</span>    __m256i shift3=_mm256_srlv_epi32(shuf2, count3);</div>
<div class="line"><span class="lineno">  147</span>    <span class="comment">// printf(&quot;shift3:     &quot;);</span></div>
<div class="line"><span class="lineno">  148</span>    <span class="comment">// print256(shift3);</span></div>
<div class="line"><span class="lineno">  149</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  150</span> </div>
<div class="line"><span class="lineno">  151</span>    <span class="comment">// OR together the registers containing the high and low bits of</span></div>
<div class="line"><span class="lineno">  152</span>    <span class="comment">// the ADCs. At this point, the low 16 bits of each word should</span></div>
<div class="line"><span class="lineno">  153</span>    <span class="comment">// contain the 14 bits of the ADCs in the right place (with the</span></div>
<div class="line"><span class="lineno">  154</span>    <span class="comment">// two high bits still needing to be masked out)</span></div>
<div class="line"><span class="lineno">  155</span>    __m256i low_half=_mm256_or_si256(shift2, shift3);</div>
<div class="line"><span class="lineno">  156</span>    <span class="comment">// Mask out the high 16 bits, and the high two bits in the high half</span></div>
<div class="line"><span class="lineno">  157</span>    __m256i low_half_mask=_mm256_set1_epi32(0x3fffu);</div>
<div class="line"><span class="lineno">  158</span>    low_half=_mm256_and_si256(low_half, low_half_mask);</div>
<div class="line"><span class="lineno">  159</span>    <span class="comment">// printf(&quot;low_half:   &quot;);</span></div>
<div class="line"><span class="lineno">  160</span>    <span class="comment">// print256(low_half);</span></div>
<div class="line"><span class="lineno">  161</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  162</span> </div>
<div class="line"><span class="lineno">  163</span>    <span class="comment">// Nearly there... Now we OR together the low and high halves</span></div>
<div class="line"><span class="lineno">  164</span>    __m256i both=_mm256_or_si256(low_half, high_half);</div>
<div class="line"><span class="lineno">  165</span>    <span class="comment">// zero out the slot where we want to put the 16th value</span></div>
<div class="line"><span class="lineno">  166</span>    both=_mm256_andnot_si256(_mm256_set_epi32(0, 0, 0, 0xffffu, 0, 0, 0, 0), both);</div>
<div class="line"><span class="lineno">  167</span>    <span class="comment">// printf(&quot;both:       &quot;);</span></div>
<div class="line"><span class="lineno">  168</span>    <span class="comment">// print256(both);</span></div>
<div class="line"><span class="lineno">  169</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  170</span> </div>
<div class="line"><span class="lineno">  171</span>    <span class="comment">// We just missed the 16th value, and the lw 16 bits of the 8th</span></div>
<div class="line"><span class="lineno">  172</span>    <span class="comment">// word are available, so shuffle it around to put it there</span></div>
<div class="line"><span class="lineno">  173</span>    __m256i shift4=_mm256_srli_epi32(reg, 18);</div>
<div class="line"><span class="lineno">  174</span>    <span class="comment">// Mask so that&#39;s the only nonzero thing</span></div>
<div class="line"><span class="lineno">  175</span>    shift4=_mm256_and_si256(_mm256_set_epi32(0, 0x3fffu, 0, 0, 0, 0, 0, 0), shift4);</div>
<div class="line"><span class="lineno">  176</span>    <span class="comment">// Move the word containing the value we want into the position we want</span></div>
<div class="line"><span class="lineno">  177</span>    __m256i idx3=_mm256_set_epi32(0, 0, 0, 6, 0, 0, 0, 0);</div>
<div class="line"><span class="lineno">  178</span>    __m256i shuf3=_mm256_permutevar8x32_epi32(shift4, idx3);</div>
<div class="line"><span class="lineno">  179</span> </div>
<div class="line"><span class="lineno">  180</span>    both=_mm256_or_si256(both, shuf3);</div>
<div class="line"><span class="lineno">  181</span>    <span class="comment">// printf(&quot;both&#39;:      &quot;);</span></div>
<div class="line"><span class="lineno">  182</span>    <span class="comment">// print256(both);</span></div>
<div class="line"><span class="lineno">  183</span>    <span class="comment">// printf(&quot;\n&quot;);</span></div>
<div class="line"><span class="lineno">  184</span> </div>
<div class="line"><span class="lineno">  185</span>    <span class="keywordflow">return</span> both;</div>
<div class="line"><span class="lineno">  186</span>}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a61ae264aec55185352ee186b065b92a1" name="a61ae264aec55185352ee186b065b92a1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a61ae264aec55185352ee186b065b92a1">&#9670;&#160;</a></span>ADCS_SIZE</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const constexpr std::size_t swtpg_wibeth::ADCS_SIZE = <a class="el" href="namespaceswtpg__wibeth.html#a6c9009fe10d668dcbf330263cffae42a">BYTES_PER_REGISTER</a> * <a class="el" href="namespaceswtpg__wibeth.html#a35bc84983ac065eb2d0981e169ea3f61">NUM_REGISTERS_PER_FRAME</a> * <a class="el" href="namespaceswtpg__wibeth.html#adf6e94bcecc2386891f69bacfcf7ed3a">FRAMES_PER_MSG</a></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="TPGConstants__wibeth_8hpp_source.html#l00036">36</a> of file <a class="el" href="TPGConstants__wibeth_8hpp_source.html">TPGConstants_wibeth.hpp</a>.</p>

</div>
</div>
<a id="a6c9009fe10d668dcbf330263cffae42a" name="a6c9009fe10d668dcbf330263cffae42a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6c9009fe10d668dcbf330263cffae42a">&#9670;&#160;</a></span>BYTES_PER_REGISTER</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const constexpr std::size_t swtpg_wibeth::BYTES_PER_REGISTER = 32</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="TPGConstants__wibeth_8hpp_source.html#l00028">28</a> of file <a class="el" href="TPGConstants__wibeth_8hpp_source.html">TPGConstants_wibeth.hpp</a>.</p>

</div>
</div>
<a id="adf6e94bcecc2386891f69bacfcf7ed3a" name="adf6e94bcecc2386891f69bacfcf7ed3a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adf6e94bcecc2386891f69bacfcf7ed3a">&#9670;&#160;</a></span>FRAMES_PER_MSG</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const constexpr std::size_t swtpg_wibeth::FRAMES_PER_MSG = 64</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="TPGConstants__wibeth_8hpp_source.html#l00022">22</a> of file <a class="el" href="TPGConstants__wibeth_8hpp_source.html">TPGConstants_wibeth.hpp</a>.</p>

</div>
</div>
<a id="afe2e22f04ea0340dd844dc6b56b5b617" name="afe2e22f04ea0340dd844dc6b56b5b617"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe2e22f04ea0340dd844dc6b56b5b617">&#9670;&#160;</a></span>MAGIC</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const constexpr std::uint16_t swtpg_wibeth::MAGIC = std::numeric_limits&lt;std::uint16_t&gt;::max()</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="TPGConstants__wibeth_8hpp_source.html#l00017">17</a> of file <a class="el" href="TPGConstants__wibeth_8hpp_source.html">TPGConstants_wibeth.hpp</a>.</p>

</div>
</div>
<a id="a35bc84983ac065eb2d0981e169ea3f61" name="a35bc84983ac065eb2d0981e169ea3f61"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a35bc84983ac065eb2d0981e169ea3f61">&#9670;&#160;</a></span>NUM_REGISTERS_PER_FRAME</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const constexpr std::size_t swtpg_wibeth::NUM_REGISTERS_PER_FRAME = 4</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="TPGConstants__wibeth_8hpp_source.html#l00025">25</a> of file <a class="el" href="TPGConstants__wibeth_8hpp_source.html">TPGConstants_wibeth.hpp</a>.</p>

</div>
</div>
<a id="a65e5e08d51fb120e9f5566ed5d578df6" name="a65e5e08d51fb120e9f5566ed5d578df6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a65e5e08d51fb120e9f5566ed5d578df6">&#9670;&#160;</a></span>SAMPLES_PER_REGISTER</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const constexpr std::size_t swtpg_wibeth::SAMPLES_PER_REGISTER = 16</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="TPGConstants__wibeth_8hpp_source.html#l00031">31</a> of file <a class="el" href="TPGConstants__wibeth_8hpp_source.html">TPGConstants_wibeth.hpp</a>.</p>

</div>
</div>
<a id="ab5fe2d67a9fc85ab560254eb6e6748ef" name="ab5fe2d67a9fc85ab560254eb6e6748ef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab5fe2d67a9fc85ab560254eb6e6748ef">&#9670;&#160;</a></span>THRESHOLD</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const constexpr std::int16_t swtpg_wibeth::THRESHOLD = 2000</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="TPGConstants__wibeth_8hpp_source.html#l00019">19</a> of file <a class="el" href="TPGConstants__wibeth_8hpp_source.html">TPGConstants_wibeth.hpp</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
