<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Overview</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md353"></a> The <em>hdflibs</em> repository contains the classes that are used for interfacing between <em>dunedaq</em> data applications (writers and readers) and the <a href="https://github.com/BlueBrain/HighFive">HighFive</a> library to read/write HDF5 files.</p>
<p>There are two main classes in use:</p><ul>
<li>`HDF5FileLayout` governs the layout of DUNE DAQ raw data files, including configurable parameters for the names of groups and datasets (<em>e.g.</em> how many digits to use for numbers in names, what to call the groups for TPC data, its underlying regions, etc.), and it includes member functions that use the layout to allow for construction of group and dataset names.</li>
<li>`HDF5RawDataFile` is the main interface for writing and reading HDF files, containing functions to write data and attributres to the files, and functions for reading back that data and attributes, as well as some utilities for file investigation.</li>
</ul>
<p>More details on those classes are in the sections below, but some important interface points:</p><ul>
<li><code>HDF5RawDataFile</code> handles only one file at a time. It opens it on construction, and closes it on deletion. If writing multiple files, one will need multiple <code>HDF5RawDataFile</code> objects.</li>
<li>There is no handling for conditions on if/when data should be written to a file, only where in that file it should be written. It is the responsibility of data writer applications to handle conditions on when to switch to a new file (<em>e.g.</em> when reaching maximum file size, or having written a desired number of events).</li>
</ul>
<p>The general structure of written files is as follows: </p><div class="fragment"><div class="line">&lt;File-Level-Attributes&gt;</div>
<div class="line"> </div>
<div class="line">GROUP Top-Level-Record</div>
<div class="line">  </div>
<div class="line">  DATASET Record-Header</div>
<div class="line">  </div>
<div class="line">  GROUP System-Type-Group</div>
<div class="line">    GROUP Region-Group</div>
<div class="line">      DATASET Element-Data</div>
</div><!-- fragment --><p> Note that names of datasets and groups are not as shown, and instead are configurable on writing, and later determined by the attributes "filelayout_params".</p>
<p>There are example programs in <code>app</code> &ndash; <code>HDF5LIBS_TestWriter</code> and <code>HDF5LIBS_TestReader</code> &ndash; that show how to use these classes in simple C++ applications. <code>HDF5LIBS_TestReader.py</code> shows how to read files using HDF5RawDataFile from a python interface.</p>
<h2><a class="anchor" id="autotoc_md354"></a>
HDF5FileLayout</h2>
<p>This class defines the file layout of <em>dunedaq</em> raw data files. It receives a <code>hdf5filelayout::FileLayoutParams</code> object for configuration, which looks like the following in json: </p><div class="fragment"><div class="line">&quot;file_layout_parameters&quot;:{</div>
<div class="line">  &quot;trigger_record_name_prefix&quot;: &quot;TriggerRecord&quot;,</div>
<div class="line">  &quot;digits_for_trigger_number&quot;: 6,</div>
<div class="line">  &quot;digits_for_sequence_number&quot;: 0,</div>
<div class="line">  &quot;trigger_record_header_dataset_name&quot;: &quot;TriggerRecordHeader&quot;,</div>
<div class="line"> </div>
<div class="line">  &quot;path_param_list&quot;:[ {&quot;detector_group_type&quot;:&quot;TPC&quot;,</div>
<div class="line">                       &quot;detector_group_name&quot;:&quot;TPC&quot;,</div>
<div class="line">                       &quot;region_name_prefix&quot;:&quot;APA&quot;,</div>
<div class="line">                       &quot;digits_for_region_number&quot;:3,</div>
<div class="line">                       &quot;element_name_prefix&quot;:&quot;Link&quot;,</div>
<div class="line">                       &quot;digits_for_element_number&quot;:2},</div>
<div class="line">                      {&quot;detector_group_type&quot;:&quot;PDS&quot;,</div>
<div class="line">                       &quot;detector_group_name&quot;:&quot;PDS&quot;,</div>
<div class="line">                       &quot;region_name_prefix&quot;:&quot;Region&quot;,</div>
<div class="line">                       &quot;digits_for_region_number&quot;:3,</div>
<div class="line">                       &quot;element_name_prefix&quot;:&quot;Element&quot;,</div>
<div class="line">                       &quot;digits_for_element_number&quot;:2} ]</div>
<div class="line">}</div>
</div><!-- fragment --><p> Under this configuration, the general file structure will look something like this: </p><div class="fragment"><div class="line">&lt;File-Level-Attributes&gt;</div>
<div class="line"> </div>
<div class="line">ATTRIBUTE: &quot;filelayout_params&quot; &lt;std::string&gt;</div>
<div class="line">ATTRIBUTE: &quot;filelayout_version&quot; &lt;uint32_3&gt;</div>
<div class="line"> </div>
<div class="line">GROUP &quot;TriggerRecord000001&quot;</div>
<div class="line">  </div>
<div class="line">  DATASET &quot;TriggerRecordHeader&quot;</div>
<div class="line">  </div>
<div class="line">  GROUP &quot;TPC&quot;</div>
<div class="line">    GROUP &quot;APA001&quot;</div>
<div class="line">      DATASET &quot;Link00&quot;</div>
<div class="line">      DATASET &quot;Link01&quot;</div>
<div class="line">    GROUP &quot;APA002&quot;</div>
<div class="line">      DATASET &quot;Link00&quot;</div>
<div class="line">      DATASET &quot;Link01&quot;</div>
<div class="line">    ...</div>
<div class="line">    </div>
<div class="line">  GROUP &quot;PDS&quot;</div>
<div class="line">    GROUP &quot;Region001&quot;</div>
<div class="line">      DATASET &quot;Element01&quot;</div>
<div class="line">      DATASET &quot;Element02&quot;</div>
<div class="line">    ...</div>
</div><!-- fragment --><p>The configuration information for the file layout are written as the attribute "filelayout_params" as JSON-formatted <code>std::string</code>. When a file is later opened to be read, the file layout parameters are automatically extracted from the attribute, and used to populate an <code>HDF5FileLayout</code> member of the <code>HDF5RawDataFile</code>. If no attributes exist, currently a set of defaults are used.</p>
<h2><a class="anchor" id="autotoc_md355"></a>
HDF5RawDataFile</h2>
<h3><a class="anchor" id="autotoc_md356"></a>
Writing</h3>
<p>The constructor for creating a new HDF5RawDataFile for writing looks like this: </p><div class="fragment"><div class="line">HDF5RawDataFile(std::string file_name,</div>
<div class="line">                daqdataformats::run_number_t run_number,</div>
<div class="line">                size_t file_index,</div>
<div class="line">                std::string application_name,</div>
<div class="line">                const hdf5filelayout::FileLayoutParams&amp; fl_params,</div>
<div class="line">                unsigned open_flags = HighFive::File::Create);</div>
</div><!-- fragment --><p> Upon opening the file &ndash; at object construction &ndash; the following attributes are written:</p><ul>
<li>"run_number" (<code>daqdataformats::run_number_t</code>)</li>
<li>"file_index" (<code>size_t</code>)</li>
<li>"creation_timestamp" (<code>std::string</code>, string translation of the number of milliseconds since epoch)</li>
<li>"application_name" (`std::string)</li>
</ul>
<p>alongside the file layout paramters as described above.</p>
<p>Upon closing the file &ndash; at object destruction &ndash; the following attributes are written:</p><ul>
<li>"recorded_size" (<code>size_t</code>, number of bytes written in datasets)</li>
<li>"closing_timestamp" (<code>std::string</code>, string translation of the number of milliseconds since epoch).</li>
</ul>
<p>The key interface for writing is the <code>HDF5RawDataFile::write(const daqdataformats::TriggerRecord&amp; tr)</code> member, which takes a TriggerRecord, creates a group in the HDF5 file for it, and then writes all of the underlying data (<code>TriggerRecordHeader</code> and <code>Fragment</code>s) to appropriate datasets and subgroups. All data are written as dimension 1 <code>char</code> arrays, with no change to the input <code>TriggerRecord</code> object.</p>
<h3><a class="anchor" id="autotoc_md357"></a>
Reading</h3>
<p>The constructor for creating a new HDF5RawDataFile for reading looks like this: </p><div class="fragment"><div class="line">HDF5RawDataFile(const std::string&amp; file_name);</div>
</div><!-- fragment --><p> There is no need to provide file layout parameters, as these are read from the existing file's attributes.</p>
<p><code>dunedaq</code> raw data files can be interrogated with any HDF5 reading utilities, and the data payloads for each dataset are simple dimension 1 byte (<code>char</code>) arrays. However, there are a number of useful accessors included in <code>HDF5RawDataFile</code> to aid in file interrogation, traversal, and data extraction:</p><ul>
<li><code>get_dataset_paths(std::string top_level_group_name = "")</code> returns all dataset paths (<code>std::vector&lt;std::string&gt;</code>) located beneath the specified group (defaulting to the whole file), including the full list of datasets in any subgroups of the specified group;</li>
<li><code>get_all_record_ids()</code> returns an <code>std::set</code> of record IDs (std::pair of record number and sequence number) located in the file;</li>
<li><code>get_trigger_record_header_dataset_paths(int max_trigger_records = -1)</code> returns all datset paths (up to a maximum number of desired trigger records, default is all) for <code>TriggerRecordHeader</code> objects;</li>
<li><code>get_all_fragment_dataset_paths(int max_trigger_records = -1)</code> returns all datset paths (up to a maximum number of desired trigger records, default is all) for <code>Fragment</code> objects of any system type;</li>
<li><code>get_trh_ptr(...)</code> members return a unique ptr to a <code>TriggerRecordHeader</code>, with inputs either being a full path as you may get from <code>get_trigger_record_header_dataset_paths()</code>, or with an input specifying the desired trigger number;</li>
<li><code>get_frag_ptr(...)</code> members return a unique ptr to a <code>Fragment</code>, with inputs either being a full path as you would get from <code>get_all_fragment_dataset_paths()</code>, or by specifying the trigger number and <code>GeoID</code> of the desired data (or also the elements of the <code>GeoID</code>).</li>
</ul>
<h2><a class="anchor" id="autotoc_md358"></a>
Version 2 (Latest) Notes</h2>
<p>This version is the initial version of <code><a class="el" href="namespacehdf5libs.html">hdf5libs</a></code> after significant restructuring of many of the existing utilities, including the introduction of the <code>HDF5FileLayout</code> class, and separation of the <code>HDF5RawDataFile</code> class from <code>dfmodules</code>.</p>
<p>Please see the notes in Version 0</p>
<h3><a class="anchor" id="autotoc_md359"></a>
Version 0 Notes</h3>
<p>This version refers to files that were written before the introduction of the <code>HDF5FileLayout</code> class. Currently, on reading a file, if there is no file layout attributes found in the file, it assumes a file layout parameter set as such: </p><div class="fragment"><div class="line">hdf5filelayout::FileLayoutParams flp;</div>
<div class="line">    flp.trigger_record_name_prefix = &quot;TriggerRecord&quot;;</div>
<div class="line">    flp.digits_for_trigger_number = 6;</div>
<div class="line">    flp.digits_for_sequence_number = 0;</div>
<div class="line">    flp.trigger_record_header_dataset_name = &quot;TriggerRecordHeader&quot;;</div>
<div class="line"> </div>
<div class="line">    hdf5filelayout::PathParams pp;</div>
<div class="line"> </div>
<div class="line">    pp.detector_group_type = &quot;TPC&quot;;</div>
<div class="line">    pp.detector_group_name = &quot;TPC&quot;;</div>
<div class="line">    pp.region_name_prefix = &quot;APA&quot;;</div>
<div class="line">    pp.digits_for_region_number = 3;</div>
<div class="line">    pp.element_name_prefix = &quot;Link&quot;;</div>
<div class="line">    pp.digits_for_element_number = 2;</div>
<div class="line">    flp.path_param_list.push_back(pp);</div>
<div class="line"> </div>
<div class="line">    pp.detector_group_type = &quot;PDS&quot;;</div>
<div class="line">    pp.detector_group_name = &quot;PDS&quot;;</div>
<div class="line">    pp.region_name_prefix = &quot;Region&quot;;</div>
<div class="line">    pp.digits_for_region_number = 3;</div>
<div class="line">    pp.element_name_prefix = &quot;Element&quot;;</div>
<div class="line">    pp.digits_for_element_number = 2;</div>
<div class="line">    flp.path_param_list.push_back(pp);</div>
<div class="line"> </div>
<div class="line">    pp.detector_group_type = &quot;NDLArTPC&quot;;</div>
<div class="line">    pp.detector_group_name = &quot;NDLArTPC&quot;;</div>
<div class="line">    pp.region_name_prefix = &quot;Region&quot;;</div>
<div class="line">    pp.digits_for_region_number = 3;</div>
<div class="line">    pp.element_name_prefix = &quot;Element&quot;;</div>
<div class="line">    pp.digits_for_element_number = 2;</div>
<div class="line">    flp.path_param_list.push_back(pp);</div>
<div class="line"> </div>
<div class="line">    pp.detector_group_type = &quot;Trigger&quot;;</div>
<div class="line">    pp.detector_group_name = &quot;Trigger&quot;;</div>
<div class="line">    pp.region_name_prefix = &quot;Region&quot;;</div>
<div class="line">    pp.digits_for_region_number = 3;</div>
<div class="line">    pp.element_name_prefix = &quot;Element&quot;;</div>
<div class="line">    pp.digits_for_element_number = 2;</div>
<div class="line">    flp.path_param_list.push_back(pp);</div>
<div class="line"> </div>
<div class="line">    pp.detector_group_type = &quot;TPC_TP&quot;;</div>
<div class="line">    pp.detector_group_name = &quot;TPC&quot;;</div>
<div class="line">    pp.region_name_prefix = &quot;APA&quot;;</div>
<div class="line">    pp.digits_for_region_number = 3;</div>
<div class="line">    pp.element_name_prefix = &quot;Link&quot;;</div>
<div class="line">    pp.digits_for_element_number = 2;</div>
<div class="line">    flp.path_param_list.push_back(pp);</div>
</div><!-- fragment --><p> Note that for all previously written files, <code>get_dataset_paths()</code> will work to retrieve a list of all proper dataset paths, and <code>get_trh_ptr(path_name)</code> and <code>get_frag_ptr(path_name)</code> will work for data access to <code>TriggerRecordHeader</code>s and <code>Fragment</code>s, respectively, where <code>path_name</code> is the full dataset path name. Other accessors to retrieving underlying data will throw an exception. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Oct 24 2024 for DUNE-DAQ by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
